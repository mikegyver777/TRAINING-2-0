<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elite Athlete Training System - Complete</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: #0a0a0a;
            color: white;
            padding: 20px;
            line-height: 1.6;
        }
        
        .container { max-width: 1600px; margin: 0 auto; }
        
        h1 {
            text-align: center;
            font-size: 42px;
            margin-bottom: 10px;
            background: linear-gradient(to right, #ff6b35, #00ff88, #00ccff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 16px;
        }
        
        /* CALENDAR */
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 20px;
            background: #1a1a1a;
            border-radius: 12px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .calendar-nav button {
            background: #333;
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 0 5px;
            font-weight: bold;
        }
        
        .calendar-nav button:hover { background: #444; }
        
        .month-title {
            font-size: 28px;
            color: #00ff88;
            font-weight: bold;
        }
        
        .analysis-btn {
            background: linear-gradient(135deg, #00ff88, #00ccff);
            color: #000;
            padding: 12px 24px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
        }
        
        .analysis-btn:hover {
            transform: translateY(-2px);
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            margin-bottom: 30px;
        }
        
        .calendar-day-header {
            text-align: center;
            padding: 12px;
            color: #888;
            font-weight: bold;
            font-size: 14px;
        }
        
        .calendar-day {
            background: #1a1a1a;
            border: 2px solid #333;
            border-radius: 8px;
            padding: 12px;
            min-height: 140px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        
        .calendar-day:hover { 
            border-color: #666; 
            transform: translateY(-2px); 
        }
        
        .calendar-day.other-month { opacity: 0.3; }
        
        .calendar-day.today {
            border-color: #00ff88;
            box-shadow: 0 0 25px rgba(0, 255, 136, 0.4);
            background: rgba(0, 255, 136, 0.05);
        }
        
        .calendar-day.has-workouts {
            border-color: #00ccff;
            background: rgba(0, 204, 255, 0.1);
        }
        
        .day-number {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 8px;
            color: #fff;
        }
        
        .day-workouts {
            font-size: 11px;
            color: #aaa;
        }
        
        .workout-badge {
            display: inline-block;
            padding: 3px 8px;
            margin: 2px;
            background: rgba(0, 255, 136, 0.2);
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
        }
        
        .cns-indicator {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 2px solid #000;
        }
        
        .cns-low { background: #00ff88; }
        .cns-moderate { background: #ffaa00; }
        .cns-high { background: #ff4444; }
        
        /* MODAL */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
        }
        
        .modal-content {
            max-width: 1400px;
            margin: 0 auto;
            background: #0a0a0a;
            border-radius: 12px;
            padding: 40px;
            border: 3px solid #00ff88;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .modal-title {
            font-size: 32px;
            color: #00ff88;
        }
        
        .close-btn {
            background: #ff4444;
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .close-btn:hover { background: #ff6666; }
        
        /* MODALITY CHECKBOXES */
        .modality-checkboxes {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
            margin-bottom: 30px;
            padding: 25px;
            background: #1a1a1a;
            border-radius: 12px;
        }
        
        .modality-checkbox {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 15px;
            background: #0a0a0a;
            border: 2px solid #333;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .modality-checkbox:hover {
            border-color: #666;
        }
        
        .modality-checkbox.checked {
            border-color: #00ff88;
            background: rgba(0, 255, 136, 0.1);
        }
        
        .modality-checkbox input[type="checkbox"] {
            width: 24px;
            height: 24px;
            cursor: pointer;
        }
        
        .modality-checkbox label {
            font-size: 15px;
            font-weight: bold;
            cursor: pointer;
            flex: 1;
        }
        
        /* MODALITY SECTIONS */
        .modality-section {
            background: #1a1a1a;
            border: 2px solid #00ccff;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 20px;
        }
        
        .modality-section h2 {
            color: #00ccff;
            margin-bottom: 20px;
            font-size: 24px;
        }
        
        /* FORMS */
        .exercise-block {
            background: #0a0a0a;
            border: 1px solid #333;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .exercise-name {
            width: 100%;
            padding: 12px;
            border: 2px solid #444;
            border-radius: 6px;
            background: #1a1a1a;
            color: white;
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 15px;
        }
        
        .exercise-name:focus {
            outline: none;
            border-color: #00ff88;
        }
        
        .muscle-select {
            width: 100%;
            padding: 12px;
            border: 2px solid #444;
            border-radius: 6px;
            background: #1a1a1a;
            color: white;
            font-size: 14px;
            margin-bottom: 15px;
        }
        
        .muscle-select:focus {
            outline: none;
            border-color: #00ff88;
        }
        
        .set-label {
            color: #888;
            font-size: 14px;
            margin: 15px 0 8px 0;
            font-weight: bold;
        }
        
        .set-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 40px;
            gap: 8px;
            margin-bottom: 8px;
        }
        
        .set-row input, .set-row select {
            padding: 10px;
            border: 2px solid #333;
            border-radius: 6px;
            background: #1a1a1a;
            color: white;
            font-size: 15px;
        }
        
        .set-row input:focus {
            outline: none;
            border-color: #00ff88;
        }
        
        .delete-btn {
            background: transparent;
            border: none;
            color: #ff4444;
            font-size: 20px;
            cursor: pointer;
            padding: 0;
        }
        
        .delete-btn:hover {
            color: #ff6666;
        }
        
        .add-btn {
            background: #2a2a2a;
            border: 2px dashed #444;
            color: #888;
            padding: 12px;
            border-radius: 6px;
            cursor: pointer;
            width: 100%;
            font-size: 14px;
            font-weight: bold;
            margin-top: 10px;
        }
        
        .add-btn:hover {
            border-color: #00ff88;
            color: #00ff88;
        }
        
        .add-exercise-btn {
            background: linear-gradient(135deg, #333, #1a1a1a);
            border: 2px solid #00ff88;
            color: #00ff88;
            padding: 15px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            margin-top: 20px;
        }
        
        .add-exercise-btn:hover {
            background: #0a2a1a;
        }
        
        .question {
            margin-bottom: 15px;
        }
        
        .question label {
            display: block;
            margin-bottom: 8px;
            color: #aaa;
            font-weight: bold;
        }
        
        select, input[type="number"], textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #333;
            border-radius: 6px;
            background: #0a0a0a;
            color: white;
            font-size: 15px;
        }
        
        select:focus, input:focus, textarea:focus {
            outline: none;
            border-color: #00ff88;
        }
        
        .upload-zone {
            border: 2px dashed #333;
            padding: 30px;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin: 15px 0;
        }
        
        .upload-zone:hover {
            border-color: #00ff88;
        }
        
        .upload-zone.has-file {
            border-color: #00ff88;
            border-style: solid;
            background: rgba(0, 255, 136, 0.05);
        }
        
        .hr-preview {
            max-width: 100%;
            max-height: 300px;
            border-radius: 8px;
            margin-top: 15px;
        }
        
        .save-day-btn {
            background: linear-gradient(135deg, #00ff88, #00ccff);
            border: none;
            color: #000;
            padding: 20px;
            border-radius: 10px;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            margin-top: 30px;
        }
        
        .save-day-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 255, 136, 0.3);
        }
        
        .rpe-btn {
            background: #444;
            border: 2px solid #666;
            color: #aaa;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin-bottom: 20px;
            font-weight: bold;
        }
        
        .rpe-btn:hover {
            border-color: #00ff88;
            color: #00ff88;
        }
        
        /* RPE MODAL */
        .rpe-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 1001;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .rpe-content {
            max-width: 600px;
            background: #1a1a1a;
            border-radius: 12px;
            padding: 30px;
            border: 2px solid #00ff88;
        }
        
        .rpe-row {
            display: grid;
            grid-template-columns: 80px 120px 1fr;
            gap: 15px;
            padding: 12px;
            margin-bottom: 8px;
            background: #0a0a0a;
            border-radius: 6px;
            align-items: center;
        }
        
        .rpe-number {
            font-size: 24px;
            font-weight: bold;
            color: #00ff88;
        }
        
        .rpe-rir {
            font-size: 14px;
            color: #00ccff;
            font-weight: bold;
        }
        
        .rpe-desc {
            font-size: 14px;
            color: #aaa;
        }
        
        /* METRICS DISPLAY */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .metric-card {
            background: rgba(0, 0, 0, 0.5);
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #00ccff;
        }
        
        .metric-value {
            font-size: 32px;
            font-weight: bold;
            color: #00ff88;
        }
        
        .metric-label {
            font-size: 12px;
            color: #888;
            margin-top: 5px;
        }
        
        .warning-box {
            background: rgba(255, 68, 68, 0.2);
            border: 2px solid #ff4444;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .success-box {
            background: rgba(0, 255, 136, 0.2);
            border: 2px solid #00ff88;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .info-box {
            background: rgba(0, 204, 255, 0.2);
            border: 2px solid #00ccff;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .hidden { display: none; }
        
        @media (max-width: 768px) {
            h1 { font-size: 28px; }
            .calendar-grid { gap: 5px; }
            .calendar-day { min-height: 100px; padding: 8px; }
            .day-number { font-size: 14px; }
            .modality-checkboxes { grid-template-columns: 1fr; }
            .set-row { grid-template-columns: 1fr 1fr 40px; }
            .modal-content { padding: 20px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üèÜ ELITE ATHLETE TRAINING SYSTEM</h1>
        <p class="subtitle">Full Periodization ‚Ä¢ Load Management ‚Ä¢ Injury Prevention ‚Ä¢ Performance Optimization</p>
        
        <div class="calendar-header">
            <div class="calendar-nav">
                <button onclick="previousMonth()">‚Äπ Prev</button>
                <button onclick="goToToday()">Today</button>
                <button onclick="nextMonth()">Next ‚Ä∫</button>
            </div>
            <div class="month-title" id="month-title">NOVEMBER 2025</div>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="analysis-btn" id="profile-btn" onclick="showProfile()" style="background: linear-gradient(135deg, #ff6b35, #00ff88);">
                    üë§ PROFILE
                </button>
                <button class="analysis-btn" onclick="showWeeklyAnalysis()">
                    üìä ANALYSIS
                </button>
                <button class="analysis-btn" onclick="showHelp()" style="background: #333;">
                    ‚ùì HELP
                </button>
            </div>
        </div>
        
        <div id="profile-summary" style="background: #1a1a1a; border-radius: 8px; padding: 15px; margin-bottom: 20px; border: 1px solid #333; display: none;">
            <!-- Profile summary will appear here -->
        </div>
        
        <div style="background: #1a1a1a; border-radius: 8px; padding: 15px; margin-bottom: 20px; border: 1px solid #333;">
            <p style="color: #888; font-size: 13px; margin: 0;">
                <strong style="color: #00ff88;">Quick Tips:</strong> 
                Click empty day to log workout ‚Ä¢ 
                Click completed day to view details ‚Ä¢ 
                Right-click or Ctrl+Click for detailed view ‚Ä¢ 
                Type exercise name for auto-progression suggestions
            </p>
        </div>
        
        <div class="calendar-grid" id="calendar-grid"></div>
        
        <div id="day-modal" class="hidden"></div>
        <div id="weekly-modal" class="hidden"></div>
        <div id="rpe-modal" class="hidden"></div>
    </div>
    
    <script>
        // ========== STATE ==========
        let currentDate = new Date();
        let trainingData = {}; // { 'YYYY-MM-DD': { modalities: {...}, totalCNS, totalVolume, tss, hrData } }
        let historicalTSS = []; // Last 28 days for A:C ratio
        let exerciseCounters = {};
        let setCounters = {};
        let exerciseHistory = {}; // { 'Bench Press': [{date, sets: [{weight, reps, rpe}]}] }
        let userProfile = null; // User profile for personalized calculations
        let dailyReadiness = {}; // { 'YYYY-MM-DD': { sleep, sleepQuality, rhr, soreness, stress, motivation, energy, score } }
        let trainingBlock = null; // Current periodization block
        let baselineRHR = null; // Baseline resting heart rate
        
        // Block Periodization Structure
        const BLOCK_TYPES = {
            VOLUME: 'volume',
            STRENGTH: 'strength', 
            INTENSITY: 'intensity',
            DELOAD: 'deload'
        };
        
        const BLOCK_CONFIGS = {
            volume: {
                name: 'VOLUME',
                duration: 3,
                focus: 'Muscle Growth & Work Capacity',
                strengthReps: '8-12',
                strengthSets: '3-4',
                strengthRPE: '7-8',
                conditioning: 'Zone 2 emphasis (80% volume)',
                plyoIntensity: 'Lower intensity, higher volume',
                description: 'Building muscle mass and aerobic base'
            },
            strength: {
                name: 'STRENGTH',
                duration: 3,
                focus: 'Strength Foundation',
                strengthReps: '4-6',
                strengthSets: '4-5',
                strengthRPE: '8-9',
                conditioning: 'Mix Lactate + VO2max',
                plyoIntensity: 'Moderate intensity, moderate volume',
                description: 'Building strength base for future intensity'
            },
            intensity: {
                name: 'INTENSITY/PEAK',
                duration: 3,
                focus: 'Max Strength & Power Expression',
                strengthReps: 'Pyramid to 1-3 RM',
                strengthSets: '5-7 (including build-ups)',
                strengthRPE: '9-10 on top sets',
                conditioning: 'Alactic power focus',
                plyoIntensity: 'Max intensity, lower volume',
                description: 'Your pyramid style - express max strength!'
            },
            deload: {
                name: 'DELOAD',
                duration: 1,
                focus: 'Recovery & Adaptation',
                strengthReps: 'Reduce 50%',
                strengthSets: 'Reduce 40-50%',
                strengthRPE: '6-7 (technical work)',
                conditioning: 'Zone 1-2 only (easy)',
                plyoIntensity: 'Skip or very light',
                description: 'Let your body recover and grow stronger'
            }
        };
        
        // Load/Save
        function loadData() {
            const saved = localStorage.getItem('eliteTrainingData');
            if (saved) trainingData = JSON.parse(saved);
            
            const savedTSS = localStorage.getItem('historicalTSS');
            if (savedTSS) historicalTSS = JSON.parse(savedTSS);
            
            const savedHistory = localStorage.getItem('exerciseHistory');
            if (savedHistory) exerciseHistory = JSON.parse(savedHistory);
            
            const savedProfile = localStorage.getItem('userProfile');
            if (savedProfile) {
                userProfile = JSON.parse(savedProfile);
            }
            
            const savedReadiness = localStorage.getItem('dailyReadiness');
            if (savedReadiness) {
                dailyReadiness = JSON.parse(savedReadiness);
            }
            
            const savedBlock = localStorage.getItem('trainingBlock');
            if (savedBlock) {
                trainingBlock = JSON.parse(savedBlock);
            }
            
            const savedBaselineRHR = localStorage.getItem('baselineRHR');
            if (savedBaselineRHR) {
                baselineRHR = parseFloat(savedBaselineRHR);
            }
        }
        
        function saveData() {
            localStorage.setItem('eliteTrainingData', JSON.stringify(trainingData));
            localStorage.setItem('historicalTSS', JSON.stringify(historicalTSS));
            localStorage.setItem('exerciseHistory', JSON.stringify(exerciseHistory));
            if (userProfile) {
                localStorage.setItem('userProfile', JSON.stringify(userProfile));
            }
            if (Object.keys(dailyReadiness).length > 0) {
                localStorage.setItem('dailyReadiness', JSON.stringify(dailyReadiness));
            }
            if (trainingBlock) {
                localStorage.setItem('trainingBlock', JSON.stringify(trainingBlock));
            }
            if (baselineRHR) {
                localStorage.setItem('baselineRHR', baselineRHR.toString());
            }
        }
        
        // ========== PROFILE CALCULATIONS ==========
        
        // Get CNS multiplier based on training age
        function getCNSMultiplier() {
            if (!userProfile) return 1.0;
            
            const years = userProfile.trainingAge;
            if (years < 2) return 1.2; // Beginner - everything harder
            if (years < 5) return 1.0; // Intermediate - standard
            if (years < 10) return 0.85; // Advanced - adapted
            return 0.75; // Elite - very adapted
        }
        
        // Get CNS thresholds personalized
        function getCNSThresholds() {
            if (!userProfile) return { low: 60, moderate: 75, high: 100 };
            
            const years = userProfile.trainingAge;
            if (years < 2) return { low: 55, moderate: 65, high: 100 }; // Beginner
            if (years < 5) return { low: 60, moderate: 75, high: 100 }; // Intermediate
            if (years < 10) return { low: 70, moderate: 85, high: 100 }; // Advanced
            return { low: 75, moderate: 90, high: 100 }; // Elite
        }
        
        // Get A:C ratio threshold
        function getACThreshold() {
            if (!userProfile) return 1.3;
            
            const years = userProfile.trainingAge;
            if (years < 2) return 1.2; // Beginner - lower tolerance
            if (years < 5) return 1.3; // Intermediate - standard
            if (years < 10) return 1.5; // Advanced - higher tolerance
            return 1.7; // Elite - very high tolerance
        }
        
        // Get recovery multiplier
        function getRecoveryMultiplier() {
            if (!userProfile) return 1.0;
            
            let multiplier = 1.0;
            
            // Age adjustment
            const age = userProfile.age;
            if (age >= 40) multiplier *= 1.4;
            else if (age >= 30) multiplier *= 1.2;
            
            // Training age adjustment
            const years = userProfile.trainingAge;
            if (years < 2) multiplier *= 1.5; // Beginner needs more recovery
            else if (years >= 10) multiplier *= 0.8; // Elite recovers faster
            
            // Sex adjustment (females recover slower per session but accumulate less fatigue)
            if (userProfile.sex === 'female') multiplier *= 1.1;
            
            return multiplier;
        }
        
        // Calculate HR zones
        function getHRZones() {
            if (!userProfile || !userProfile.maxHR) {
                // Generic fallback
                return {
                    z5: { min: 171, max: 190 },
                    z4: { min: 152, max: 170 },
                    z3: { min: 133, max: 151 },
                    z2: { min: 114, max: 132 },
                    z1: { min: 0, max: 113 }
                };
            }
            
            const max = userProfile.maxHR;
            return {
                z5: { min: Math.round(max * 0.9), max: max },
                z4: { min: Math.round(max * 0.8), max: Math.round(max * 0.9) - 1 },
                z3: { min: Math.round(max * 0.7), max: Math.round(max * 0.8) - 1 },
                z2: { min: Math.round(max * 0.6), max: Math.round(max * 0.7) - 1 },
                z1: { min: 0, max: Math.round(max * 0.6) - 1 }
            };
        }
        
        // Calculate relative strength (weight lifted / bodyweight)
        function getRelativeStrength(weight) {
            if (!userProfile || !userProfile.bodyweight) return null;
            return (weight / userProfile.bodyweight).toFixed(2);
        }
        
        // Fatigue accumulation multiplier (females accumulate less)
        function getFatigueMultiplier() {
            if (!userProfile) return 1.0;
            return userProfile.sex === 'female' ? 0.9 : 1.0;
        }
        
        // Get training level label
        function getTrainingLevel() {
            if (!userProfile) return 'Intermediate';
            const years = userProfile.trainingAge;
            if (years < 2) return 'Beginner';
            if (years < 5) return 'Intermediate';
            if (years < 10) return 'Advanced';
            return 'Elite';
        }
        
        // Update exercise history
        function updateExerciseHistory(dateStr, exercises) {
            exercises.forEach(ex => {
                if (!exerciseHistory[ex.name]) {
                    exerciseHistory[ex.name] = [];
                }
                exerciseHistory[ex.name].push({
                    date: dateStr,
                    muscleGroup: ex.muscleGroup,
                    sets: ex.workingSets
                });
                // Keep last 20 sessions per exercise
                if (exerciseHistory[ex.name].length > 20) {
                    exerciseHistory[ex.name].shift();
                }
            });
        }
        
        // Get last workout for exercise
        function getLastWorkout(exerciseName) {
            if (!exerciseHistory[exerciseName] || exerciseHistory[exerciseName].length === 0) {
                return null;
            }
            return exerciseHistory[exerciseName][exerciseHistory[exerciseName].length - 1];
        }
        
        // Suggest progression
        function suggestProgression(exerciseName, lastSets) {
            if (!lastSets || lastSets.length === 0) return null;
            
            // Get best set (highest weight √ó reps)
            const bestSet = lastSets.reduce((best, set) => {
                const volume = set.weight * set.reps;
                const bestVolume = best.weight * best.reps;
                return volume > bestVolume ? set : best;
            });
            
            const suggestions = [];
            
            // Strategy 1: Same weight, more reps
            if (bestSet.reps < 12) {
                suggestions.push({
                    type: 'volume',
                    weight: bestSet.weight,
                    reps: bestSet.reps + 1,
                    desc: 'Add 1 rep (volume progression)'
                });
            }
            
            // Strategy 2: More weight, same reps
            const increment = bestSet.weight >= 200 ? 5 : 2.5;
            suggestions.push({
                type: 'intensity',
                weight: bestSet.weight + increment,
                reps: bestSet.reps,
                desc: `Add ${increment} lbs (intensity progression)`
            });
            
            // Strategy 3: Deload if RPE was too high
            if (bestSet.rpe >= 9.5) {
                suggestions.push({
                    type: 'deload',
                    weight: Math.round(bestSet.weight * 0.9),
                    reps: bestSet.reps,
                    desc: 'Deload 10% (RPE too high last time)'
                });
            }
            
            return { lastBest: bestSet, suggestions };
        }
        
        // ========== CALENDAR ==========
        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            const monthNames = ['JANUARY', 'FEBRUARY', 'MARCH', 'APRIL', 'MAY', 'JUNE',
                               'JULY', 'AUGUST', 'SEPTEMBER', 'OCTOBER', 'NOVEMBER', 'DECEMBER'];
            document.getElementById('month-title').textContent = `${monthNames[month]} ${year}`;
            
            const grid = document.getElementById('calendar-grid');
            grid.innerHTML = '';
            
            ['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'].forEach(day => {
                const header = document.createElement('div');
                header.className = 'calendar-day-header';
                header.textContent = day;
                grid.appendChild(header);
            });
            
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const daysInPrevMonth = new Date(year, month, 0).getDate();
            
            const today = formatDate(new Date());
            
            for (let i = firstDay - 1; i >= 0; i--) {
                const day = daysInPrevMonth - i;
                const date = new Date(year, month - 1, day);
                createDayCell(grid, date, true, today);
            }
            
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                createDayCell(grid, date, false, today);
            }
            
            const totalCells = firstDay + daysInMonth;
            const remainingCells = totalCells <= 35 ? 35 - totalCells : 42 - totalCells;
            for (let day = 1; day <= remainingCells; day++) {
                const date = new Date(year, month + 1, day);
                createDayCell(grid, date, true, today);
            }
        }
        
        function createDayCell(grid, date, otherMonth, today) {
            const cell = document.createElement('div');
            cell.className = 'calendar-day';
            if (otherMonth) cell.classList.add('other-month');
            
            const dateStr = formatDate(date);
            
            if (dateStr === today) cell.classList.add('today');
            
            const dayData = trainingData[dateStr];
            
            const dayNum = document.createElement('div');
            dayNum.className = 'day-number';
            dayNum.textContent = date.getDate();
            cell.appendChild(dayNum);
            
            if (dayData && dayData.modalities) {
                cell.classList.add('has-workouts');
                
                const workouts = document.createElement('div');
                workouts.className = 'day-workouts';
                
                Object.keys(dayData.modalities).forEach(type => {
                    if (dayData.modalities[type].completed) {
                        const badge = document.createElement('span');
                        badge.className = 'workout-badge';
                        badge.textContent = type.toUpperCase();
                        workouts.appendChild(badge);
                    }
                });
                
                cell.appendChild(workouts);
                
                const totalCNS = dayData.totalCNS || 0;
                const indicator = document.createElement('div');
                indicator.className = 'cns-indicator';
                const thresholds = getCNSThresholds();
                if (totalCNS < thresholds.low) indicator.classList.add('cns-low');
                else if (totalCNS < thresholds.moderate) indicator.classList.add('cns-moderate');
                else indicator.classList.add('cns-high');
                cell.appendChild(indicator);
                
                // Historical view (right-click or ctrl+click)
                cell.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    viewHistoricalDay(dateStr, date, dayData);
                });
                
                // Regular click opens edit
                cell.onclick = (e) => {
                    if (e.ctrlKey || e.metaKey) {
                        viewHistoricalDay(dateStr, date, dayData);
                    } else {
                        openDay(dateStr, date);
                    }
                };
            } else {
                // No workout yet - open for new entry
                cell.onclick = () => openDay(dateStr, date);
            }
            
            grid.appendChild(cell);
        }
        
        // View completed workout details
        function viewHistoricalDay(dateStr, date, dayData) {
            let html = `
                <div class="modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">üìã ${date.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</div>
                            <button class="close-btn" onclick="closeModal()">‚úï Close</button>
                        </div>
                        
                        <div class="success-box">
                            <h3 style="color: #00ff88;">TRAINING COMPLETED</h3>
                            <p><strong>Modalities:</strong> ${Object.keys(dayData.modalities).map(t => t.toUpperCase()).join(', ')}</p>
                        </div>
                        
                        <div class="metrics-grid">
                            <div class="metric-card">
                                <div class="metric-value">${dayData.totalCNS}</div>
                                <div class="metric-label">Total CNS Load</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value">${dayData.totalVolume.toLocaleString()}</div>
                                <div class="metric-label">Volume (lbs)</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value">${dayData.tss}</div>
                                <div class="metric-label">Training Stress Score</div>
                            </div>
                        </div>
            `;
            
            // Show details for each modality
            Object.keys(dayData.modalities).forEach(type => {
                const mod = dayData.modalities[type];
                html += `<div class="modality-section">`;
                html += `<h2>${type.toUpperCase()}</h2>`;
                
                if (type === 'chest' || type === 'back' || type === 'legs') {
                    if (mod.exercises) {
                        mod.exercises.forEach(ex => {
                            html += `
                                <div style="background: #0a0a0a; padding: 15px; border-radius: 8px; margin: 10px 0;">
                                    <h3 style="color: #00ccff;">${ex.name}</h3>
                                    <p style="color: #888;">Muscle: ${ex.muscleGroup}</p>
                                    <div style="margin-top: 10px;">
                            `;
                            ex.workingSets.forEach((set, i) => {
                                html += `<p style="color: #aaa;">Set ${i+1}: ${set.weight} lbs √ó ${set.reps} reps @ RPE ${set.rpe || 'N/A'}</p>`;
                            });
                            html += `</div></div>`;
                        });
                    }
                    html += `<p style="color: #aaa; margin-top: 10px;">Feeling: ${mod.feeling} | Sleep: ${mod.sleep}hr | CNS: ${mod.cnsScore}</p>`;
                    
                } else if (type === 'bike') {
                    if (mod.intervals) {
                        html += `<p style="color: #00ccff; margin-bottom: 10px;">Protocol: ${mod.protocol}</p>`;
                        mod.intervals.forEach((int, i) => {
                            html += `<p style="color: #aaa;">Int ${i+1}: ${int.rpm} RPM √ó ${int.duration}s (rest ${int.rest}s) @ RPE ${int.rpe || 'N/A'}</p>`;
                        });
                        html += `<p style="color: #888; margin-top: 10px;">Peak RPM: ${mod.peakRPM} | Avg RPM: ${mod.avgRPM}</p>`;
                    }
                    html += `<p style="color: #aaa; margin-top: 10px;">Feeling: ${mod.feeling} | CNS: ${mod.cnsScore}</p>`;
                    
                } else if (type === 'track') {
                    if (mod.exercises && mod.exercises.length > 0) {
                        html += `<p style="color: #00ccff; margin-bottom: 10px;">Exercises: ${mod.exerciseCount || mod.exercises.length} | Total Contacts: ${mod.totalContacts || 0}</p>`;
                        mod.exercises.forEach((ex, i) => {
                            html += `
                                <div style="background: #0a0a0a; padding: 12px; border-radius: 6px; margin: 8px 0;">
                                    <h4 style="color: #00ff88; margin: 0 0 8px 0;">${i+1}. ${ex.name}</h4>
                            `;
                            
                            if (ex.category === 'running') {
                                html += `
                                    <p style="color: #aaa; margin: 3px 0;">Distance: ${ex.distance} ${ex.distanceUnit}</p>
                                    <p style="color: #aaa; margin: 3px 0;">Time: ${ex.time} min | Pace: ${ex.pace} min/${ex.distanceUnit === 'miles' ? 'mi' : 'km'}</p>
                                    <p style="color: #aaa; margin: 3px 0;">RPE: ${ex.rpe}</p>
                                `;
                            }
                            else if (ex.category === 'sprint' || ex.category === 'sprint-loaded') {
                                html += `
                                    ${ex.weight ? `<p style="color: #aaa; margin: 3px 0;">Weight: ${ex.weight} lbs (towed)</p>` : ''}
                                    <p style="color: #aaa; margin: 3px 0;">Distance: ${ex.distance} ${ex.distanceUnit} √ó ${ex.reps} reps</p>
                                    ${ex.rest ? `<p style="color: #aaa; margin: 3px 0;">Rest: ${ex.rest}s</p>` : ''}
                                    <p style="color: #aaa; margin: 3px 0;">RPE: ${ex.rpe}</p>
                                `;
                            }
                            else if (ex.category === 'plyo') {
                                html += `
                                    <p style="color: #aaa; margin: 3px 0;">Distance: ${ex.distance} ${ex.distanceUnit}</p>
                                `;
                                
                                if (ex.leftJumps !== undefined && ex.rightJumps !== undefined) {
                                    // Single leg exercise
                                    html += `
                                        <p style="color: #aaa; margin: 3px 0;">Left leg: ${ex.leftJumps} jumps | Right leg: ${ex.rightJumps} jumps</p>
                                        <p style="color: #aaa; margin: 3px 0;">Total contacts: ${ex.contacts}</p>
                                    `;
                                } else {
                                    // Regular plyo exercise
                                    html += `<p style="color: #aaa; margin: 3px 0;">Contacts: ${ex.contacts}</p>`;
                                }
                                
                                html += `<p style="color: #aaa; margin: 3px 0;">RPE: ${ex.rpe}</p>`;
                            }
                            else if (ex.category === 'loaded') {
                                html += `
                                    ${ex.weight ? `<p style="color: #aaa; margin: 3px 0;">Weight: ${ex.weight} lbs</p>` : ''}
                                    <p style="color: #aaa; margin: 3px 0;">Distance: ${ex.distance} ${ex.distanceUnit}</p>
                                    ${ex.reps ? `<p style="color: #aaa; margin: 3px 0;">Reps: ${ex.reps}</p>` : ''}
                                    ${ex.time ? `<p style="color: #aaa; margin: 3px 0;">Time: ${ex.time}s</p>` : ''}
                                    <p style="color: #aaa; margin: 3px 0;">RPE: ${ex.rpe}</p>
                                `;
                            }
                            
                            html += `</div>`;
                        });
                    }
                    html += `<p style="color: #aaa; margin-top: 10px;">Feeling: ${mod.feeling} | Ground: ${mod.ground} | Achilles: ${mod.achilles}</p>`;
                    html += `<p style="color: #aaa;">Sleep: ${mod.sleep}hr | CNS: ${mod.cnsScore}</p>`;
                    
                    
                } else if (type === 'bjj') {
                    html += `
                        <p style="color: #aaa;">Time: ${mod.time} min | Intensity: ${mod.intensity}</p>
                        <p style="color: #aaa;">Weight loss: ${mod.weightLoss} lbs</p>
                        <p style="color: #aaa; margin-top: 10px;">CNS: ${mod.cnsScore}</p>
                    `;
                    
                } else if (type === 'walking') {
                    html += `
                        <p style="color: #aaa;">Duration: ${mod.duration} min | Distance: ${mod.distance} miles</p>
                        <p style="color: #aaa;">Pace: ${mod.pace} min/mile | Terrain: ${mod.terrain}</p>
                        <p style="color: #aaa; margin-top: 10px;">CNS: ${mod.cnsScore}</p>
                    `;
                }
                
                // HR Analysis if available
                if (mod.hrAnalysis) {
                    const hr = mod.hrAnalysis;
                    html += `
                        <div style="background: rgba(0, 255, 136, 0.1); padding: 12px; border-radius: 6px; margin-top: 10px; border: 1px solid #00ff88;">
                            <p style="color: #00ff88; font-weight: bold;">‚ù§Ô∏è HR ANALYSIS:</p>
                            <p style="color: #aaa;">Peak: ${hr.peakHR} bpm | Avg: ${hr.avgHR} bpm</p>
                            <p style="color: #aaa;">Z5: ${hr.timeInZone5}min | Z4: ${hr.timeInZone4}min | Z3: ${hr.timeInZone3}min | Z2: ${hr.timeInZone2}min</p>
                            <p style="color: #aaa;">Recovery: ${hr.recovery}</p>
                            ${hr.notes ? `<p style="color: #888; font-size: 13px; margin-top: 5px;">${hr.notes}</p>` : ''}
                        </div>
                    `;
                }
                
                html += `</div>`;
            });
            
            // Qualities
            if (dayData.qualities && Object.keys(dayData.qualities).length > 0) {
                html += `
                    <div class="info-box">
                        <h3 style="color: #00ccff;">TRAINING QUALITIES</h3>
                        ${Object.keys(dayData.qualities).filter(q => dayData.qualities[q] >= 15).map(q => 
                            `<p><strong>${q.charAt(0).toUpperCase() + q.slice(1)}:</strong> ${dayData.qualities[q]}%</p>`
                        ).join('')}
                    </div>
                `;
            }
            
            // Interference warnings
            if (dayData.interference && dayData.interference.length > 0) {
                html += `<div class="warning-box"><h3>‚ö†Ô∏è INTERFERENCE DETECTED</h3>`;
                dayData.interference.forEach(issue => {
                    html += `
                        <div style="margin-bottom: 15px;">
                            <p><strong>${issue.message}</strong></p>
                            <p style="color: #ff6666;">Impact: ${issue.impact}</p>
                            <p style="color: #00ff88;">Fix: ${issue.fix}</p>
                        </div>
                    `;
                });
                html += `</div>`;
            }
            
            html += `
                        <button onclick="openDay('${dateStr}', new Date('${date}'))" style="background: #00ccff; color: #000; padding: 15px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; width: 100%; margin-top: 20px;">
                            ‚úèÔ∏è EDIT THIS WORKOUT
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('day-modal').innerHTML = html;
            document.getElementById('day-modal').classList.remove('hidden');
        }
        
        function formatDate(date) {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        }
        
        function previousMonth() {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
        }
        
        function nextMonth() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
        }
        
        function goToToday() {
            currentDate = new Date();
            renderCalendar();
        }
        
        // ========== DAILY READINESS SYSTEM ==========
        
        function checkAndShowReadiness(dateStr, date) {
            const today = formatDate(new Date());
            
            // Only check readiness for today or future dates
            if (dateStr < today) {
                // Past date - skip readiness, just open
                openDayDirect(dateStr, date);
                return;
            }
            
            // Check if readiness already logged today
            if (dailyReadiness[dateStr]) {
                // Already logged - go straight to training
                openDayDirect(dateStr, date);
                return;
            }
            
            // Show readiness modal
            showDailyReadiness(dateStr, date);
        }
        
        function showDailyReadiness(dateStr, date) {
            // Calculate baseline if not set
            if (!baselineRHR && Object.keys(dailyReadiness).length >= 7) {
                const rhrValues = Object.values(dailyReadiness)
                    .filter(r => r.rhr && r.rhr > 0)
                    .map(r => r.rhr);
                if (rhrValues.length >= 7) {
                    baselineRHR = Math.round(rhrValues.reduce((a, b) => a + b, 0) / rhrValues.length);
                    saveData();
                }
            }
            
            // Format date properly to avoid timezone issues
            const [year, month, day] = dateStr.split('-');
            const displayDate = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
            const formattedDate = displayDate.toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            const html = `
                <div class="modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">üåÖ DAILY READINESS CHECK</div>
                            <button class="close-btn" onclick="closeModal()">‚úï Close</button>
                        </div>
                        
                        <div class="info-box">
                            <h3 style="color: #00ccff;">Good ${getTimeOfDay()}, Mike!</h3>
                            <p style="color: #aaa;">${formattedDate}</p>
                            <p style="color: #888; font-size: 13px; margin-top: 10px;">Quick check-in to optimize today's training...</p>
                        </div>
                        
                        <div style="display: grid; gap: 20px; margin-top: 30px;">
                            
                            <div class="question">
                                <label>Sleep Duration (hours):</label>
                                <input type="number" id="readiness-sleep" step="0.5" min="0" max="12" placeholder="7.5">
                            </div>
                            
                            <div class="question">
                                <label>Sleep Quality (1-10):</label>
                                <input type="range" id="readiness-sleep-quality" min="1" max="10" value="7" oninput="document.getElementById('sleep-quality-val').textContent = this.value">
                                <div style="display: flex; justify-content: space-between; color: #666; font-size: 12px; margin-top: 5px;">
                                    <span>1 (Terrible)</span>
                                    <span id="sleep-quality-val" style="color: #00ff88; font-weight: bold; font-size: 16px;">7</span>
                                    <span>10 (Perfect)</span>
                                </div>
                            </div>
                            
                            <div class="question">
                                <label>Resting Heart Rate (bpm) ${baselineRHR ? `[Baseline: ${baselineRHR}]` : '[Establishing baseline...]'}:</label>
                                <input type="number" id="readiness-rhr" min="40" max="120" placeholder="62">
                                <p style="color: #666; font-size: 12px; margin-top: 5px;">Measure immediately upon waking, before getting out of bed</p>
                            </div>
                            
                            <div class="question">
                                <label>Muscle Soreness (1-10):</label>
                                <input type="range" id="readiness-soreness" min="1" max="10" value="3" oninput="document.getElementById('soreness-val').textContent = this.value">
                                <div style="display: flex; justify-content: space-between; color: #666; font-size: 12px; margin-top: 5px;">
                                    <span>1 (None)</span>
                                    <span id="soreness-val" style="color: #00ff88; font-weight: bold; font-size: 16px;">3</span>
                                    <span>10 (Severe)</span>
                                </div>
                            </div>
                            
                            <div class="question">
                                <label>Stress Level (1-10):</label>
                                <input type="range" id="readiness-stress" min="1" max="10" value="3" oninput="document.getElementById('stress-val').textContent = this.value">
                                <div style="display: flex; justify-content: space-between; color: #666; font-size: 12px; margin-top: 5px;">
                                    <span>1 (Calm)</span>
                                    <span id="stress-val" style="color: #00ff88; font-weight: bold; font-size: 16px;">3</span>
                                    <span>10 (Very Stressed)</span>
                                </div>
                            </div>
                            
                            <div class="question">
                                <label>Motivation (1-10):</label>
                                <input type="range" id="readiness-motivation" min="1" max="10" value="8" oninput="document.getElementById('motivation-val').textContent = this.value">
                                <div style="display: flex; justify-content: space-between; color: #666; font-size: 12px; margin-top: 5px;">
                                    <span>1 (Zero)</span>
                                    <span id="motivation-val" style="color: #00ff88; font-weight: bold; font-size: 16px;">8</span>
                                    <span>10 (Fired Up)</span>
                                </div>
                            </div>
                            
                            <div class="question">
                                <label>Energy Level (1-10):</label>
                                <input type="range" id="readiness-energy" min="1" max="10" value="7" oninput="document.getElementById('energy-val').textContent = this.value">
                                <div style="display: flex; justify-content: space-between; color: #666; font-size: 12px; margin-top: 5px;">
                                    <span>1 (Exhausted)</span>
                                    <span id="energy-val" style="color: #00ff88; font-weight: bold; font-size: 16px;">7</span>
                                    <span>10 (Explosive)</span>
                                </div>
                            </div>
                            
                        </div>
                        
                        <button onclick="calculateAndSaveReadiness('${dateStr}', '${date}')" style="background: linear-gradient(135deg, #00ff88, #00ccff); border: none; color: #000; padding: 20px; border-radius: 10px; font-size: 18px; font-weight: bold; cursor: pointer; width: 100%; margin-top: 30px;">
                            ‚úì CALCULATE READINESS & CONTINUE
                        </button>
                        
                        <button onclick="skipReadiness('${dateStr}', new Date('${date}'))" style="background: #333; border: 1px solid #666; color: #aaa; padding: 12px; border-radius: 8px; font-size: 14px; cursor: pointer; width: 100%; margin-top: 10px;">
                            Skip for now (not recommended)
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('day-modal').innerHTML = html;
            document.getElementById('day-modal').classList.remove('hidden');
        }
        
        function getTimeOfDay() {
            const hour = new Date().getHours();
            if (hour < 12) return 'Morning';
            if (hour < 17) return 'Afternoon';
            return 'Evening';
        }
        
        function calculateAndSaveReadiness(dateStr, dateString) {
            const sleep = parseFloat(document.getElementById('readiness-sleep').value);
            const sleepQuality = parseInt(document.getElementById('readiness-sleep-quality').value);
            const rhr = parseInt(document.getElementById('readiness-rhr').value);
            const soreness = parseInt(document.getElementById('readiness-soreness').value);
            const stress = parseInt(document.getElementById('readiness-stress').value);
            const motivation = parseInt(document.getElementById('readiness-motivation').value);
            const energy = parseInt(document.getElementById('readiness-energy').value);
            
            if (!sleep || !rhr) {
                alert('Please enter at least Sleep Duration and Resting Heart Rate!');
                return;
            }
            
            // Calculate readiness score (0-100)
            let score = 50; // Start at 50
            
            // Sleep (30 points possible)
            if (sleep >= 8) score += 15;
            else if (sleep >= 7) score += 10;
            else if (sleep >= 6) score += 5;
            else score -= 5; // <6 hours penalty
            
            score += (sleepQuality - 5) * 1.5; // -7.5 to +7.5
            
            // RHR (20 points possible)
            if (baselineRHR) {
                const rhrDiff = rhr - baselineRHR;
                if (rhrDiff <= 0) score += 10; // At or below baseline = great
                else if (rhrDiff <= 5) score += 5;
                else if (rhrDiff <= 10) score += 0;
                else score -= 10; // Elevated >10 = bad
            } else {
                score += 10; // No baseline yet, neutral
            }
            
            // Soreness (10 points)
            score += (6 - soreness); // 1 soreness = +5, 10 soreness = -4
            
            // Stress (10 points)
            score += (6 - stress);
            
            // Motivation (15 points)
            score += (motivation - 5) * 1.5;
            
            // Energy (15 points)
            score += (energy - 5) * 1.5;
            
            // Cap between 0-100
            score = Math.max(0, Math.min(100, Math.round(score)));
            
            // Save readiness
            dailyReadiness[dateStr] = {
                sleep,
                sleepQuality,
                rhr,
                soreness,
                stress,
                motivation,
                energy,
                score,
                timestamp: new Date().toISOString()
            };
            
            saveData();
            
            // Show result and continue to training
            showReadinessResult(dateStr, new Date(dateString), score);
        }
        
        function showReadinessResult(dateStr, date, score) {
            let statusColor, statusText, statusIcon, recommendation;
            
            if (score >= 85) {
                statusColor = '#00ff88';
                statusText = 'EXCELLENT';
                statusIcon = 'üî•';
                recommendation = 'Full training load. Go for PRs if planned!';
            } else if (score >= 70) {
                statusColor = '#00ccff';
                statusText = 'GOOD';
                statusIcon = '‚úì';
                recommendation = 'Normal training load. Push hard but listen to your body.';
            } else if (score >= 55) {
                statusColor = '#ffaa00';
                statusText = 'MODERATE';
                statusIcon = '‚ö†Ô∏è';
                recommendation = 'Reduce volume by 20-30%. Focus on technique, not max effort.';
            } else {
                statusColor = '#ff4444';
                statusText = 'POOR';
                statusIcon = '‚õî';
                recommendation = 'Consider active recovery or rest. If you train, reduce volume 40%+.';
            }
            
            const html = `
                <div class="modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">üìä READINESS RESULT</div>
                        </div>
                        
                        <div style="text-align: center; padding: 40px 20px; background: linear-gradient(135deg, #1a1a1a, #0a0a0a); border-radius: 12px; margin: 20px 0;">
                            <div style="font-size: 80px; margin-bottom: 20px;">${statusIcon}</div>
                            <div style="font-size: 60px; font-weight: bold; color: ${statusColor}; margin-bottom: 10px;">${score}</div>
                            <div style="font-size: 24px; font-weight: bold; color: ${statusColor}; margin-bottom: 20px;">${statusText}</div>
                            <div style="color: #aaa; font-size: 16px; max-width: 400px; margin: 0 auto;">${recommendation}</div>
                        </div>
                        
                        <div class="info-box">
                            <h3 style="color: #00ccff;">What This Means:</h3>
                            <p style="color: #aaa;">Your training suggestions for today will be ${score >= 70 ? 'normal' : 'adjusted'} based on this readiness score.</p>
                            ${score < 70 ? '<p style="color: #ffaa00;"><strong>Note:</strong> Workouts will be modified to match your current recovery state.</p>' : ''}
                        </div>
                        
                        <button onclick="continueAfterReadiness('${dateStr}', new Date('${date}'))" style="background: linear-gradient(135deg, #00ff88, #00ccff); border: none; color: #000; padding: 20px; border-radius: 10px; font-size: 18px; font-weight: bold; cursor: pointer; width: 100%; margin-top: 20px;">
                            ‚úì CONTINUE TO TRAINING LOG
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('day-modal').innerHTML = html;
        }
        
        function skipReadiness(dateStr, date) {
            closeModal();
            openDayDirect(dateStr, date);
        }
        
        function getReadinessScore(dateStr) {
            return dailyReadiness[dateStr]?.score || null;
        }
        
        // ========== BLOCK PERIODIZATION ENGINE ==========
        
        function initializeTrainingBlock() {
            if (!trainingBlock) {
                // Start with Volume block
                trainingBlock = {
                    type: BLOCK_TYPES.VOLUME,
                    startDate: formatDate(new Date()),
                    weekInBlock: 1,
                    cycleNumber: 1
                };
                saveData();
            }
        }
        
        function getCurrentBlock() {
            if (!trainingBlock) {
                initializeTrainingBlock();
            }
            return trainingBlock;
        }
        
        function getBlockConfig(blockType) {
            return BLOCK_CONFIGS[blockType || BLOCK_TYPES.VOLUME];
        }
        
        function advanceBlock() {
            const block = getCurrentBlock();
            const config = getBlockConfig(block.type);
            
            block.weekInBlock++;
            
            // Check if block is complete
            if (block.weekInBlock > config.duration) {
                // Move to next block in cycle
                if (block.type === BLOCK_TYPES.VOLUME) {
                    block.type = BLOCK_TYPES.STRENGTH;
                    block.weekInBlock = 1;
                } else if (block.type === BLOCK_TYPES.STRENGTH) {
                    block.type = BLOCK_TYPES.INTENSITY;
                    block.weekInBlock = 1;
                } else if (block.type === BLOCK_TYPES.INTENSITY) {
                    block.type = BLOCK_TYPES.DELOAD;
                    block.weekInBlock = 1;
                } else if (block.type === BLOCK_TYPES.DELOAD) {
                    // Complete cycle, start new one
                    block.type = BLOCK_TYPES.VOLUME;
                    block.weekInBlock = 1;
                    block.cycleNumber++;
                }
                block.startDate = formatDate(new Date());
            }
            
            saveData();
        }
        
        function checkAndAdvanceBlock() {
            const block = getCurrentBlock();
            const startDate = new Date(block.startDate);
            const today = new Date();
            const daysSinceStart = Math.floor((today - startDate) / (1000 * 60 * 60 * 24));
            const weeksSinceStart = Math.floor(daysSinceStart / 7);
            
            if (weeksSinceStart >= 1 && weeksSinceStart != block.weekInBlock - 1) {
                // Auto-advance based on calendar weeks
                const weeksToAdvance = weeksSinceStart - (block.weekInBlock - 1);
                for (let i = 0; i < weeksToAdvance; i++) {
                    advanceBlock();
                }
            }
        }
        
        function getBlockStatusHTML() {
            checkAndAdvanceBlock();
            const block = getCurrentBlock();
            const config = getBlockConfig(block.type);
            
            let nextBlockType = '';
            let nextBlockName = '';
            if (block.type === BLOCK_TYPES.VOLUME) {
                nextBlockType = BLOCK_TYPES.STRENGTH;
                nextBlockName = BLOCK_CONFIGS.strength.name;
            } else if (block.type === BLOCK_TYPES.STRENGTH) {
                nextBlockType = BLOCK_TYPES.INTENSITY;
                nextBlockName = BLOCK_CONFIGS.intensity.name;
            } else if (block.type === BLOCK_TYPES.INTENSITY) {
                nextBlockType = BLOCK_TYPES.DELOAD;
                nextBlockName = BLOCK_CONFIGS.deload.name;
            } else {
                nextBlockType = BLOCK_TYPES.VOLUME;
                nextBlockName = BLOCK_CONFIGS.volume.name;
            }
            
            const weeksRemaining = config.duration - block.weekInBlock;
            
            return `
                <div style="background: linear-gradient(135deg, #1a1a1a, #0d0d0d); border: 2px solid #00ff88; border-radius: 12px; padding: 20px; margin: 20px 0;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <div>
                            <h3 style="color: #00ff88; margin: 0; font-size: 24px;">BLOCK ${block.cycleNumber}: ${config.name}</h3>
                            <p style="color: #aaa; margin: 5px 0 0 0; font-size: 14px;">Week ${block.weekInBlock} of ${config.duration}</p>
                        </div>
                        <div style="text-align: right;">
                            <div style="color: #00ccff; font-size: 32px; font-weight: bold; line-height: 1;">${block.weekInBlock}/${config.duration}</div>
                            <div style="color: #666; font-size: 12px;">weeks</div>
                        </div>
                    </div>
                    
                    <div style="background: rgba(0, 255, 136, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <p style="color: #00ff88; font-weight: bold; margin: 0 0 8px 0;">üéØ Focus: ${config.focus}</p>
                        <p style="color: #ccc; font-size: 13px; margin: 0;">${config.description}</p>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                        <div style="background: #0a0a0a; padding: 12px; border-radius: 6px;">
                            <div style="color: #666; font-size: 11px; margin-bottom: 5px;">STRENGTH WORK</div>
                            <div style="color: #fff; font-weight: bold;">${config.strengthReps} reps</div>
                            <div style="color: #aaa; font-size: 12px;">${config.strengthSets} sets @ RPE ${config.strengthRPE}</div>
                        </div>
                        <div style="background: #0a0a0a; padding: 12px; border-radius: 6px;">
                            <div style="color: #666; font-size: 11px; margin-bottom: 5px;">CONDITIONING</div>
                            <div style="color: #fff; font-weight: bold; font-size: 13px;">${config.conditioning}</div>
                        </div>
                    </div>
                    
                    <div style="border-top: 1px solid #333; padding-top: 12px;">
                        <div style="color: #666; font-size: 12px;">NEXT BLOCK: ${nextBlockName} ${weeksRemaining > 0 ? `(in ${weeksRemaining + 1} week${weeksRemaining + 1 > 1 ? 's' : ''})` : '(NEXT WEEK)'}</div>
                    </div>
                    
                    <button onclick="showBlockDetails()" style="background: #222; border: 1px solid #444; color: #00ccff; padding: 10px; border-radius: 6px; font-size: 13px; cursor: pointer; width: 100%; margin-top: 12px;">
                        üìñ View Full Block Details
                    </button>
                </div>
            `;
        }
        
        function showBlockDetails() {
            const block = getCurrentBlock();
            const config = getBlockConfig(block.type);
            
            const html = `
                <div class="modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">üìã TRAINING BLOCK DETAILS</div>
                            <button class="close-btn" onclick="closeModal()">‚úï Close</button>
                        </div>
                        
                        <div style="background: linear-gradient(135deg, #1a1a1a, #0a0a0a); padding: 20px; border-radius: 10px; margin: 20px 0;">
                            <h2 style="color: #00ff88; margin: 0 0 10px 0;">BLOCK ${block.cycleNumber}: ${config.name}</h2>
                            <p style="color: #aaa; margin: 0;">Week ${block.weekInBlock} of ${config.duration} | ${config.focus}</p>
                        </div>
                        
                        <div style="margin: 20px 0;">
                            <h3 style="color: #00ccff;">üí™ STRENGTH TRAINING (Tue/Wed/Thu)</h3>
                            <div style="background: #0a0a0a; padding: 15px; border-radius: 8px; margin: 10px 0;">
                                <p style="color: #fff; margin: 5px 0;"><strong>Rep Range:</strong> ${config.strengthReps}</p>
                                <p style="color: #fff; margin: 5px 0;"><strong>Sets:</strong> ${config.strengthSets}</p>
                                <p style="color: #fff; margin: 5px 0;"><strong>Target RPE:</strong> ${config.strengthRPE}</p>
                                ${block.type === BLOCK_TYPES.INTENSITY ? 
                                    '<p style="color: #00ff88; margin: 10px 0 0 0;"><strong>‚úì YOUR PYRAMID STYLE:</strong> Warm up ‚Üí Build sets ‚Üí Heavy top set (RIR 0-1)</p>' : 
                                    '<p style="color: #aaa; margin: 10px 0 0 0;">Straight sets or moderate build-ups. Save max efforts for intensity block.</p>'
                                }
                            </div>
                            
                            <h3 style="color: #00ccff; margin-top: 25px;">üö¥ CONDITIONING (Friday)</h3>
                            <div style="background: #0a0a0a; padding: 15px; border-radius: 8px; margin: 10px 0;">
                                <p style="color: #fff; margin: 5px 0;"><strong>Focus:</strong> ${config.conditioning}</p>
                                ${getConditioningDetails(block.type)}
                            </div>
                            
                            <h3 style="color: #00ccff; margin-top: 25px;">üèÉ PLYO/TRACK (Sunday)</h3>
                            <div style="background: #0a0a0a; padding: 15px; border-radius: 8px; margin: 10px 0;">
                                <p style="color: #fff; margin: 5px 0;"><strong>Intensity:</strong> ${config.plyoIntensity}</p>
                                ${getPlyoDetails(block.type)}
                            </div>
                            
                            <h3 style="color: #00ccff; margin-top: 25px;">ü•ã JIU-JITSU (Saturday)</h3>
                            <div style="background: #0a0a0a; padding: 15px; border-radius: 8px; margin: 10px 0;">
                                <p style="color: #fff; margin: 5px 0;">Train normally - just track intensity and recovery.</p>
                            </div>
                        </div>
                        
                        <div class="info-box" style="margin-top: 20px;">
                            <h3 style="color: #00ff88;">üìä Block Progression</h3>
                            <p style="color: #aaa; font-size: 14px;">
                                Your training follows 10-week cycles:<br>
                                Weeks 1-3: Volume ‚Üí Weeks 4-6: Strength ‚Üí Weeks 7-9: Intensity ‚Üí Week 10: Deload
                            </p>
                            <p style="color: #666; font-size: 13px; margin-top: 10px;">
                                Current: Cycle ${block.cycleNumber}, Week ${block.weekInBlock}
                            </p>
                        </div>
                        
                        <button onclick="closeModal()" style="background: linear-gradient(135deg, #00ff88, #00ccff); border: none; color: #000; padding: 15px; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; width: 100%; margin-top: 20px;">
                            ‚úì Got It
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('day-modal').innerHTML = html;
            document.getElementById('day-modal').classList.remove('hidden');
        }
        
        function getConditioningDetails(blockType) {
            if (blockType === BLOCK_TYPES.VOLUME) {
                return '<p style="color: #aaa; margin: 10px 0 0 0;">30-60min Zone 2 (130-150 bpm) - conversational pace. Build aerobic base.</p>';
            } else if (blockType === BLOCK_TYPES.STRENGTH) {
                return '<p style="color: #aaa; margin: 10px 0 0 0;">Mix it up: Lactate capacity (30s hard √ó 8) or VO2max (3-5min hard). Build work capacity.</p>';
            } else if (blockType === BLOCK_TYPES.INTENSITY) {
                return '<p style="color: #aaa; margin: 10px 0 0 0;">Alactic power: 10s max effort √ó 6-8, full recovery. Express explosive power.</p>';
            } else {
                return '<p style="color: #aaa; margin: 10px 0 0 0;">Easy Zone 1-2 only (120-140 bpm). Active recovery, no hard efforts.</p>';
            }
        }
        
        function getPlyoDetails(blockType) {
            if (blockType === BLOCK_TYPES.VOLUME) {
                return '<p style="color: #aaa; margin: 10px 0 0 0;">Higher volume, lower intensity. 100-140 contacts. Focus on volume tolerance.</p>';
            } else if (blockType === BLOCK_TYPES.STRENGTH) {
                return '<p style="color: #aaa; margin: 10px 0 0 0;">Moderate volume/intensity. 80-120 contacts. Build explosive strength.</p>';
            } else if (blockType === BLOCK_TYPES.INTENSITY) {
                return '<p style="color: #aaa; margin: 10px 0 0 0;">Lower volume, MAX intensity. 60-100 contacts. Quality over quantity - express max power!</p>';
            } else {
                return '<p style="color: #aaa; margin: 10px 0 0 0;">Skip or very light technical work only. Let nervous system recover.</p>';
            }
        }
        
        // ========== PATTERN DETECTION & SMART SUGGESTIONS ==========
        
        function getDayOfWeekName(dateStr) {
            // Parse date string properly to avoid timezone issues
            // dateStr format: "YYYY-MM-DD"
            const [year, month, day] = dateStr.split('-');
            const date = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            return days[date.getDay()];
        }
        
        function detectDayPattern(dayOfWeek) {
            // YOUR ROUTINE:
            // Monday: Rest, Tuesday: Chest+Shoulders+Triceps, Wednesday: Legs
            // Thursday: Back+Biceps, Friday: Bike, Saturday: BJJ, Sunday: Track/Plyo
            const patterns = {
                'Sunday': ['track'],
                'Monday': [], // Rest
                'Tuesday': ['chest'],
                'Wednesday': ['legs'],
                'Thursday': ['back'],
                'Friday': ['bike'],
                'Saturday': ['bjj'],
            };
            return patterns[dayOfWeek] || [];
        }
        
        function getHistoricalWorkoutsForDay(dayOfWeek, limit = 4) {
            const workouts = [];
            const dates = Object.keys(trainingData).sort().reverse();
            
            for (const dateStr of dates) {
                if (getDayOfWeekName(dateStr) === dayOfWeek) {
                    workouts.push({ date: dateStr, data: trainingData[dateStr] });
                    if (workouts.length >= limit) break;
                }
            }
            return workouts;
        }
        
        function suggestModalities(dateStr) {
            const dayOfWeek = getDayOfWeekName(dateStr);
            return detectDayPattern(dayOfWeek);
        }
        
        function shouldShowSuggestion(dateStr) {
            const today = formatDate(new Date());
            if (dateStr < today) return false;
            if (trainingData[dateStr] && Object.keys(trainingData[dateStr].modalities || {}).length > 0) return false;
            const dayOfWeek = getDayOfWeekName(dateStr);
            return detectDayPattern(dayOfWeek).length > 0;
        }
        
        function showWorkoutSuggestion(dateStr, date) {
            const dayOfWeek = getDayOfWeekName(dateStr);
            const suggested = suggestModalities(dateStr);
            const history = getHistoricalWorkoutsForDay(dayOfWeek, 3);
            const readiness = getReadinessScore(dateStr);
            
            if (suggested.length === 0) {
                openDayDirect(dateStr, date);
                return;
            }
            
            // Format date properly to avoid timezone issues
            const [year, month, day] = dateStr.split('-');
            const displayDate = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
            const formattedDate = displayDate.toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            let historyHTML = '';
            if (history.length > 0) {
                historyHTML = '<h3 style="color: #00ccff; margin-top: 25px;">üìä Your Recent ' + dayOfWeek + 's:</h3><div style="background: #0a0a0a; padding: 15px; border-radius: 8px; margin: 10px 0;">';
                history.slice(0, 3).forEach((workout, i) => {
                    const mods = Object.keys(workout.data.modalities || {}).map(m => m.toUpperCase()).join(' + ');
                    const daysAgo = Math.floor((new Date() - new Date(workout.date)) / (1000 * 60 * 60 * 24));
                    historyHTML += `<p style="color: ${i === 0 ? '#fff' : '#aaa'}; margin: 5px 0;">${daysAgo} days ago: ${mods}</p>`;
                });
                historyHTML += '</div>';
            }
            
            const modalityLabels = {
                'chest': 'üí™ CHEST + SHOULDERS + TRICEPS',
                'back': 'üí™ BACK + BICEPS',
                'legs': 'üí™ LEGS',
                'track': 'üèÉ TRACK/PLYO',
                'bike': 'üö¥ ASSAULT BIKE',
                'bjj': 'ü•ã JIU-JITSU'
            };
            
            const html = `
                <div class="modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">üí° SUGGESTED WORKOUT</div>
                            <button class="close-btn" onclick="closeModal()">‚úï Close</button>
                        </div>
                        
                        <div class="info-box">
                            <h3 style="color: #00ff88;">${formattedDate}</h3>
                            ${readiness ? `<p style="color: #00ccff; margin-top: 10px;">Readiness Score: ${readiness}/100</p>` : ''}
                        </div>
                        
                        <h3 style="color: #00ccff; margin-top: 25px;">AI Suggests:</h3>
                        <div style="background: linear-gradient(135deg, #1a1a1a, #0a0a0a); padding: 20px; border-radius: 10px; margin: 15px 0; border: 2px solid #00ff88;">
                            ${suggested.map(mod => `<div style="font-size: 20px; color: #00ff88; margin: 10px 0;"><strong>${modalityLabels[mod] || mod.toUpperCase()}</strong></div>`).join('')}
                        </div>
                        
                        ${historyHTML}
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 25px;">
                            <button onclick="acceptSuggestion('${dateStr}', new Date('${dateStr}'), ${JSON.stringify(suggested)})" style="background: linear-gradient(135deg, #00ff88, #00ccff); border: none; color: #000; padding: 20px; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer;">
                                ‚úì ACCEPT & AUTO-FILL
                            </button>
                            <button onclick="checkAndShowReadiness('${dateStr}', new Date('${dateStr}'))" style="background: #333; border: 1px solid #666; color: #aaa; padding: 20px; border-radius: 10px; font-size: 16px; cursor: pointer;">
                                ‚úó PICK MANUALLY
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('day-modal').innerHTML = html;
            document.getElementById('day-modal').classList.remove('hidden');
        }
        
        function acceptSuggestion(dateStr, date, suggestedModalities) {
            closeModal();
            // Check readiness, then open day with auto-checked modalities
            checkAndShowReadinessWithModalities(dateStr, date, suggestedModalities);
        }
        
        function checkAndShowReadinessWithModalities(dateStr, date, modalitiestoCheck) {
            const today = formatDate(new Date());
            
            if (dateStr < today) {
                openDayDirectWithModalities(dateStr, date, modalitiestoCheck);
                return;
            }
            
            if (dailyReadiness[dateStr]) {
                openDayDirectWithModalities(dateStr, date, modalitiestoCheck);
                return;
            }
            
            // Show readiness, but remember to check modalities after
            window.pendingModalityChecks = modalitiestoCheck;
            showDailyReadiness(dateStr, date);
        }
        
        function openDayDirectWithModalities(dateStr, date, modalitiestoCheck) {
            openDayDirect(dateStr, date);
            setTimeout(() => {
                modalitiestoCheck.forEach(mod => {
                    const checkbox = document.getElementById(`check-${mod}`);
                    if (checkbox && !checkbox.checked) {
                        toggleModality(mod);
                    }
                });
            }, 100);
        }
        
        function continueAfterReadiness(dateStr, date) {
            if (window.pendingModalityChecks) {
                const modalities = window.pendingModalityChecks;
                window.pendingModalityChecks = null;
                openDayDirectWithModalities(dateStr, date, modalities);
            } else {
                openDayDirect(dateStr, date);
            }
        }
        
        // ========== PYRAMID PROGRESSION LOGIC ==========
        
        function getLastTopSet(exerciseName) {
            const history = exerciseHistory[exerciseName];
            if (!history || history.length === 0) return null;
            
            // Find most recent workout with this exercise
            const sortedHistory = history.sort((a, b) => new Date(b.date) - new Date(a.date));
            const lastWorkout = sortedHistory[0];
            
            if (!lastWorkout || !lastWorkout.sets || lastWorkout.sets.length === 0) return null;
            
            // Find the heaviest set (top set)
            let topSet = lastWorkout.sets[0];
            lastWorkout.sets.forEach(set => {
                if (set.weight > topSet.weight || 
                    (set.weight === topSet.weight && set.reps > topSet.reps)) {
                    topSet = set;
                }
            });
            
            return {
                ...topSet,
                date: lastWorkout.date,
                allSets: lastWorkout.sets
            };
        }
        
        function suggestPyramidProgression(exerciseName) {
            const block = getCurrentBlock();
            const config = getBlockConfig(block.type);
            const lastTop = getLastTopSet(exerciseName);
            const readiness = getReadinessScore(formatDate(new Date()));
            
            // If no history, return default starting points
            if (!lastTop) {
                return getDefaultStartingPyramid(exerciseName, block.type);
            }
            
            // Adjust based on block type
            if (block.type === BLOCK_TYPES.INTENSITY) {
                // INTENSITY BLOCK - YOUR PYRAMID STYLE
                return suggestIntensityPyramid(exerciseName, lastTop, readiness);
            } else if (block.type === BLOCK_TYPES.STRENGTH) {
                // STRENGTH BLOCK - Building foundation
                return suggestStrengthWork(exerciseName, lastTop, readiness);
            } else if (block.type === BLOCK_TYPES.VOLUME) {
                // VOLUME BLOCK - Hypertrophy focus
                return suggestVolumeWork(exerciseName, lastTop, readiness);
            } else {
                // DELOAD - Reduce everything
                return suggestDeloadWork(exerciseName, lastTop);
            }
        }
        
        function suggestIntensityPyramid(exerciseName, lastTop, readiness) {
            // YOUR PYRAMID STYLE - Build to heavy top set
            const sets = [];
            const topWeight = lastTop.weight;
            const topReps = lastTop.reps;
            
            // Determine progression (add weight if ready)
            let newTopWeight = topWeight;
            let newTopReps = topReps;
            
            if (!readiness || readiness >= 80) {
                // Good readiness - progress
                if (topReps >= 3) {
                    // Add reps first
                    newTopReps = topReps + 1;
                } else {
                    // Add weight, reset reps
                    newTopWeight = topWeight + 5;
                    newTopReps = 2;
                }
            } else if (readiness >= 65) {
                // Moderate readiness - maintain
                newTopWeight = topWeight;
                newTopReps = topReps;
            } else {
                // Poor readiness - back off
                newTopWeight = Math.round(topWeight * 0.9 / 5) * 5; // 90%, round to 5
                newTopReps = topReps + 1;
            }
            
            // Build pyramid
            // Warm-up sets
            sets.push({ weight: Math.round(newTopWeight * 0.45), reps: 10, rpe: null, label: 'Warm-up' });
            sets.push({ weight: Math.round(newTopWeight * 0.60), reps: 8, rpe: null, label: 'Warm-up' });
            
            // Build sets
            sets.push({ weight: Math.round(newTopWeight * 0.72), reps: 6, rpe: 6, label: 'Build' });
            sets.push({ weight: Math.round(newTopWeight * 0.82), reps: 4, rpe: 7, label: 'Build' });
            sets.push({ weight: Math.round(newTopWeight * 0.91), reps: 3, rpe: 8, label: 'Build' });
            
            // TOP SET
            sets.push({ weight: newTopWeight, reps: newTopReps, rpe: 10, label: 'TOP SET', isTopSet: true });
            
            return {
                type: 'pyramid',
                sets: sets,
                progression: newTopWeight > topWeight || newTopReps > topReps ? 
                    `+${newTopWeight - topWeight} lbs` + (newTopReps != topReps ? ` or +${newTopReps - topReps} reps` : '') : 
                    'Maintain',
                lastWorkout: `Last: ${topWeight}√ó${topReps} @ ${lastTop.rpe || 'RIR 0'}`,
                advice: readiness < 65 ? 'Backed off due to low readiness' : readiness >= 80 ? 'Good readiness - push it!' : 'Moderate readiness - technical work'
            };
        }
        
        function suggestStrengthWork(exerciseName, lastTop, readiness) {
            // STRENGTH BLOCK - 4-6 reps, 4-5 sets
            const baseWeight = Math.round(lastTop.weight * 0.85 / 5) * 5; // 85% of top set
            const sets = [];
            
            // Warm-ups
            sets.push({ weight: Math.round(baseWeight * 0.50), reps: 8, rpe: null, label: 'Warm-up' });
            sets.push({ weight: Math.round(baseWeight * 0.70), reps: 6, rpe: null, label: 'Warm-up' });
            
            // Working sets
            for (let i = 0; i < 5; i++) {
                sets.push({ weight: baseWeight, reps: 5, rpe: 8, label: 'Working' });
            }
            
            // Adjust for readiness
            if (readiness && readiness < 65) {
                const adjustedWeight = Math.round(baseWeight * 0.9 / 5) * 5;
                sets.forEach(set => {
                    if (set.label === 'Working') set.weight = adjustedWeight;
                });
            }
            
            return {
                type: 'straight',
                sets: sets,
                progression: 'Building strength base',
                lastWorkout: `Last top: ${lastTop.weight}√ó${lastTop.reps}`,
                advice: 'Focus on bar speed and technique'
            };
        }
        
        function suggestVolumeWork(exerciseName, lastTop, readiness) {
            // VOLUME BLOCK - 8-12 reps, 3-4 sets
            const baseWeight = Math.round(lastTop.weight * 0.70 / 5) * 5; // 70% of top set
            const sets = [];
            
            // Warm-ups
            sets.push({ weight: Math.round(baseWeight * 0.50), reps: 10, rpe: null, label: 'Warm-up' });
            sets.push({ weight: Math.round(baseWeight * 0.75), reps: 8, rpe: null, label: 'Warm-up' });
            
            // Working sets
            for (let i = 0; i < 4; i++) {
                sets.push({ weight: baseWeight, reps: 10, rpe: 7.5, label: 'Working' });
            }
            
            if (readiness && readiness < 65) {
                sets.pop(); // Remove one set
            }
            
            return {
                type: 'straight',
                sets: sets,
                progression: 'Building muscle and work capacity',
                lastWorkout: `Last top: ${lastTop.weight}√ó${lastTop.reps}`,
                advice: 'Control tempo, chase the pump'
            };
        }
        
        function suggestDeloadWork(exerciseName, lastTop) {
            // DELOAD - 50% reduction
            const deloadWeight = Math.round(lastTop.weight * 0.60 / 5) * 5;
            const sets = [];
            
            sets.push({ weight: Math.round(deloadWeight * 0.60), reps: 8, rpe: null, label: 'Warm-up' });
            sets.push({ weight: deloadWeight, reps: 8, rpe: 6, label: 'Technical' });
            sets.push({ weight: deloadWeight, reps: 8, rpe: 6, label: 'Technical' });
            
            return {
                type: 'deload',
                sets: sets,
                progression: 'Recovery week',
                lastWorkout: `Last top: ${lastTop.weight}√ó${lastTop.reps}`,
                advice: 'Light, technical, focus on recovery'
            };
        }
        
        function getDefaultStartingPyramid(exerciseName, blockType) {
            // Default starting weights for common exercises
            const defaults = {
                'Bench Press': { topWeight: 225, topReps: 3 },
                'Back Squat': { topWeight: 315, topReps: 3 },
                'Deadlift': { topWeight: 365, topReps: 3 },
                'Overhead Press': { topWeight: 135, topReps: 5 },
                'Romanian Deadlift': { topWeight: 225, topReps: 6 },
                'Incline DB Press': { topWeight: 70, topReps: 8 },
                'Pull-ups': { topWeight: 25, topReps: 8 } // Added weight
            };
            
            const defaultTop = defaults[exerciseName] || { topWeight: 135, topReps: 5 };
            
            if (blockType === BLOCK_TYPES.INTENSITY) {
                return suggestIntensityPyramid(exerciseName, defaultTop, null);
            } else {
                // Start conservative for volume/strength blocks
                return suggestVolumeWork(exerciseName, defaultTop, null);
            }
        }
        
        // ========== ENERGY SYSTEM PROTOCOLS (BIKE & TRACK) ==========
        
        function suggestBikeProtocol() {
            const block = getCurrentBlock();
            const readiness = getReadinessScore(formatDate(new Date()));
            
            if (block.type === BLOCK_TYPES.VOLUME) {
                // Zone 2 emphasis - build aerobic base
                return {
                    name: 'Zone 2 Base Building',
                    protocol: 'Steady State Aerobic',
                    description: '30-60min continuous at conversational pace',
                    intervals: [
                        { duration: 45, type: 'minutes', rpm: 'Easy 70-80', rpe: 6, rest: 0 }
                    ],
                    targetHR: '130-150 bpm',
                    advice: 'Should be able to hold a conversation. Build aerobic base.',
                    energySystem: 'Aerobic (Zone 2)'
                };
            } else if (block.type === BLOCK_TYPES.STRENGTH) {
                // Mix lactate + VO2max
                const weekInBlock = block.weekInBlock;
                if (weekInBlock === 1) {
                    // Lactate capacity
                    return {
                        name: 'Lactate Capacity',
                        protocol: 'High Intensity Intervals',
                        description: '30-40s hard efforts with 2-3min rest',
                        intervals: [
                            { duration: 30, type: 'seconds', rpm: '110-120', rpe: 9, rest: 120 },
                            { duration: 30, type: 'seconds', rpm: '110-120', rpe: 9, rest: 120 },
                            { duration: 30, type: 'seconds', rpm: '110-120', rpe: 9, rest: 120 },
                            { duration: 30, type: 'seconds', rpm: '110-120', rpe: 9, rest: 120 },
                            { duration: 30, type: 'seconds', rpm: '110-120', rpe: 9, rest: 120 },
                            { duration: 30, type: 'seconds', rpm: '110-120', rpe: 9, rest: 120 },
                            { duration: 30, type: 'seconds', rpm: '110-120', rpe: 9, rest: 120 },
                            { duration: 30, type: 'seconds', rpm: '110-120', rpe: 9, rest: 120 }
                        ],
                        targetHR: '170-185 bpm during work',
                        advice: 'Burn hard, recover fully. Building lactate tolerance.',
                        energySystem: 'Glycolytic (Lactate System)'
                    };
                } else if (weekInBlock === 2) {
                    // VO2max
                    return {
                        name: 'VO2max Intervals',
                        protocol: 'Aerobic Power',
                        description: '3-5min hard efforts with equal rest',
                        intervals: [
                            { duration: 4, type: 'minutes', rpm: '100-110', rpe: 9, rest: 240 },
                            { duration: 4, type: 'minutes', rpm: '100-110', rpe: 9, rest: 240 },
                            { duration: 4, type: 'minutes', rpm: '100-110', rpe: 9, rest: 240 },
                            { duration: 4, type: 'minutes', rpm: '100-110', rpe: 9, rest: 240 },
                            { duration: 4, type: 'minutes', rpm: '100-110', rpe: 9, rest: 240 }
                        ],
                        targetHR: '165-180 bpm sustained',
                        advice: 'Sustained hard efforts. Building aerobic power.',
                        energySystem: 'Aerobic Power (VO2max)'
                    };
                } else {
                    // Zone 2
                    return {
                        name: 'Zone 2 Recovery',
                        protocol: 'Easy Aerobic',
                        description: '30min easy to flush fatigue',
                        intervals: [
                            { duration: 30, type: 'minutes', rpm: 'Easy 70-80', rpe: 6, rest: 0 }
                        ],
                        targetHR: '130-145 bpm',
                        advice: 'Easy, conversational. Active recovery.',
                        energySystem: 'Aerobic (Zone 2)'
                    };
                }
            } else if (block.type === BLOCK_TYPES.INTENSITY) {
                // Alactic power - max efforts, full recovery
                return {
                    name: 'Alactic Power',
                    protocol: 'Max Effort Sprints',
                    description: '10s all-out sprints with full recovery',
                    intervals: [
                        { duration: 10, type: 'seconds', rpm: 'MAX 130+', rpe: 10, rest: 180 },
                        { duration: 10, type: 'seconds', rpm: 'MAX 130+', rpe: 10, rest: 180 },
                        { duration: 10, type: 'seconds', rpm: 'MAX 130+', rpe: 10, rest: 180 },
                        { duration: 10, type: 'seconds', rpm: 'MAX 130+', rpe: 10, rest: 180 },
                        { duration: 10, type: 'seconds', rpm: 'MAX 130+', rpe: 10, rest: 180 },
                        { duration: 10, type: 'seconds', rpm: 'MAX 130+', rpe: 10, rest: 180 },
                        { duration: 10, type: 'seconds', rpm: 'MAX 130+', rpe: 10, rest: 180 },
                        { duration: 10, type: 'seconds', rpm: 'MAX 130+', rpe: 10, rest: 180 }
                    ],
                    targetHR: 'Peak >170 bpm, recover <120 before next',
                    advice: 'ALL OUT for 10s. FULL recovery. Express max power.',
                    energySystem: 'Phosphagen (ATP-CP)'
                };
            } else {
                // Deload - easy Zone 1-2
                return {
                    name: 'Active Recovery',
                    protocol: 'Very Easy',
                    description: '20min super easy spinning',
                    intervals: [
                        { duration: 20, type: 'minutes', rpm: 'Very Easy 60-70', rpe: 4, rest: 0 }
                    ],
                    targetHR: '<130 bpm',
                    advice: 'Blood flow only. Recovery priority.',
                    energySystem: 'Active Recovery'
                };
            }
            
            // Adjust for readiness
            if (readiness && readiness < 65) {
                return {
                    name: 'Reduced Volume (Low Readiness)',
                    protocol: 'Easy Recovery',
                    description: '20min easy spinning',
                    intervals: [
                        { duration: 20, type: 'minutes', rpm: 'Easy 65-75', rpe: 5, rest: 0 }
                    ],
                    targetHR: '120-140 bpm',
                    advice: 'Low readiness detected. Easy recovery only.',
                    energySystem: 'Recovery'
                };
            }
        }
        
        function suggestTrackWorkout() {
            const block = getCurrentBlock();
            const readiness = getReadinessScore(formatDate(new Date()));
            const lastTrack = getLastTrackWorkout();
            
            if (block.type === BLOCK_TYPES.VOLUME) {
                // Higher volume, lower intensity
                return {
                    exercises: [
                        { type: 'bounding', name: 'Bounding', distance: 40, distanceUnit: 'yards', contacts: 12, rpe: 7 },
                        { type: 'broad-jump', name: 'Broad Jump', distance: 40, distanceUnit: 'yards', contacts: 10, rpe: 7 },
                        { type: 'sprint', name: 'Sprint', distance: 40, distanceUnit: 'yards', reps: 8, rest: 60, rpe: 8 }
                    ],
                    totalContacts: 22,
                    advice: 'Volume phase: Focus on contact volume, moderate intensity',
                    contactLimit: '100-140 contacts total per session'
                };
            } else if (block.type === BLOCK_TYPES.STRENGTH) {
                // Moderate volume/intensity
                return {
                    exercises: [
                        { type: 'box-jump', name: 'Box Jump', distance: 50, distanceUnit: 'stairs', contacts: 10, rpe: 8 },
                        { type: 'sprint', name: 'Sprint', distance: 60, distanceUnit: 'yards', reps: 6, rest: 90, rpe: 8.5 },
                        { type: 'sled-push', name: 'Sled Push', weight: 135, distance: 40, distanceUnit: 'yards', reps: 6, rest: 90, rpe: 8.5 }
                    ],
                    totalContacts: 10,
                    advice: 'Strength phase: Moderate volume, building power',
                    contactLimit: '80-120 contacts total per session'
                };
            } else if (block.type === BLOCK_TYPES.INTENSITY) {
                // Lower volume, MAX intensity
                return {
                    exercises: [
                        { type: 'depth-jump', name: 'Depth Jump', distance: 40, distanceUnit: 'stairs', contacts: 6, rpe: 9 },
                        { type: 'sprint', name: 'Sprint', distance: 100, distanceUnit: 'yards', reps: 5, rest: 180, rpe: 9.5 },
                        { type: 'tow-sprint', name: 'Tow Sprints', weight: 25, distance: 30, distanceUnit: 'yards', reps: 4, rpe: 9 }
                    ],
                    totalContacts: 6,
                    advice: 'INTENSITY PHASE: MAX effort, lower volume. Quality over quantity!',
                    contactLimit: '60-100 contacts total per session'
                };
            } else {
                // Deload - skip or very light
                return {
                    exercises: [
                        { type: 'high-knees', name: 'High Knees', distance: 20, distanceUnit: 'yards', contacts: 15, rpe: 5 }
                    ],
                    totalContacts: 15,
                    advice: 'DELOAD: Very light technical work or skip entirely',
                    contactLimit: 'Keep under 40 contacts'
                };
            }
            
            // Adjust for readiness
            if (readiness && readiness < 65) {
                return {
                    exercises: [],
                    totalContacts: 0,
                    advice: 'Low readiness - SKIP track today. Focus on recovery.',
                    contactLimit: 'REST'
                };
            }
        }
        
        function getLastTrackWorkout() {
            const dates = Object.keys(trainingData).sort().reverse();
            for (const date of dates) {
                if (trainingData[date].modalities && trainingData[date].modalities.track) {
                    return trainingData[date].modalities.track;
                }
            }
            return null;
        }
        
        function rotatePlyoExercises(currentExercises) {
            // Exercise rotation pool
            const plyoPool = [
                { type: 'box-jump', name: 'Box Jump' },
                { type: 'depth-jump', name: 'Depth Jump' },
                { type: 'broad-jump', name: 'Broad Jump' },
                { type: 'bounding', name: 'Bounding' },
                { type: 'single-leg-hop', name: 'Single Leg Hops' },
                { type: 'pogo-hop', name: 'Pogo Hops' }
            ];
            
            const sprintPool = [
                { type: 'sprint', name: 'Sprint' },
                { type: 'acceleration', name: 'Acceleration' },
                { type: 'flying-sprint', name: 'Flying Sprint' },
                { type: 'tow-sprint', name: 'Tow Sprints' }
            ];
            
            const loadedPool = [
                { type: 'sled-push', name: 'Sled Push' },
                { type: 'bear-crawl', name: 'Bear Crawl' }
            ];
            
            // Rotate based on what was done last time
            // This is simplified - in real implementation would track rotation history
            return currentExercises; // For now, keep same exercises
        }
        
        // Wrapper function for opening day - checks for suggestion, then readiness, then opens
        function openDay(dateStr, date) {
            // Check if we should show workout suggestion first
            if (shouldShowSuggestion(dateStr)) {
                showWorkoutSuggestion(dateStr, date);
            } else {
                checkAndShowReadiness(dateStr, date);
            }
        }
        
        // ========== DAY VIEW (HYBRID FORM) ==========
        let currentEditingDate = null;
        
        function openDayDirect(dateStr, date) {
            currentEditingDate = dateStr;
            const dayData = trainingData[dateStr] || { modalities: {} };
            
            exerciseCounters = {};
            setCounters = {};
            
            const html = `
                <div class="modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">${date.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</div>
                            <button class="close-btn" onclick="closeModal()">‚úï Close</button>
                        </div>
                        
                        <h3 style="color: #00ff88; margin-bottom: 15px;">SELECT TRAINING MODALITIES FOR TODAY:</h3>
                        
                        <div class="modality-checkboxes">
                            <div class="modality-checkbox ${dayData.modalities.chest ? 'checked' : ''}" onclick="toggleModality('chest')">
                                <input type="checkbox" id="check-chest" ${dayData.modalities.chest ? 'checked' : ''}>
                                <label for="check-chest">üí™ CHEST</label>
                            </div>
                            <div class="modality-checkbox ${dayData.modalities.back ? 'checked' : ''}" onclick="toggleModality('back')">
                                <input type="checkbox" id="check-back" ${dayData.modalities.back ? 'checked' : ''}>
                                <label for="check-back">üí™ BACK</label>
                            </div>
                            <div class="modality-checkbox ${dayData.modalities.legs ? 'checked' : ''}" onclick="toggleModality('legs')">
                                <input type="checkbox" id="check-legs" ${dayData.modalities.legs ? 'checked' : ''}>
                                <label for="check-legs">üí™ LEGS</label>
                            </div>
                            <div class="modality-checkbox ${dayData.modalities.track ? 'checked' : ''}" onclick="toggleModality('track')">
                                <input type="checkbox" id="check-track" ${dayData.modalities.track ? 'checked' : ''}>
                                <label for="check-track">üèÉ TRACK</label>
                            </div>
                            <div class="modality-checkbox ${dayData.modalities.bike ? 'checked' : ''}" onclick="toggleModality('bike')">
                                <input type="checkbox" id="check-bike" ${dayData.modalities.bike ? 'checked' : ''}>
                                <label for="check-bike">üö¥ BIKE</label>
                            </div>
                            <div class="modality-checkbox ${dayData.modalities.bjj ? 'checked' : ''}" onclick="toggleModality('bjj')">
                                <input type="checkbox" id="check-bjj" ${dayData.modalities.bjj ? 'checked' : ''}>
                                <label for="check-bjj">ü•ã BJJ</label>
                            </div>
                            <div class="modality-checkbox ${dayData.modalities.walking ? 'checked' : ''}" onclick="toggleModality('walking')">
                                <input type="checkbox" id="check-walking" ${dayData.modalities.walking ? 'checked' : ''}>
                                <label for="check-walking">üö∂ WALKING</label>
                            </div>
                        </div>
                        
                        <div id="form-chest" class="hidden modality-section"></div>
                        <div id="form-back" class="hidden modality-section"></div>
                        <div id="form-legs" class="hidden modality-section"></div>
                        <div id="form-track" class="hidden modality-section"></div>
                        <div id="form-bike" class="hidden modality-section"></div>
                        <div id="form-bjj" class="hidden modality-section"></div>
                        <div id="form-walking" class="hidden modality-section"></div>
                        
                        <button class="save-day-btn" onclick="saveDay('${dateStr}')">‚úì SAVE ALL TRAINING & ANALYZE</button>
                    </div>
                </div>
            `;
            
            document.getElementById('day-modal').innerHTML = html;
            document.getElementById('day-modal').classList.remove('hidden');
            
            Object.keys(dayData.modalities || {}).forEach(type => {
                if (dayData.modalities[type]) {
                    showModalityForm(type, dayData.modalities[type]);
                }
            });
        }
        
        function toggleModality(type) {
            const checkbox = document.getElementById('check-' + type);
            checkbox.checked = !checkbox.checked;
            
            const container = checkbox.parentElement;
            container.classList.toggle('checked');
            
            if (checkbox.checked) {
                showModalityForm(type);
            } else {
                document.getElementById('form-' + type).classList.add('hidden');
            }
        }
        
        function showModalityForm(type, data = null) {
            const form = document.getElementById('form-' + type);
            form.classList.remove('hidden');
            
            if (type === 'chest' || type === 'back' || type === 'legs') {
                form.innerHTML = generateWeightForm(type, data);
                if (!exerciseCounters[type]) exerciseCounters[type] = 0;
                if (data && data.exercises) {
                    // Load existing exercises
                } else {
                    addExercise(type);
                }
            } else if (type === 'track') {
                form.innerHTML = generateTrackForm(data);
                if (!exerciseCounters['track']) exerciseCounters['track'] = 0;
                // Add initial exercise
                addTrackExercise();
            } else if (type === 'bike') {
                form.innerHTML = generateBikeForm(data);
                if (!setCounters['bike']) setCounters['bike'] = 0;
                // Add initial intervals
                addBikeInterval();
                addBikeInterval();
                addBikeInterval();
            } else if (type === 'bjj') {
                form.innerHTML = generateBJJForm(data);
            } else if (type === 'walking') {
                form.innerHTML = generateWalkingForm(data);
            }
        }
        
        // ========== WEIGHT FORM GENERATOR ==========
        function generateWeightForm(type, data) {
            return `
                <h2>üí™ ${type.toUpperCase()} TRAINING</h2>
                <div class="section-content">
                    <button class="rpe-btn" onclick="showRPEGuide()">‚ùì RPE REFERENCE GUIDE</button>
                    
                    <div id="${type}-exercises"></div>
                    
                    <button class="add-exercise-btn" onclick="addExercise('${type}')">+ ADD EXERCISE</button>
                    
                    <h3 style="color: #00ccff; margin-top: 30px; margin-bottom: 15px;">Session Details:</h3>
                    
                    <div class="question">
                        <label>Overall feeling:</label>
                        <select id="${type}-feeling">
                            <option value="">Choose...</option>
                            <option value="great">Great - Strong & energized</option>
                            <option value="good">Good - Felt solid</option>
                            <option value="tired">Tired - Low energy</option>
                            <option value="beat">Beat Up - Sore & exhausted</option>
                        </select>
                    </div>
                    
                    <div class="question">
                        <label>Sleep last night (hours):</label>
                        <input type="number" id="${type}-sleep" step="0.5" placeholder="7.5" value="${data && data.sleep || ''}">
                    </div>
                    
                    <div class="upload-zone" id="${type}-upload" onclick="document.getElementById('${type}-hr').click()">
                        üìä Upload Polar HR Monitor Screenshot (optional)
                    </div>
                    <input type="file" id="${type}-hr" accept="image/*" style="display: none;" onchange="handleHRUpload('${type}', event)">
                    <img id="${type}-hr-preview" class="hr-preview hidden">
                </div>
            `;
        }
        
        function addExercise(type) {
            exerciseCounters[type]++;
            const exId = `${type}-ex${exerciseCounters[type]}`;
            setCounters[exId] = { warmup: 0, working: 0 };
            
            const html = `
                <div class="exercise-block" id="${exId}">
                    <input type="text" class="exercise-name" placeholder="Exercise name (e.g., Bench Press, Squat)" onblur="checkExerciseHistory('${exId}', this.value)">
                    
                    <div id="${exId}-history" class="hidden" style="background: rgba(0, 255, 136, 0.1); padding: 15px; border-radius: 8px; margin: 10px 0; border: 1px solid #00ff88;">
                        <!-- Auto-progression suggestions appear here -->
                    </div>
                    
                    <select class="muscle-select">
                        <option value="">Select muscle group...</option>
                        <option value="chest">Chest (pecs, front delts)</option>
                        <option value="back">Back (lats, traps, rear delts)</option>
                        <option value="shoulders">Shoulders (delts)</option>
                        <option value="biceps">Biceps</option>
                        <option value="triceps">Triceps</option>
                        <option value="quads">Quads (front thighs)</option>
                        <option value="hamstrings">Hamstrings (back thighs)</option>
                        <option value="glutes">Glutes</option>
                        <option value="calves">Calves</option>
                        <option value="core">Core (abs, obliques)</option>
                    </select>
                    
                    <div class="set-label">WARM-UP SETS</div>
                    <div id="${exId}-warmup"></div>
                    <button class="add-btn" onclick="addSet('${exId}', 'warmup')">+ Add Warm-up</button>
                    
                    <div class="set-label">WORKING SETS</div>
                    <div id="${exId}-working"></div>
                    <button class="add-btn" onclick="addSet('${exId}', 'working')">+ Add Working Set</button>
                </div>
            `;
            
            document.getElementById(type + '-exercises').insertAdjacentHTML('beforeend', html);
            addSet(exId, 'warmup');
            addSet(exId, 'warmup');
            addSet(exId, 'working');
            addSet(exId, 'working');
            addSet(exId, 'working');
        }
        
        function checkExerciseHistory(exId, exerciseName) {
            if (!exerciseName || exerciseName.trim() === '') return;
            
            const historyDiv = document.getElementById(exId + '-history');
            
            // Get smart pyramid progression based on block
            const progression = suggestPyramidProgression(exerciseName);
            
            if (!progression || !progression.sets || progression.sets.length === 0) {
                historyDiv.classList.add('hidden');
                return;
            }
            
            // Get current block for display
            const block = getCurrentBlock();
            const config = getBlockConfig(block.type);
            
            let html = `
                <div style="background: linear-gradient(135deg, #1a1a1a, #0a0a0a); border: 2px solid #00ff88; border-radius: 10px; padding: 15px; margin: 10px 0;">
                    <div style="color: #00ff88; font-weight: bold; margin-bottom: 8px;">
                        üí° AI SUGGESTED PROGRESSION (${config.name} Block)
                    </div>
                    ${progression.lastWorkout ? `
                        <div style="color: #aaa; margin-bottom: 10px; font-size: 13px;">
                            ${progression.lastWorkout}
                        </div>
                    ` : ''}
                    <div style="color: #00ccff; margin-bottom: 5px; font-size: 13px;">
                        ${progression.progression || 'Suggested progression'}
                    </div>
                    <div style="color: #888; margin-bottom: 12px; font-size: 12px; font-style: italic;">
                        ${progression.advice}
                    </div>
            `;
            
            // Display suggested sets
            if (progression.type === 'pyramid') {
                html += `<div style="background: #0a0a0a; padding: 12px; border-radius: 8px; margin-top: 12px;">`;
                html += `<div style="color: #fff; font-weight: bold; margin-bottom: 8px; font-size: 14px;">Suggested Pyramid:</div>`;
                progression.sets.forEach((set, i) => {
                    const color = set.isTopSet ? '#00ff88' : (set.label === 'Warm-up' ? '#666' : '#aaa');
                    const bold = set.isTopSet ? 'font-weight: bold; font-size: 15px;' : '';
                    html += `
                        <div style="color: ${color}; margin: 4px 0; ${bold}">
                            ${set.isTopSet ? 'üî• ' : ''}Set ${i + 1}: ${set.weight} lbs √ó ${set.reps} reps${set.rpe ? ` @ RPE ${set.rpe}` : ''} ${set.label ? `(${set.label})` : ''}
                        </div>
                    `;
                });
                html += `</div>`;
                
                html += `
                    <button onclick="autoFillPyramid('${exId}', ${JSON.stringify(progression.sets).replace(/"/g, '&quot;')})" 
                            style="background: #00ff88; color: #000; border: none; padding: 10px 15px; border-radius: 8px; font-weight: bold; cursor: pointer; width: 100%; margin-top: 12px;">
                        ‚úì AUTO-FILL THIS PYRAMID
                    </button>
                `;
            } else {
                // Straight sets or deload
                html += `<div style="background: #0a0a0a; padding: 12px; border-radius: 8px; margin-top: 12px;">`;
                progression.sets.filter(s => s.label === 'Working' || s.label === 'Technical').slice(0, 5).forEach((set, i) => {
                    html += `
                        <div style="color: #aaa; margin: 4px 0;">
                            Set ${i + 1}: ${set.weight} lbs √ó ${set.reps} reps @ RPE ${set.rpe}
                        </div>
                    `;
                });
                html += `</div>`;
                
                // Add button to apply to first working set
                const firstWorkingSet = progression.sets.find(s => s.label === 'Working' || s.label === 'Technical');
                if (firstWorkingSet) {
                    html += `
                        <button onclick="applyProgression('${exId}', ${firstWorkingSet.weight}, ${firstWorkingSet.reps})" 
                                style="background: #00ff88; color: #000; border: none; padding: 10px 15px; border-radius: 8px; font-weight: bold; cursor: pointer; width: 100%; margin-top: 12px;">
                            ‚úì APPLY TO WORKING SETS
                        </button>
                    `;
                }
            }
            
            html += `</div>`;
            
            historyDiv.innerHTML = html;
            historyDiv.classList.remove('hidden');
        }
        
        function applyProgression(exId, weight, reps) {
            // Auto-fill the first working set with suggested progression
            const workingDiv = document.getElementById(exId + '-working');
            const firstSet = workingDiv.querySelector('.set-row');
            if (firstSet) {
                firstSet.querySelector('.working-weight').value = weight;
                firstSet.querySelector('.working-reps').value = reps;
                alert(`‚úì Applied: ${weight} lbs √ó ${reps} reps to Set 1`);
            }
        }
        
        function autoFillPyramid(exId, sets) {
            // Clear existing sets
            const warmupDiv = document.getElementById(exId + '-warmup');
            const workingDiv = document.getElementById(exId + '-working');
            if (warmupDiv) warmupDiv.innerHTML = '';
            if (workingDiv) workingDiv.innerHTML = '';
            
            // Add each set
            sets.forEach((set, index) => {
                const type = set.label === 'Warm-up' ? 'warmup' : 'working';
                addSet(exId, type);
                
                // Fill in values after brief delay
                setTimeout(() => {
                    const targetDiv = type === 'warmup' ? warmupDiv : workingDiv;
                    if (targetDiv) {
                        const setRows = targetDiv.querySelectorAll('.set-row');
                        const setRow = setRows[setRows.length - 1]; // Get last added
                        if (setRow) {
                            const weightInput = setRow.querySelector(`.${type}-weight`);
                            const repsInput = setRow.querySelector(`.${type}-reps`);
                            const rpeInput = setRow.querySelector(`.${type}-rpe`);
                            
                            if (weightInput) weightInput.value = set.weight;
                            if (repsInput) repsInput.value = set.reps;
                            if (rpeInput && set.rpe) rpeInput.value = set.rpe;
                        }
                    }
                }, 50 * index);
            });
            
            alert(`‚úì Auto-filled ${sets.length} sets for pyramid!`);
        }
        
        function addSet(exId, type) {
            setCounters[exId][type]++;
            const setId = `${exId}-${type}${setCounters[exId][type]}`;
            const html = `
                <div class="set-row" id="${setId}">
                    <input type="number" placeholder="Weight" class="${type}-weight">
                    <input type="number" placeholder="Reps" class="${type}-reps">
                    <input type="number" placeholder="RPE" class="${type}-rpe" step="0.5" ${type === 'warmup' ? 'style="display:none"' : ''}>
                    <button class="delete-btn" onclick="deleteSet('${setId}')">‚úï</button>
                </div>
            `;
            document.getElementById(`${exId}-${type}`).insertAdjacentHTML('beforeend', html);
        }
        
        function deleteSet(setId) {
            document.getElementById(setId).remove();
        }
        
        // ========== OTHER FORM GENERATORS ==========
        function generateTrackForm(data) {
            // Get AI suggested workout
            const suggested = suggestTrackWorkout();
            
            let suggestionHTML = '';
            if (suggested && suggested.exercises && suggested.exercises.length > 0) {
                suggestionHTML = `
                    <div style="background: linear-gradient(135deg, #1a1a1a, #0a0a0a); border: 2px solid #00ff88; border-radius: 10px; padding: 20px; margin-bottom: 25px;">
                        <h3 style="color: #00ff88; margin: 0 0 15px 0;">üí° AI SUGGESTED WORKOUT</h3>
                        <div style="background: rgba(0, 255, 136, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                            <p style="color: #ccc; margin: 5px 0;"><strong>Total Contacts:</strong> ${suggested.totalContacts}</p>
                            <p style="color: #00ccff; margin: 10px 0 5px 0; font-size: 13px;"><strong>üí° ${suggested.advice}</strong></p>
                            <p style="color: #888; margin: 5px 0; font-size: 12px;">${suggested.contactLimit}</p>
                        </div>
                        <div style="background: #0a0a0a; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                            <p style="color: #fff; font-weight: bold; margin: 0 0 10px 0;">Suggested Exercises:</p>
                            ${suggested.exercises.map((ex, i) => `
                                <p style="color: #aaa; margin: 5px 0; font-size: 14px;">
                                    ${i + 1}. <strong style="color: #00ff88;">${ex.name}</strong>
                                    ${ex.distance ? ` - ${ex.distance} ${ex.distanceUnit}` : ''}
                                    ${ex.reps ? ` √ó ${ex.reps} reps` : ''}
                                    ${ex.contacts ? ` (${ex.contacts} contacts)` : ''}
                                    ${ex.weight ? ` with ${ex.weight} lbs` : ''}
                                    @ RPE ${ex.rpe}
                                </p>
                            `).join('')}
                        </div>
                        <button onclick="autoFillTrackExercises(${JSON.stringify(suggested.exercises).replace(/"/g, '&quot;')})" style="background: #00ff88; color: #000; border: none; padding: 12px 20px; border-radius: 8px; font-weight: bold; cursor: pointer; width: 100%; margin-top: 10px;">
                            ‚úì AUTO-FILL THESE EXERCISES
                        </button>
                    </div>
                `;
            }
            
            return `
                <h2>üèÉ TRACK / PLYOMETRICS / RUNNING</h2>
                <div class="section-content">
                    <button class="rpe-btn" onclick="showRPEGuide()">‚ùì RPE REFERENCE GUIDE</button>
                    
                    ${suggestionHTML}
                    
                    <div id="track-exercises"></div>
                    
                    <button class="add-exercise-btn" onclick="addTrackExercise()">+ ADD EXERCISE</button>
                    
                    <h3 style="color: #00ccff; margin-top: 30px; margin-bottom: 15px;">Session Details:</h3>
                    
                    <div class="question">
                        <label>Overall feeling:</label>
                        <select id="track-feeling">
                            <option value="">Choose...</option>
                            <option value="explosive">Explosive - Very reactive</option>
                            <option value="good">Good - Normal power</option>
                            <option value="flat">Flat - Low power output</option>
                            <option value="beat">Beat Up - Very fatigued</option>
                        </select>
                    </div>
                    
                    <div class="question">
                        <label>Ground feel (for plyos/sprints):</label>
                        <select id="track-ground">
                            <option value="">Choose...</option>
                            <option value="bouncy">Bouncy - Reactive & springy</option>
                            <option value="normal">Normal - Average feel</option>
                            <option value="heavy">Heavy - Sluggish & flat</option>
                        </select>
                    </div>
                    
                    <div class="question">
                        <label>Achilles/calf status:</label>
                        <select id="track-achilles">
                            <option value="">Choose...</option>
                            <option value="fresh">Fresh - No issues</option>
                            <option value="tight">Tight - Some tension</option>
                            <option value="sore">Sore - Notable discomfort</option>
                        </select>
                    </div>
                    
                    <div class="question">
                        <label>Sleep last night (hours):</label>
                        <input type="number" id="track-sleep" step="0.5" placeholder="7.5" value="${data && data.sleep || ''}">
                    </div>
                    
                    <div class="upload-zone" id="track-upload" onclick="document.getElementById('track-hr').click()">
                        üìä Upload Polar HR Monitor Screenshot (optional)
                    </div>
                    <input type="file" id="track-hr" accept="image/*" style="display: none;" onchange="handleHRUpload('track', event)">
                    <img id="track-hr-preview" class="hr-preview hidden">
                </div>
            `;
        }
        
        function addTrackExercise() {
            if (!exerciseCounters['track']) exerciseCounters['track'] = 0;
            exerciseCounters['track']++;
            const exId = `track-ex${exerciseCounters['track']}`;
            
            const html = `
                <div class="exercise-block" id="${exId}">
                    <select class="exercise-name" onchange="updateTrackExerciseFields('${exId}', this.value)" style="font-weight: bold;">
                        <option value="">Select Exercise...</option>
                        <optgroup label="üèÉ DISTANCE RUNNING">
                            <option value="distance-run">Distance Run</option>
                            <option value="tempo-run">Tempo Run</option>
                            <option value="long-run">Long Run</option>
                        </optgroup>
                        <optgroup label="‚ö° SPRINTS/SPEED">
                            <option value="sprint">Sprint</option>
                            <option value="acceleration">Acceleration</option>
                            <option value="flying-sprint">Flying Sprint</option>
                            <option value="hill-sprint">Hill Sprint</option>
                            <option value="tow-sprint">Tow Sprints (weighted)</option>
                        </optgroup>
                        <optgroup label="üí• PLYOMETRICS">
                            <option value="box-jump">Box Jump</option>
                            <option value="depth-jump">Depth Jump</option>
                            <option value="broad-jump">Broad Jump</option>
                            <option value="bounding">Bounding</option>
                            <option value="single-leg-hop">Single Leg Hops</option>
                            <option value="lateral-bound">Lateral Bounds</option>
                            <option value="hurdle-hop">Hurdle Hops</option>
                            <option value="tuck-jump">Tuck Jumps</option>
                            <option value="pogo-hop">Pogo Hops</option>
                            <option value="high-knees">High Knees</option>
                            <option value="skips">Skips</option>
                        </optgroup>
                        <optgroup label="üèãÔ∏è LOADED/RESISTANCE">
                            <option value="sled-push">Sled Push</option>
                            <option value="bear-crawl">Bear Crawl</option>
                        </optgroup>
                    </select>
                    
                    <div id="${exId}-fields" style="margin-top: 15px;">
                        <p style="color: #666; font-style: italic;">Select an exercise to see fields...</p>
                    </div>
                    
                    <button class="delete-btn" onclick="deleteTrackExercise('${exId}')" style="position: absolute; top: 15px; right: 15px; font-size: 24px;">‚úï</button>
                </div>
            `;
            
            document.getElementById('track-exercises').insertAdjacentHTML('beforeend', html);
        }
        
        function deleteTrackExercise(exId) {
            if (confirm('Remove this exercise?')) {
                document.getElementById(exId).remove();
            }
        }
        
        function updateTrackExerciseFields(exId, exerciseType) {
            const fieldsDiv = document.getElementById(exId + '-fields');
            if (!exerciseType) {
                fieldsDiv.innerHTML = '<p style="color: #666; font-style: italic;">Select an exercise to see fields...</p>';
                return;
            }
            
            let html = '';
            
            // Distance Running
            if (['distance-run', 'tempo-run', 'long-run'].includes(exerciseType)) {
                html = `
                    <div class="question">
                        <label>Distance:</label>
                        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 8px;">
                            <input type="number" class="distance-amount" step="0.1" placeholder="3.5">
                            <select class="distance-unit">
                                <option value="miles">Miles</option>
                                <option value="km">Kilometers</option>
                            </select>
                        </div>
                    </div>
                    <div class="question">
                        <label>Time (minutes):</label>
                        <input type="number" class="time" step="0.5" placeholder="28">
                    </div>
                    <div class="question">
                        <label>Average Pace (min/mile or min/km):</label>
                        <input type="number" class="pace" step="0.1" placeholder="8.0">
                    </div>
                    <div class="question">
                        <label>RPE:</label>
                        <input type="number" class="rpe" step="0.5" min="6" max="10" placeholder="7.0">
                    </div>
                `;
            }
            // Sprints (regular)
            else if (['sprint', 'acceleration', 'flying-sprint', 'hill-sprint'].includes(exerciseType)) {
                html = `
                    <div class="question">
                        <label>Distance:</label>
                        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 8px;">
                            <input type="number" class="distance-amount" placeholder="100">
                            <select class="distance-unit">
                                <option value="yards">Yards</option>
                                <option value="meters">Meters</option>
                            </select>
                        </div>
                    </div>
                    <div class="question">
                        <label>Reps (number of sprints):</label>
                        <input type="number" class="reps" placeholder="5">
                    </div>
                    <div class="question">
                        <label>Rest between (seconds):</label>
                        <input type="number" class="rest" placeholder="90">
                    </div>
                    <div class="question">
                        <label>RPE:</label>
                        <input type="number" class="rpe" step="0.5" min="6" max="10" placeholder="9.0">
                    </div>
                `;
            }
            // Tow Sprints (with weight)
            else if (exerciseType === 'tow-sprint') {
                html = `
                    <div class="question">
                        <label>Weight Towed (lbs):</label>
                        <input type="number" class="weight" placeholder="25">
                    </div>
                    <div class="question">
                        <label>Distance:</label>
                        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 8px;">
                            <input type="number" class="distance-amount" placeholder="30">
                            <select class="distance-unit">
                                <option value="yards">Yards</option>
                                <option value="meters">Meters</option>
                            </select>
                        </div>
                    </div>
                    <div class="question">
                        <label>Reps:</label>
                        <input type="number" class="reps" placeholder="6">
                    </div>
                    <div class="question">
                        <label>RPE:</label>
                        <input type="number" class="rpe" step="0.5" min="6" max="10" placeholder="8.5">
                    </div>
                `;
            }
            // Plyometrics
            else if (['box-jump', 'depth-jump', 'broad-jump', 'bounding', 'lateral-bound', 'hurdle-hop', 'tuck-jump', 'pogo-hop', 'high-knees', 'skips'].includes(exerciseType)) {
                html = `
                    <div class="question">
                        <label>Distance/Location:</label>
                        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 8px;">
                            <input type="number" class="distance-amount" placeholder="40">
                            <select class="distance-unit">
                                <option value="yards">Yards</option>
                                <option value="meters">Meters</option>
                                <option value="stairs">Stadium Stairs</option>
                            </select>
                        </div>
                    </div>
                    <div class="question">
                        <label>Contacts per rep:</label>
                        <input type="number" class="contacts" placeholder="10">
                    </div>
                    <div class="question">
                        <label>RPE:</label>
                        <input type="number" class="rpe" step="0.5" min="6" max="10" placeholder="8.0">
                    </div>
                `;
            }
            // Single leg exercises - separate tracking
            else if (exerciseType === 'single-leg-hop') {
                html = `
                    <div class="question">
                        <label>Distance/Location:</label>
                        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 8px;">
                            <input type="number" class="distance-amount" placeholder="40">
                            <select class="distance-unit">
                                <option value="yards">Yards</option>
                                <option value="meters">Meters</option>
                                <option value="stairs">Stadium Stairs</option>
                            </select>
                        </div>
                    </div>
                    <div class="question">
                        <label>Left leg jumps:</label>
                        <input type="number" class="left-jumps" placeholder="10">
                    </div>
                    <div class="question">
                        <label>Right leg jumps:</label>
                        <input type="number" class="right-jumps" placeholder="10">
                    </div>
                    <div class="question">
                        <label>RPE:</label>
                        <input type="number" class="rpe" step="0.5" min="6" max="10" placeholder="8.0">
                    </div>
                `;
            }
            // Sled Push
            else if (exerciseType === 'sled-push') {
                html = `
                    <div class="question">
                        <label>Weight (lbs):</label>
                        <input type="number" class="weight" placeholder="135">
                    </div>
                    <div class="question">
                        <label>Distance:</label>
                        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 8px;">
                            <input type="number" class="distance-amount" placeholder="40">
                            <select class="distance-unit">
                                <option value="yards">Yards</option>
                                <option value="meters">Meters</option>
                            </select>
                        </div>
                    </div>
                    <div class="question">
                        <label>Reps (number of pushes):</label>
                        <input type="number" class="reps" placeholder="8">
                    </div>
                    <div class="question">
                        <label>Rest between (seconds):</label>
                        <input type="number" class="rest" placeholder="60">
                    </div>
                    <div class="question">
                        <label>RPE:</label>
                        <input type="number" class="rpe" step="0.5" min="6" max="10" placeholder="9.0">
                    </div>
                `;
            }
            // Bear Crawl
            else if (exerciseType === 'bear-crawl') {
                html = `
                    <div class="question">
                        <label>Distance:</label>
                        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 8px;">
                            <input type="number" class="distance-amount" placeholder="20">
                            <select class="distance-unit">
                                <option value="yards">Yards</option>
                                <option value="meters">Meters</option>
                            </select>
                        </div>
                    </div>
                    <div class="question">
                        <label>Time (seconds, optional):</label>
                        <input type="number" class="time" placeholder="45">
                    </div>
                    <div class="question">
                        <label>RPE:</label>
                        <input type="number" class="rpe" step="0.5" min="6" max="10" placeholder="8.0">
                    </div>
                `;
            }
            
            fieldsDiv.innerHTML = html;
        }
        
        function generateBikeForm(data) {
            if (!setCounters['bike']) setCounters['bike'] = 0;
            
            // Get AI suggestion
            const suggested = suggestBikeProtocol();
            
            let suggestionHTML = '';
            if (suggested) {
                suggestionHTML = `
                    <div style="background: linear-gradient(135deg, #1a1a1a, #0a0a0a); border: 2px solid #00ccff; border-radius: 10px; padding: 20px; margin-bottom: 25px;">
                        <h3 style="color: #00ccff; margin: 0 0 15px 0;">üí° AI SUGGESTED PROTOCOL</h3>
                        <div style="background: rgba(0, 204, 255, 0.1); padding: 15px; border-radius: 8px;">
                            <p style="color: #00ff88; font-weight: bold; font-size: 18px; margin: 0 0 8px 0;">${suggested.name}</p>
                            <p style="color: #fff; margin: 5px 0;"><strong>Protocol:</strong> ${suggested.protocol}</p>
                            <p style="color: #fff; margin: 5px 0;"><strong>Description:</strong> ${suggested.description}</p>
                            <p style="color: #fff; margin: 5px 0;"><strong>Target HR:</strong> ${suggested.targetHR}</p>
                            <p style="color: #fff; margin: 5px 0;"><strong>Energy System:</strong> ${suggested.energySystem}</p>
                            <p style="color: #00ccff; margin: 15px 0 10px 0; font-size: 13px;"><strong>üí° ${suggested.advice}</strong></p>
                        </div>
                        <button onclick="autoFillBikeIntervals(${JSON.stringify(suggested.intervals).replace(/"/g, '&quot;')})" style="background: #00ff88; color: #000; border: none; padding: 12px 20px; border-radius: 8px; font-weight: bold; cursor: pointer; width: 100%; margin-top: 15px;">
                            ‚úì AUTO-FILL SUGGESTED INTERVALS
                        </button>
                    </div>
                `;
            }
            
            return `
                <h2>üö¥ ASSAULT BIKE</h2>
                <div class="section-content">
                    <button class="rpe-btn" onclick="showRPEGuide()">‚ùì RPE REFERENCE GUIDE</button>
                    
                    ${suggestionHTML}
                    
                    <div class="question">
                        <label>Protocol:</label>
                        <select id="bike-protocol">
                            <option value="">Choose...</option>
                            <option value="peak-rpm">Peak RPM Sprints</option>
                            <option value="zone5">Zone 5 Intervals</option>
                            <option value="alternating">Alternating Pace</option>
                            <option value="steady">Steady State</option>
                        </select>
                    </div>
                    
                    <div class="set-label" style="margin-top: 25px;">INTERVALS / SETS</div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr 40px; gap: 8px; margin-bottom: 8px; color: #888; font-size: 13px; font-weight: bold;">
                        <div>RPM</div>
                        <div>Duration (sec)</div>
                        <div>Rest (sec)</div>
                        <div>RPE</div>
                        <div></div>
                    </div>
                    <div id="bike-intervals"></div>
                    <button class="add-btn" onclick="addBikeInterval()">+ Add Interval</button>
                    
                    <h3 style="color: #00ccff; margin-top: 30px; margin-bottom: 15px;">Session Details:</h3>
                    
                    <div class="question">
                        <label>Breathing quality:</label>
                        <select id="bike-breathing">
                            <option value="">Choose...</option>
                            <option value="strong">Strong - Controlled breathing</option>
                            <option value="moderate">Moderate - Some struggle</option>
                            <option value="labored">Labored - Very difficult</option>
                        </select>
                    </div>
                    
                    <div class="question">
                        <label>Overall feeling:</label>
                        <select id="bike-feeling">
                            <option value="">Choose...</option>
                            <option value="great">Great</option>
                            <option value="good">Good</option>
                            <option value="tired">Tired</option>
                            <option value="beat">Beat up</option>
                        </select>
                    </div>
                    
                    <div class="question">
                        <label>Sleep last night (hours):</label>
                        <input type="number" id="bike-sleep" step="0.5" placeholder="7.5" value="${data && data.sleep || ''}">
                    </div>
                    
                    <div class="upload-zone" id="bike-upload" onclick="document.getElementById('bike-hr').click()">
                        üìä Upload Polar HR Monitor Screenshot (HIGHLY RECOMMENDED)
                    </div>
                    <input type="file" id="bike-hr" accept="image/*" style="display: none;" onchange="handleHRUpload('bike', event)">
                    <img id="bike-hr-preview" class="hr-preview hidden">
                </div>
            `;
        }
        
        function addBikeInterval() {
            setCounters['bike']++;
            const intervalId = `bike-int${setCounters['bike']}`;
            
            const html = `
                <div class="set-row" id="${intervalId}" style="grid-template-columns: 1fr 1fr 1fr 1fr 40px; margin-bottom: 10px;">
                    <input type="number" placeholder="RPM" class="bike-rpm" style="font-weight: bold;">
                    <input type="number" placeholder="Duration (sec)" class="bike-duration">
                    <input type="number" placeholder="Rest (sec)" class="bike-rest">
                    <input type="number" placeholder="RPE" class="bike-rpe" step="0.5">
                    <button class="delete-btn" onclick="deleteBikeInterval('${intervalId}')">‚úï</button>
                </div>
            `;
            
            document.getElementById('bike-intervals').insertAdjacentHTML('beforeend', html);
        }
        
        function deleteBikeInterval(intervalId) {
            document.getElementById(intervalId).remove();
        }
        
        function autoFillBikeIntervals(intervals) {
            // Clear existing intervals
            document.getElementById('bike-intervals').innerHTML = '';
            
            // Add suggested intervals
            intervals.forEach((interval, i) => {
                addBikeInterval();
                
                // Fill in values after a brief delay to ensure DOM is ready
                setTimeout(() => {
                    const intervalDiv = document.getElementById('bike-intervals').children[i];
                    if (intervalDiv) {
                        const rpmInput = intervalDiv.querySelector('.bike-rpm');
                        const durationInput = intervalDiv.querySelector('.bike-duration');
                        const restInput = intervalDiv.querySelector('.bike-rest');
                        const rpeInput = intervalDiv.querySelector('.bike-rpe');
                        
                        if (rpmInput) rpmInput.value = interval.rpm;
                        if (durationInput) durationInput.value = interval.duration;
                        if (restInput) restInput.value = interval.rest;
                        if (rpeInput) rpeInput.value = interval.rpe;
                    }
                }, 50 * i); // Stagger filling
            });
        }
        
        function autoFillTrackExercises(exercises) {
            // Clear existing exercises
            document.getElementById('track-exercises').innerHTML = '';
            
            // Add each suggested exercise
            exercises.forEach((ex, index) => {
                setTimeout(() => {
                    addTrackExercise();
                    
                    // Wait for DOM update, then fill in values
                    setTimeout(() => {
                        const exId = `track-ex${exerciseCounters['track']}`;
                        const block = document.getElementById(exId);
                        if (block) {
                            // Select the exercise type
                            const select = block.querySelector('.exercise-name');
                            if (select) {
                                select.value = ex.type;
                                // Trigger the change event to show fields
                                updateTrackExerciseFields(exId, ex.type);
                                
                                // Fill in the fields after they appear
                                setTimeout(() => {
                                    const fieldsDiv = document.getElementById(`${exId}-fields`);
                                    if (fieldsDiv) {
                                        if (ex.distance) {
                                            const distInput = fieldsDiv.querySelector('.distance-amount');
                                            if (distInput) distInput.value = ex.distance;
                                        }
                                        if (ex.distanceUnit) {
                                            const unitSelect = fieldsDiv.querySelector('.distance-unit');
                                            if (unitSelect) unitSelect.value = ex.distanceUnit;
                                        }
                                        if (ex.reps) {
                                            const repsInput = fieldsDiv.querySelector('.reps');
                                            if (repsInput) repsInput.value = ex.reps;
                                        }
                                        if (ex.rest) {
                                            const restInput = fieldsDiv.querySelector('.rest');
                                            if (restInput) restInput.value = ex.rest;
                                        }
                                        if (ex.contacts) {
                                            const contactsInput = fieldsDiv.querySelector('.contacts');
                                            if (contactsInput) contactsInput.value = ex.contacts;
                                        }
                                        if (ex.weight) {
                                            const weightInput = fieldsDiv.querySelector('.weight');
                                            if (weightInput) weightInput.value = ex.weight;
                                        }
                                        if (ex.time) {
                                            const timeInput = fieldsDiv.querySelector('.time');
                                            if (timeInput) timeInput.value = ex.time;
                                        }
                                        if (ex.rpe) {
                                            const rpeInput = fieldsDiv.querySelector('.rpe');
                                            if (rpeInput) rpeInput.value = ex.rpe;
                                        }
                                        if (ex.leftJumps) {
                                            const leftInput = fieldsDiv.querySelector('.left-jumps');
                                            if (leftInput) leftInput.value = ex.leftJumps;
                                        }
                                        if (ex.rightJumps) {
                                            const rightInput = fieldsDiv.querySelector('.right-jumps');
                                            if (rightInput) rightInput.value = ex.rightJumps;
                                        }
                                    }
                                }, 100);
                            }
                        }
                    }, 50);
                }, index * 200); // Stagger the additions
            });
            
            alert(`‚úì Auto-filled ${exercises.length} suggested exercises!`);
        }
        
        function generateBJJForm(data) {
            return `
                <h2>ü•ã JIU JITSU</h2>
                <div class="section-content">
                    <div class="question">
                        <label>Spar time (minutes):</label>
                        <input type="number" id="bjj-time" placeholder="45" value="${data && data.time || ''}">
                    </div>
                    
                    <div class="question">
                        <label>Intensity:</label>
                        <select id="bjj-intensity">
                            <option value="">Choose...</option>
                            <option value="high">High - Hard rolling</option>
                            <option value="medium">Medium - Flow rolling</option>
                            <option value="light">Light - Technique only</option>
                        </select>
                    </div>
                    
                    <div class="question">
                        <label>Weight before (lbs):</label>
                        <input type="number" id="bjj-weight-before" step="0.1" placeholder="180.0" value="${data && data.weightBefore || ''}">
                    </div>
                    
                    <div class="question">
                        <label>Weight after (lbs):</label>
                        <input type="number" id="bjj-weight-after" step="0.1" placeholder="177.0" value="${data && data.weightAfter || ''}">
                    </div>
                    
                    <div class="question">
                        <label>Overall feeling:</label>
                        <select id="bjj-feeling">
                            <option value="">Choose...</option>
                            <option value="great">Great</option>
                            <option value="good">Good</option>
                            <option value="tired">Tired</option>
                            <option value="beat">Beat up</option>
                        </select>
                    </div>
                    
                    <div class="question">
                        <label>Sleep last night (hours):</label>
                        <input type="number" id="bjj-sleep" step="0.5" placeholder="7.5" value="${data && data.sleep || ''}">
                    </div>
                    
                    <div class="upload-zone" id="bjj-upload" onclick="document.getElementById('bjj-hr').click()">
                        üìä Upload Polar HR Monitor Screenshot (optional)
                    </div>
                    <input type="file" id="bjj-hr" accept="image/*" style="display: none;" onchange="handleHRUpload('bjj', event)">
                    <img id="bjj-hr-preview" class="hr-preview hidden">
                </div>
            `;
        }
        
        function generateWalkingForm(data) {
            return `
                <h2>üö∂ WALKING / RECOVERY</h2>
                <div class="section-content">
                    <p style="color: #888; margin-bottom: 20px;">Active recovery through walking with HR monitoring</p>
                    
                    <div class="question">
                        <label>Duration (minutes):</label>
                        <input type="number" id="walking-duration" placeholder="30" value="${data && data.duration || ''}">
                    </div>
                    
                    <div class="question">
                        <label>Distance (miles):</label>
                        <input type="number" id="walking-distance" step="0.1" placeholder="2.5" value="${data && data.distance || ''}">
                    </div>
                    
                    <div class="question">
                        <label>Average pace (min/mile):</label>
                        <input type="number" id="walking-pace" step="0.1" placeholder="12.0" value="${data && data.pace || ''}">
                    </div>
                    
                    <div class="question">
                        <label>Terrain:</label>
                        <select id="walking-terrain">
                            <option value="">Choose...</option>
                            <option value="flat">Flat - Level ground</option>
                            <option value="hills">Hills - Moderate elevation</option>
                            <option value="steep">Steep - Significant incline</option>
                        </select>
                    </div>
                    
                    <div class="question">
                        <label>Purpose:</label>
                        <select id="walking-purpose">
                            <option value="">Choose...</option>
                            <option value="recovery">Active Recovery</option>
                            <option value="zone2">Zone 2 Cardio</option>
                            <option value="general">General Activity</option>
                        </select>
                    </div>
                    
                    <div class="upload-zone" id="walking-upload" onclick="document.getElementById('walking-hr').click()">
                        üìä Upload Polar HR Monitor Screenshot (RECOMMENDED for Zone 2 tracking)
                    </div>
                    <input type="file" id="walking-hr" accept="image/*" style="display: none;" onchange="handleHRUpload('walking', event)">
                    <img id="walking-hr-preview" class="hr-preview hidden">
                </div>
            `;
        }
        
        // ========== HR UPLOAD & AI ANALYSIS ==========
        let hrData = {};
        
        async function handleHRUpload(type, event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const preview = document.getElementById(type + '-hr-preview');
            const uploadZone = document.getElementById(type + '-upload');
            
            // Show preview
            const reader = new FileReader();
            reader.onload = function(e) {
                preview.src = e.target.result;
                preview.classList.remove('hidden');
                uploadZone.classList.add('has-file');
                uploadZone.innerHTML = 'üìä HR Data Uploaded - Analyzing with AI...';
            };
            reader.readAsDataURL(file);
            
            // AI Analysis
            try {
                const base64Data = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => {
                        const base64 = reader.result.split(",")[1];
                        resolve(base64);
                    };
                    reader.onerror = () => reject(new Error("Failed to read file"));
                    reader.readAsDataURL(file);
                });
                
                const response = await fetch("https://api.anthropic.com/v1/messages", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        model: "claude-sonnet-4-20250514",
                        max_tokens: 1000,
                        messages: [
                            {
                                role: "user",
                                content: [
                                    {
                                        type: "image",
                                        source: {
                                            type: "base64",
                                            media_type: "image/jpeg",
                                            data: base64Data,
                                        }
                                    },
                                    {
                                        type: "text",
                                        text: `Analyze this Polar heart rate monitor graph. Extract the following data and respond ONLY with valid JSON (no markdown, no other text):

{
  "peakHR": number,
  "avgHR": number,
  "timeInZone5": number (minutes in 90-100% max HR),
  "timeInZone4": number (minutes in 80-90% max HR),
  "timeInZone3": number (minutes in 70-80% max HR),
  "timeInZone2": number (minutes in 60-70% max HR),
  "recovery": "good" | "moderate" | "poor",
  "notes": "brief analysis"
}

DO NOT include any text outside the JSON object. Do not use markdown code blocks.`
                                    }
                                ]
                            }
                        ]
                    })
                });
                
                const data = await response.json();
                let responseText = data.content[0].text;
                
                // Strip any markdown
                responseText = responseText.replace(/```json\n?/g, "").replace(/```\n?/g, "").trim();
                
                const hrAnalysis = JSON.parse(responseText);
                hrData[type] = hrAnalysis;
                
                // Display analysis
                uploadZone.innerHTML = `‚úì HR Analysis Complete
                    <br><span style="font-size: 12px; color: #00ff88;">
                    Peak: ${hrAnalysis.peakHR} bpm | Avg: ${hrAnalysis.avgHR} bpm | Recovery: ${hrAnalysis.recovery}
                    <br>Z5: ${hrAnalysis.timeInZone5}min | Z4: ${hrAnalysis.timeInZone4}min | Z3: ${hrAnalysis.timeInZone3}min
                    </span>`;
            } catch (error) {
                console.error("HR Analysis Error:", error);
                uploadZone.innerHTML = '‚ö†Ô∏è Could not analyze HR data - uploaded but analysis failed';
            }
        }
        
        // ========== RPE GUIDE ==========
        function showRPEGuide() {
            const html = `
                <div class="rpe-modal">
                    <div class="rpe-content">
                        <button class="close-btn" onclick="closeRPEGuide()">‚úï Close</button>
                        <h2 style="color: #00ff88; margin-bottom: 20px; clear: both;">RPE REFERENCE GUIDE</h2>
                        <p style="color: #aaa; margin-bottom: 20px;">RPE (Rate of Perceived Exertion) = Reps In Reserve (RIR)</p>
                        
                        <div class="rpe-row">
                            <div class="rpe-number">10</div>
                            <div class="rpe-rir">0 RIR</div>
                            <div class="rpe-desc">Absolute failure - could NOT do another rep</div>
                        </div>
                        
                        <div class="rpe-row">
                            <div class="rpe-number">9.5</div>
                            <div class="rpe-rir">0-1 RIR</div>
                            <div class="rpe-desc">Maybe 1 more rep - almost certain failure</div>
                        </div>
                        
                        <div class="rpe-row" style="border: 2px solid #ff6b35;">
                            <div class="rpe-number">9</div>
                            <div class="rpe-rir">1 RIR</div>
                            <div class="rpe-desc"><strong>ALMOST FAILURE</strong> - Definitely 1 rep left, not 2</div>
                        </div>
                        
                        <div class="rpe-row">
                            <div class="rpe-number">8.5</div>
                            <div class="rpe-rir">1-2 RIR</div>
                            <div class="rpe-desc">1 rep for sure, maybe 2</div>
                        </div>
                        
                        <div class="rpe-row" style="border: 2px solid #00ff88;">
                            <div class="rpe-number">8</div>
                            <div class="rpe-rir">2 RIR</div>
                            <div class="rpe-desc"><strong>OPTIMAL FOR HYPERTROPHY</strong> - Solid 2 reps left</div>
                        </div>
                        
                        <div class="rpe-row">
                            <div class="rpe-number">7.5</div>
                            <div class="rpe-rir">2-3 RIR</div>
                            <div class="rpe-desc">2 reps for sure, maybe 3</div>
                        </div>
                        
                        <div class="rpe-row">
                            <div class="rpe-number">7</div>
                            <div class="rpe-rir">3 RIR</div>
                            <div class="rpe-desc">Moderate difficulty - 3 reps left</div>
                        </div>
                        
                        <div class="rpe-row">
                            <div class="rpe-number">6</div>
                            <div class="rpe-rir">4 RIR</div>
                            <div class="rpe-desc">Bar speed still fast - 4+ reps left</div>
                        </div>
                        
                        <p style="color: #666; margin-top: 20px; font-size: 13px; text-align: center;">
                            RIR = Reps In Reserve (how many more reps you could do)
                        </p>
                    </div>
                </div>
            `;
            document.getElementById('rpe-modal').innerHTML = html;
            document.getElementById('rpe-modal').classList.remove('hidden');
        }
        
        function closeRPEGuide() {
            document.getElementById('rpe-modal').classList.add('hidden');
        }
        
        function closeModal() {
            document.getElementById('day-modal').classList.add('hidden');
            document.getElementById('weekly-modal').classList.add('hidden');
            hrData = {}; // Clear HR data
        }
        
        function showHelp() {
            const html = `
                <div class="modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">üìñ ELITE ATHLETE TRACKER - USER GUIDE</div>
                            <button class="close-btn" onclick="closeModal()">‚úï Close</button>
                        </div>
                        
                        <div class="info-box">
                            <h3 style="color: #00ff88;">üéØ CORE FEATURES</h3>
                            <p><strong>Hybrid Training Days:</strong> Log multiple modalities on the same day (Chest + Legs + Bike + BJJ, etc.)</p>
                            <p><strong>7 Modalities:</strong> Chest, Back, Legs, Track/Plyos, Assault Bike, BJJ, Walking</p>
                            <p><strong>AI HR Analysis:</strong> Upload Polar screenshots for automatic HR zone extraction</p>
                            <p><strong>Elite Metrics:</strong> TSS, A:C Ratio, Fitness-Fatigue Model, Monotony, Strain</p>
                            <p><strong>Auto-Progression:</strong> System suggests next weights based on your history</p>
                        </div>
                        
                        <div class="info-box">
                            <h3 style="color: #00ccff;">üìÖ CALENDAR USAGE</h3>
                            <p><strong>Empty Day:</strong> Click to log new workout</p>
                            <p><strong>Completed Day:</strong> Click to view/edit workout</p>
                            <p><strong>Right-Click or Ctrl+Click:</strong> View detailed historical analysis</p>
                            <p><strong>CNS Indicators:</strong> Green (low), Yellow (moderate), Red (high CNS load)</p>
                            <p><strong>Badges:</strong> Show which modalities you completed</p>
                        </div>
                        
                        <div class="info-box">
                            <h3 style="color: #ff6b35;">üí™ LOGGING WORKOUTS</h3>
                            <p><strong>Select Modalities:</strong> Check all training you did that day</p>
                            <p><strong>Exercises:</strong> Type name ‚Üí system shows last workout + progression suggestions</p>
                            <p><strong>RPE:</strong> Use 6-10 scale (click "RPE GUIDE" for reference)</p>
                            <p><strong>Bike Intervals:</strong> Log RPM, duration, rest, and RPE per interval</p>
                            <p><strong>HR Upload:</strong> Upload Polar screenshot ‚Üí AI extracts zones automatically</p>
                            <p><strong>Save:</strong> One button saves ALL modalities with full analysis</p>
                        </div>
                        
                        <div class="success-box">
                            <h3 style="color: #00ff88;">üß† AUTO-PROGRESSION</h3>
                            <p><strong>How it Works:</strong> Type exercise name ‚Üí system shows your last workout</p>
                            <p><strong>Suggestions:</strong> Click button to auto-fill suggested weight/reps</p>
                            <p><strong>Strategies:</strong></p>
                            <ul style="margin-left: 20px; margin-top: 5px;">
                                <li>Volume: Same weight, +1 rep</li>
                                <li>Intensity: +2.5-5 lbs, same reps</li>
                                <li>Deload: -10% if last RPE was ‚â•9.5</li>
                            </ul>
                        </div>
                        
                        <div class="warning-box">
                            <h3>‚ö†Ô∏è INTERFERENCE DETECTION</h3>
                            <p><strong>Before Save:</strong> System warns if you're combining problematic modalities</p>
                            <p><strong>Critical Combos:</strong></p>
                            <ul style="margin-left: 20px; margin-top: 5px;">
                                <li>Legs + Track = Type II fiber overload</li>
                                <li>4+ modalities = Extreme CNS stress</li>
                            </ul>
                            <p><strong>After Save:</strong> Full interference analysis with recovery recommendations</p>
                        </div>
                        
                        <div class="info-box">
                            <h3 style="color: #00ccff;">üìä WEEKLY ANALYSIS</h3>
                            <p><strong>Load Metrics:</strong> Volume, CNS, TSS, A:C Ratio, Monotony, Strain</p>
                            <p><strong>Fitness-Fatigue Model:</strong> Shows if you're building fitness or accumulating fatigue</p>
                            <p><strong>Recovery Status:</strong> Excellent/Good/Moderate/Poor based on CNS trends</p>
                            <p><strong>Next Week Forecast:</strong> AI predicts your readiness and gives recommendations</p>
                            <p><strong>Injury Warnings:</strong> Alerts when A:C ratio >1.3 (injury risk zone)</p>
                        </div>
                        
                        <div class="info-box">
                            <h3 style="color: #8a2be2;">üî¨ UNDERSTANDING METRICS</h3>
                            <p><strong>CNS Score (0-100):</strong> Neural system stress. <60=low, 60-75=moderate, >75=high</p>
                            <p><strong>TSS (Training Stress Score):</strong> Total training load combining duration, intensity, volume</p>
                            <p><strong>A:C Ratio:</strong> This week vs 4-week average. 0.8-1.3 = optimal, >1.5 = injury risk</p>
                            <p><strong>Monotony:</strong> Training variation. High monotony + high strain = overtraining</p>
                            <p><strong>Fitness:</strong> Adaptations from training (builds slowly, decays slowly)</p>
                            <p><strong>Fatigue:</strong> Accumulated stress (builds fast, dissipates fast with rest)</p>
                            <p><strong>Performance:</strong> Fitness - Fatigue. Positive = ready for PRs. Negative = need recovery</p>
                        </div>
                        
                        <div class="success-box">
                            <h3 style="color: #00ff88;">üí° PRO TIPS</h3>
                            <ul style="margin-left: 20px;">
                                <li>Always upload HR data for cardio (Bike, Walking, Track)</li>
                                <li>Track sleep every session - major CNS factor</li>
                                <li>When A:C ratio >1.3, immediately reduce volume</li>
                                <li>Performance <-15 = mandatory deload week</li>
                                <li>Use auto-progression suggestions to stay consistent</li>
                                <li>Right-click past days to compare progress</li>
                                <li>Walking is crucial for active recovery - track it!</li>
                            </ul>
                        </div>
                        
                        <div style="background: #0a0a0a; padding: 20px; border-radius: 8px; text-align: center; margin-top: 20px;">
                            <p style="color: #666; font-size: 12px;">
                                All data saved locally in your browser ‚Ä¢ No account needed ‚Ä¢ Export coming soon
                            </p>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('weekly-modal').innerHTML = html;
            document.getElementById('weekly-modal').classList.remove('hidden');
        }
        
        // ========== SAVE DAY ==========
        async function saveDay(dateStr) {
            const data = {
                modalities: {},
                totalCNS: 0,
                totalVolume: 0,
                tss: 0,
                qualities: {}
            };
            
            // Collect from each checked modality
            const modalityTypes = ['chest', 'back', 'legs', 'track', 'bike', 'bjj', 'walking'];
            
            for (const type of modalityTypes) {
                const checkbox = document.getElementById('check-' + type);
                if (checkbox && checkbox.checked) {
                    const modalityData = await collectModalityData(type);
                    if (modalityData) {
                        data.modalities[type] = modalityData;
                        data.modalities[type].completed = true;
                    }
                }
            }
            
            if (Object.keys(data.modalities).length === 0) {
                alert('Please select and complete at least one training modality!');
                return;
            }
            
            // PROACTIVE INTERFERENCE CHECK - BEFORE SAVING
            const earlyInterference = detectInterferenceEarly(data.modalities);
            if (earlyInterference.critical.length > 0) {
                const proceed = confirm(
                    '‚ö†Ô∏è CRITICAL INTERFERENCE DETECTED:\n\n' +
                    earlyInterference.critical.map(i => `‚Ä¢ ${i.message}\n  Impact: ${i.impact}\n  Fix: ${i.fix}`).join('\n\n') +
                    '\n\nDo you want to save anyway?'
                );
                if (!proceed) return;
            }
            
            // Calculate combined metrics
            Object.keys(data.modalities).forEach(type => {
                const mod = data.modalities[type];
                data.totalCNS += mod.cnsScore || 0;
                data.totalVolume += mod.volume || 0;
                data.tss += mod.tss || 0;
            });
            
            // Quality analysis
            data.qualities = analyzeQualities(data.modalities);
            
            // Interference detection (full)
            data.interference = detectInterference(data.modalities, data.qualities);
            
            // Store exercise history for progression
            Object.keys(data.modalities).forEach(type => {
                if ((type === 'chest' || type === 'back' || type === 'legs') && data.modalities[type].exercises) {
                    updateExerciseHistory(dateStr, data.modalities[type].exercises);
                }
            });
            
            trainingData[dateStr] = data;
            historicalTSS.push({ date: dateStr, tss: data.tss });
            if (historicalTSS.length > 28) historicalTSS.shift();
            
            saveData();
            
            // Show results
            displayDayAnalysis(dateStr, data);
        }
        
        // Early interference detection (before save)
        function detectInterferenceEarly(modalities) {
            const critical = [];
            const warnings = [];
            const types = Object.keys(modalities);
            
            // Critical combinations
            if (types.includes('legs') && types.includes('track')) {
                critical.push({
                    message: 'Legs + Track same day = Type II fiber overload',
                    impact: 'Power output compromised 15-20%, injury risk elevated',
                    fix: 'Separate by 48hr minimum OR do track BEFORE legs'
                });
            }
            
            if (types.length >= 4 && !types.includes('walking')) {
                critical.push({
                    message: `${types.length} HIGH-INTENSITY modalities in one day`,
                    impact: 'Extreme CNS overload, recovery compromised',
                    fix: 'Split across 2 days or reduce volume by 30%'
                });
            }
            
            // Warnings
            if (types.includes('bjj') && types.includes('back')) {
                warnings.push({
                    message: 'BJJ + Back = Grip fatigue compounding',
                    impact: 'Pulling strength reduced 10-15%',
                    fix: 'Use straps or separate modalities'
                });
            }
            
            if (types.includes('chest') && types.includes('bjj')) {
                warnings.push({
                    message: 'Chest + BJJ = Pushing fatigue overlap',
                    impact: 'Both use pecs/triceps heavily',
                    fix: 'Do chest AFTER BJJ if possible'
                });
            }
            
            return { critical, warnings };
        }
        
        // ========== COLLECT TRACK EXERCISES ==========
        function collectTrackExercises() {
            const exercises = [];
            const trackExDiv = document.getElementById('track-exercises');
            if (!trackExDiv) return exercises;
            
            const exerciseBlocks = trackExDiv.querySelectorAll('.exercise-block');
            
            exerciseBlocks.forEach(block => {
                const select = block.querySelector('.exercise-name');
                const exerciseType = select ? select.value : null;
                
                if (!exerciseType) return;
                
                const fieldsDiv = block.querySelector('[id$="-fields"]');
                if (!fieldsDiv) return;
                
                const exercise = {
                    type: exerciseType,
                    name: getTrackExerciseName(exerciseType)
                };
                
                // Collect based on exercise type
                if (['distance-run', 'tempo-run', 'long-run'].includes(exerciseType)) {
                    exercise.distance = parseFloat(fieldsDiv.querySelector('.distance-amount')?.value || 0);
                    exercise.distanceUnit = fieldsDiv.querySelector('.distance-unit')?.value || 'miles';
                    exercise.time = parseFloat(fieldsDiv.querySelector('.time')?.value || 0);
                    exercise.pace = parseFloat(fieldsDiv.querySelector('.pace')?.value || 0);
                    exercise.rpe = parseFloat(fieldsDiv.querySelector('.rpe')?.value || 0);
                    exercise.category = 'running';
                }
                else if (['sprint', 'acceleration', 'flying-sprint', 'hill-sprint'].includes(exerciseType)) {
                    exercise.distance = parseFloat(fieldsDiv.querySelector('.distance-amount')?.value || 0);
                    exercise.distanceUnit = fieldsDiv.querySelector('.distance-unit')?.value || 'yards';
                    exercise.reps = parseInt(fieldsDiv.querySelector('.reps')?.value || 0);
                    exercise.rest = parseInt(fieldsDiv.querySelector('.rest')?.value || 0);
                    exercise.rpe = parseFloat(fieldsDiv.querySelector('.rpe')?.value || 0);
                    exercise.category = 'sprint';
                }
                else if (exerciseType === 'tow-sprint') {
                    exercise.weight = parseFloat(fieldsDiv.querySelector('.weight')?.value || 0);
                    exercise.distance = parseFloat(fieldsDiv.querySelector('.distance-amount')?.value || 0);
                    exercise.distanceUnit = fieldsDiv.querySelector('.distance-unit')?.value || 'yards';
                    exercise.reps = parseInt(fieldsDiv.querySelector('.reps')?.value || 0);
                    exercise.rpe = parseFloat(fieldsDiv.querySelector('.rpe')?.value || 0);
                    exercise.category = 'sprint-loaded';
                }
                else if (['box-jump', 'depth-jump', 'broad-jump', 'bounding', 'lateral-bound', 'hurdle-hop', 'tuck-jump', 'pogo-hop', 'high-knees', 'skips'].includes(exerciseType)) {
                    exercise.distance = parseFloat(fieldsDiv.querySelector('.distance-amount')?.value || 0);
                    exercise.distanceUnit = fieldsDiv.querySelector('.distance-unit')?.value || 'yards';
                    exercise.contacts = parseInt(fieldsDiv.querySelector('.contacts')?.value || 0);
                    exercise.rpe = parseFloat(fieldsDiv.querySelector('.rpe')?.value || 0);
                    exercise.category = 'plyo';
                }
                else if (exerciseType === 'single-leg-hop') {
                    exercise.distance = parseFloat(fieldsDiv.querySelector('.distance-amount')?.value || 0);
                    exercise.distanceUnit = fieldsDiv.querySelector('.distance-unit')?.value || 'yards';
                    exercise.leftJumps = parseInt(fieldsDiv.querySelector('.left-jumps')?.value || 0);
                    exercise.rightJumps = parseInt(fieldsDiv.querySelector('.right-jumps')?.value || 0);
                    exercise.contacts = exercise.leftJumps + exercise.rightJumps; // Total
                    exercise.rpe = parseFloat(fieldsDiv.querySelector('.rpe')?.value || 0);
                    exercise.category = 'plyo';
                }
                else if (exerciseType === 'sled-push') {
                    exercise.weight = parseFloat(fieldsDiv.querySelector('.weight')?.value || 0);
                    exercise.distance = parseFloat(fieldsDiv.querySelector('.distance-amount')?.value || 0);
                    exercise.distanceUnit = fieldsDiv.querySelector('.distance-unit')?.value || 'yards';
                    exercise.reps = parseInt(fieldsDiv.querySelector('.reps')?.value || 0);
                    exercise.rest = parseInt(fieldsDiv.querySelector('.rest')?.value || 0);
                    exercise.rpe = parseFloat(fieldsDiv.querySelector('.rpe')?.value || 0);
                    exercise.category = 'loaded';
                }
                else if (exerciseType === 'bear-crawl') {
                    exercise.distance = parseFloat(fieldsDiv.querySelector('.distance-amount')?.value || 0);
                    exercise.distanceUnit = fieldsDiv.querySelector('.distance-unit')?.value || 'yards';
                    exercise.time = parseInt(fieldsDiv.querySelector('.time')?.value || 0);
                    exercise.rpe = parseFloat(fieldsDiv.querySelector('.rpe')?.value || 0);
                    exercise.category = 'loaded';
                }
                
                exercises.push(exercise);
            });
            
            return exercises;
        }
        
        function getTrackExerciseName(type) {
            const names = {
                'distance-run': 'Distance Run',
                'tempo-run': 'Tempo Run',
                'long-run': 'Long Run',
                'sprint': 'Sprint',
                'acceleration': 'Acceleration',
                'flying-sprint': 'Flying Sprint',
                'hill-sprint': 'Hill Sprint',
                'tow-sprint': 'Tow Sprints',
                'box-jump': 'Box Jump',
                'depth-jump': 'Depth Jump',
                'broad-jump': 'Broad Jump',
                'bounding': 'Bounding',
                'single-leg-hop': 'Single Leg Hops',
                'lateral-bound': 'Lateral Bounds',
                'hurdle-hop': 'Hurdle Hops',
                'tuck-jump': 'Tuck Jumps',
                'pogo-hop': 'Pogo Hops',
                'high-knees': 'High Knees',
                'skips': 'Skips',
                'sled-push': 'Sled Push',
                'bear-crawl': 'Bear Crawl'
            };
            return names[type] || type;
        }
        
        async function collectModalityData(type) {
            const data = { type };
            
            if (type === 'chest' || type === 'back' || type === 'legs') {
                const exercises = [];
                const exerciseBlocks = document.querySelectorAll(`#${type}-exercises .exercise-block`);
                
                exerciseBlocks.forEach(block => {
                    const name = block.querySelector('.exercise-name').value;
                    const muscleGroup = block.querySelector('.muscle-select').value;
                    if (!name || !muscleGroup) return;
                    
                    const workingSets = [];
                    const workingWeights = block.querySelectorAll('.working-weight');
                    workingWeights.forEach((w, i) => {
                        const weight = parseFloat(w.value) || 0;
                        const reps = parseInt(block.querySelectorAll('.working-reps')[i].value) || 0;
                        const rpe = parseFloat(block.querySelectorAll('.working-rpe')[i].value) || 0;
                        if (weight > 0 && reps > 0) {
                            workingSets.push({ weight, reps, rpe });
                        }
                    });
                    
                    if (workingSets.length > 0) {
                        exercises.push({ name, muscleGroup, workingSets });
                    }
                });
                
                if (exercises.length === 0) return null;
                
                data.exercises = exercises;
                data.feeling = document.getElementById(type + '-feeling')?.value || '';
                data.sleep = parseFloat(document.getElementById(type + '-sleep')?.value) || 0;
                data.hrAnalysis = hrData[type] || null;
                
                // Calculate metrics
                const metrics = calculateWeightMetrics(data);
                Object.assign(data, metrics);
                
            } else if (type === 'track') {
                const exercises = collectTrackExercises();
                
                if (exercises.length === 0) {
                    alert('Please add at least one exercise for Track!');
                    return null;
                }
                
                data.exercises = exercises;
                data.feeling = document.getElementById('track-feeling')?.value || '';
                data.ground = document.getElementById('track-ground')?.value || '';
                data.achilles = document.getElementById('track-achilles')?.value || '';
                data.sleep = parseFloat(document.getElementById('track-sleep')?.value) || 0;
                data.hrAnalysis = hrData[type] || null;
                
                if (!data.feeling || !data.ground || !data.achilles || !data.sleep) {
                    alert('Please complete all Track session details!');
                    return null;
                }
                
                const metrics = calculateTrackMetrics(data);
                Object.assign(data, metrics);
                
            } else if (type === 'bike') {
                data.protocol = document.getElementById('bike-protocol')?.value || '';
                
                // Collect intervals
                const intervals = [];
                const rpmInputs = document.querySelectorAll('.bike-rpm');
                rpmInputs.forEach((input, i) => {
                    const rpm = parseInt(input.value) || 0;
                    const duration = parseInt(document.querySelectorAll('.bike-duration')[i].value) || 0;
                    const rest = parseInt(document.querySelectorAll('.bike-rest')[i].value) || 0;
                    const rpe = parseFloat(document.querySelectorAll('.bike-rpe')[i].value) || 0;
                    
                    if (rpm > 0 && duration > 0) {
                        intervals.push({ rpm, duration, rest, rpe });
                    }
                });
                
                if (intervals.length === 0) return null;
                
                data.intervals = intervals;
                data.breathing = document.getElementById('bike-breathing')?.value || '';
                data.feeling = document.getElementById('bike-feeling')?.value || '';
                data.sleep = parseFloat(document.getElementById('bike-sleep')?.value) || 0;
                data.hrAnalysis = hrData[type] || null;
                
                const metrics = calculateBikeMetrics(data);
                Object.assign(data, metrics);
                
            } else if (type === 'bjj') {
                data.time = parseInt(document.getElementById('bjj-time')?.value) || 0;
                data.intensity = document.getElementById('bjj-intensity')?.value || '';
                data.weightBefore = parseFloat(document.getElementById('bjj-weight-before')?.value) || 0;
                data.weightAfter = parseFloat(document.getElementById('bjj-weight-after')?.value) || 0;
                data.weightLoss = (data.weightBefore - data.weightAfter).toFixed(1);
                data.feeling = document.getElementById('bjj-feeling')?.value || '';
                data.sleep = parseFloat(document.getElementById('bjj-sleep')?.value) || 0;
                data.hrAnalysis = hrData[type] || null;
                
                const metrics = calculateBJJMetrics(data);
                Object.assign(data, metrics);
                
            } else if (type === 'walking') {
                data.duration = parseInt(document.getElementById('walking-duration')?.value) || 0;
                data.distance = parseFloat(document.getElementById('walking-distance')?.value) || 0;
                data.pace = parseFloat(document.getElementById('walking-pace')?.value) || 0;
                data.terrain = document.getElementById('walking-terrain')?.value || '';
                data.purpose = document.getElementById('walking-purpose')?.value || '';
                data.hrAnalysis = hrData[type] || null;
                
                const metrics = calculateWalkingMetrics(data);
                Object.assign(data, metrics);
            }
            
            return data;
        }
        
        // ========== METRICS CALCULATIONS ==========
        function calculateWeightMetrics(data) {
            let cnsScore = 40;
            let totalVolume = 0;
            let avgRPE = 0;
            let rpeCount = 0;
            
            data.exercises.forEach(ex => {
                ex.workingSets.forEach(set => {
                    totalVolume += set.weight * set.reps;
                    if (set.rpe) {
                        avgRPE += set.rpe;
                        rpeCount++;
                    }
                });
            });
            
            avgRPE = rpeCount > 0 ? avgRPE / rpeCount : 0;
            
            // CNS scoring
            if (data.feeling === 'beat') cnsScore += 20;
            if (data.feeling === 'tired') cnsScore += 12;
            if (data.feeling === 'great') cnsScore -= 10;
            
            if (avgRPE >= 9) cnsScore += 15;
            if (avgRPE >= 8.5) cnsScore += 10;
            if (avgRPE <= 7) cnsScore -= 8;
            
            if (data.sleep < 6.5) cnsScore += 15;
            if (data.sleep >= 8) cnsScore -= 8;
            
            // HR integration
            if (data.hrAnalysis) {
                const hr = data.hrAnalysis;
                if (hr.avgHR >= 160) cnsScore += 12;
                else if (hr.avgHR >= 150) cnsScore += 8;
                
                if (hr.recovery === 'poor') cnsScore += 10;
                else if (hr.recovery === 'good') cnsScore -= 5;
                
                if (hr.timeInZone5 > 5) cnsScore += 8;
            }
            
            // Apply personalized multiplier
            cnsScore = cnsScore * getCNSMultiplier();
            
            // TSS calculation
            const duration = 60; // Assume 60 min
            const intensity = avgRPE / 10;
            const tss = duration * intensity * 100;
            
            return {
                cnsScore: Math.max(0, Math.min(100, Math.round(cnsScore))),
                volume: totalVolume,
                avgRPE: avgRPE.toFixed(1),
                tss: Math.round(tss)
            };
        }
        
        function calculateTrackMetrics(data) {
            let cnsScore = 35;
            let totalContacts = 0;
            let maxRPE = 0;
            let avgRPE = 0;
            let rpeCount = 0;
            
            // Process exercises
            if (data.exercises && data.exercises.length > 0) {
                data.exercises.forEach(ex => {
                    // Track contacts
                    if (ex.contacts) {
                        totalContacts += ex.contacts;
                    }
                    
                    // Track RPE
                    if (ex.rpe) {
                        avgRPE += ex.rpe;
                        rpeCount++;
                        if (ex.rpe > maxRPE) maxRPE = ex.rpe;
                    }
                    
                    // CNS impact by category
                    if (ex.category === 'running') {
                        // Distance running - lower CNS
                        if (ex.distance > 5) cnsScore += 8; // Long distance
                        else if (ex.distance > 3) cnsScore += 5;
                        if (ex.pace < 7) cnsScore += 10; // Fast pace
                    }
                    else if (ex.category === 'sprint' || ex.category === 'sprint-loaded') {
                        // Sprints - high CNS
                        cnsScore += ex.reps * 3;
                        if (ex.distance >= 100) cnsScore += 5; // Longer sprints
                        if (ex.weight) cnsScore += ex.weight * 0.2; // Tow weight
                    }
                    else if (ex.category === 'plyo') {
                        // Plyos - very high CNS
                        cnsScore += ex.contacts * 0.15;
                        if (['depth-jump', 'box-jump'].includes(ex.type)) {
                            cnsScore += 5; // High impact plyos
                        }
                    }
                    else if (ex.category === 'loaded') {
                        // Sled/bear crawl - moderate CNS
                        cnsScore += ex.reps ? ex.reps * 2 : 5;
                        if (ex.weight) cnsScore += ex.weight * 0.15;
                    }
                });
                
                if (rpeCount > 0) avgRPE = avgRPE / rpeCount;
            }
            
            // Overall factors
            if (data.feeling === 'beat') cnsScore += 20;
            else if (data.feeling === 'flat') cnsScore += 12;
            
            if (data.ground === 'heavy') cnsScore += 15;
            
            if (data.achilles === 'sore') cnsScore += 20;
            else if (data.achilles === 'tight') cnsScore += 10;
            
            if (data.sleep < 7) cnsScore += 12;
            
            // HR integration
            if (data.hrAnalysis) {
                const hr = data.hrAnalysis;
                if (hr.avgHR >= 170) cnsScore += 10;
                if (hr.timeInZone5 > 10) cnsScore += 12;
                if (hr.recovery === 'poor') cnsScore += 8;
            }
            
            // Apply personalized multiplier
            cnsScore = cnsScore * getCNSMultiplier();
            
            // TSS calculation
            const tss = 50 + (totalContacts * 0.15) + (avgRPE * 10) + (data.exercises ? data.exercises.length * 5 : 0);
            
            return {
                cnsScore: Math.max(0, Math.min(100, Math.round(cnsScore))),
                volume: 0,
                tss: Math.round(tss),
                totalContacts,
                exerciseCount: data.exercises ? data.exercises.length : 0,
                maxRPE,
                avgRPE: avgRPE.toFixed(1)
            };
        }
        
        function calculateBikeMetrics(data) {
            let cnsScore = 45;
            
            // Calculate from intervals
            let totalTime = 0;
            let avgRPM = 0;
            let peakRPM = 0;
            let avgRPE = 0;
            let rpeCount = 0;
            
            if (data.intervals && data.intervals.length > 0) {
                data.intervals.forEach(int => {
                    totalTime += int.duration / 60; // Convert to minutes
                    avgRPM += int.rpm;
                    if (int.rpm > peakRPM) peakRPM = int.rpm;
                    if (int.rpe) {
                        avgRPE += int.rpe;
                        rpeCount++;
                    }
                });
                avgRPM = avgRPM / data.intervals.length;
                if (rpeCount > 0) avgRPE = avgRPE / rpeCount;
            }
            
            // CNS based on RPM and RPE
            if (peakRPM >= 130) cnsScore += 15;
            else if (peakRPM >= 120) cnsScore += 10;
            
            if (avgRPE >= 9) cnsScore += 12;
            else if (avgRPE >= 8) cnsScore += 8;
            
            if (data.breathing === 'labored') cnsScore += 20;
            else if (data.breathing === 'moderate') cnsScore += 10;
            
            if (data.feeling === 'beat') cnsScore += 18;
            else if (data.feeling === 'tired') cnsScore += 10;
            
            if (data.sleep < 7) cnsScore += 10;
            
            if (data.hrAnalysis) {
                const hr = data.hrAnalysis;
                if (hr.avgHR >= 170) cnsScore += 12;
                if (hr.timeInZone5 > 15) cnsScore += 15;
                if (hr.recovery === 'poor') cnsScore += 8;
            }
            
            // Apply personalized multiplier
            cnsScore = cnsScore * getCNSMultiplier();
            
            // TSS calculation
            const tss = totalTime * 2 + (data.intervals.length * 5) + (avgRPE * 8);
            
            return {
                cnsScore: Math.max(0, Math.min(100, Math.round(cnsScore))),
                volume: 0,
                tss: Math.round(tss),
                peakRPM: peakRPM,
                avgRPM: Math.round(avgRPM),
                totalTime: totalTime.toFixed(1)
            };
        }
        
        function calculateBJJMetrics(data) {
            let cnsScore = 40;
            const sweat = parseFloat(data.weightLoss) || 0;
            
            if (sweat >= 4) cnsScore += 20;
            else if (sweat >= 3) cnsScore += 10;
            
            if (data.intensity === 'high') cnsScore += 15;
            if (data.feeling === 'beat') cnsScore += 20;
            if (data.feeling === 'tired') cnsScore += 12;
            if (data.sleep < 7) cnsScore += 10;
            
            if (data.hrAnalysis) {
                const hr = data.hrAnalysis;
                if (hr.avgHR >= 160) cnsScore += 10;
                if (hr.timeInZone5 > 20) cnsScore += 12;
            }
            
            // Apply personalized multiplier
            cnsScore = cnsScore * getCNSMultiplier();
            
            const tss = data.time * 1.5 + (data.intensity === 'high' ? 30 : 0);
            
            return {
                cnsScore: Math.max(0, Math.min(100, Math.round(cnsScore))),
                volume: 0,
                tss: Math.round(tss)
            };
        }
        
        function calculateWalkingMetrics(data) {
            let cnsScore = 10; // Very low CNS stress
            
            if (data.terrain === 'steep') cnsScore += 15;
            else if (data.terrain === 'hills') cnsScore += 8;
            
            if (data.purpose === 'zone2' && data.hrAnalysis) {
                const hr = data.hrAnalysis;
                if (hr.timeInZone3 > hr.timeInZone2) {
                    cnsScore += 10; // Went too hard for recovery
                }
            }
            
            // Apply personalized multiplier
            cnsScore = cnsScore * getCNSMultiplier();
            
            const tss = data.duration * 0.5; // Low stress
            
            return {
                cnsScore: Math.max(0, Math.min(100, Math.round(cnsScore))),
                volume: 0,
                tss: Math.round(tss)
            };
        }
        
        // ========== QUALITY ANALYSIS ==========
        function analyzeQualities(modalities) {
            const qualities = {
                strength: 0,
                hypertrophy: 0,
                power: 0,
                speed: 0,
                endurance: 0
            };
            
            Object.keys(modalities).forEach(type => {
                const mod = modalities[type];
                
                if (type === 'chest' || type === 'back' || type === 'legs') {
                    if (mod.exercises) {
                        mod.exercises.forEach(ex => {
                            ex.workingSets.forEach(set => {
                                if (set.reps <= 5) {
                                    qualities.strength += set.reps * (set.rpe || 8);
                                } else if (set.reps <= 8) {
                                    qualities.strength += set.reps * 0.6 * (set.rpe || 8);
                                    qualities.hypertrophy += set.reps * 0.4 * (set.rpe || 8);
                                } else {
                                    qualities.hypertrophy += set.reps * (set.rpe || 8);
                                }
                            });
                        });
                    }
                } else if (type === 'track') {
                    qualities.power = mod.contacts * 0.8;
                    qualities.power += (mod.maxJumps || 0) * 20;
                    qualities.speed = (mod.sprints || 0) * 25;
                } else if (type === 'bike') {
                    qualities.endurance = 80;
                    if (mod.protocol === 'zone5' || mod.protocol === 'peak-rpm') {
                        qualities.power = 40;
                    }
                } else if (type === 'bjj') {
                    qualities.endurance = 50;
                    if (mod.intensity === 'high') {
                        qualities.power = 30;
                        qualities.strength = 20;
                    }
                } else if (type === 'walking') {
                    qualities.endurance = 30; // Low intensity recovery
                }
            });
            
            // Normalize
            const total = Object.values(qualities).reduce((a, b) => a + b, 0);
            if (total > 0) {
                Object.keys(qualities).forEach(q => {
                    qualities[q] = Math.round((qualities[q] / total) * 100);
                });
            }
            
            return qualities;
        }
        
        function detectInterference(modalities, qualities) {
            const issues = [];
            const types = Object.keys(modalities);
            
            // Check for problematic combinations
            if (types.includes('legs') && types.includes('track')) {
                issues.push({
                    severity: 'critical',
                    message: 'Legs + Track same day = Type II fiber overload',
                    impact: 'Power output compromised 15-20%, injury risk elevated',
                    fix: 'Separate by 48hr minimum'
                });
            }
            
            if (types.includes('bjj') && types.includes('back')) {
                issues.push({
                    severity: 'moderate',
                    message: 'BJJ + Back = Grip fatigue compounding',
                    impact: 'Pulling strength reduced 10-15%',
                    fix: 'Use straps or separate modalities'
                });
            }
            
            if (types.length >= 4) {
                issues.push({
                    severity: 'high',
                    message: `${types.length} modalities in one day = Extreme volume`,
                    impact: 'CNS overload, recovery compromised',
                    fix: 'Consider splitting across 2 days or reducing volume'
                });
            }
            
            return issues;
        }
        
        // ========== DAY ANALYSIS DISPLAY ==========
        function displayDayAnalysis(dateStr, data) {
            closeModal();
            renderCalendar();
            
            const modalityList = Object.keys(data.modalities).map(t => t.toUpperCase()).join(', ');
            
            let html = `
                <div class="modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">‚úì Training Saved!</div>
                            <button class="close-btn" onclick="closeModal()">‚úï Close</button>
                        </div>
                        
                        <div class="success-box">
                            <h3 style="color: #00ff88;">TRAINING COMPLETE: ${dateStr}</h3>
                            <p><strong>Modalities:</strong> ${modalityList}</p>
                        </div>
                        
                        <div class="metrics-grid">
                            <div class="metric-card">
                                <div class="metric-value">${data.totalCNS}</div>
                                <div class="metric-label">Total CNS Load</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value">${data.totalVolume.toLocaleString()}</div>
                                <div class="metric-label">Volume (lbs)</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value">${data.tss}</div>
                                <div class="metric-label">Training Stress Score</div>
                            </div>
                        </div>
                        
                        <div class="info-box">
                            <h3 style="color: #00ccff;">TRAINING QUALITIES</h3>
                            ${Object.keys(data.qualities).filter(q => data.qualities[q] >= 20).map(q => 
                                `<p><strong>${q.charAt(0).toUpperCase() + q.slice(1)}:</strong> ${data.qualities[q]}%</p>`
                            ).join('')}
                        </div>
            `;
            
            if (data.interference && data.interference.length > 0) {
                html += `<div class="warning-box"><h3>‚ö†Ô∏è INTERFERENCE DETECTED</h3>`;
                data.interference.forEach(issue => {
                    html += `
                        <div style="margin-bottom: 15px;">
                            <p><strong>${issue.message}</strong></p>
                            <p style="color: #ff6666;">Impact: ${issue.impact}</p>
                            <p style="color: #00ff88;">Fix: ${issue.fix}</p>
                        </div>
                    `;
                });
                html += `</div>`;
            }
            
            html += `</div></div>`;
            
            document.getElementById('day-modal').innerHTML = html;
            document.getElementById('day-modal').classList.remove('hidden');
        }
        
        // ========== WEEKLY ANALYSIS ==========
        function showWeeklyAnalysis() {
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - 6);
            
            let totalCNS = 0;
            let totalVolume = 0;
            let totalTSS = 0;
            let days = 0;
            const dailyCNS = [];
            const dailyTSS = [];
            const workoutDates = [];
            
            for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                const dateStr = formatDate(d);
                const dayData = trainingData[dateStr];
                
                if (dayData && dayData.modalities && Object.keys(dayData.modalities).length > 0) {
                    days++;
                    totalCNS += dayData.totalCNS || 0;
                    totalVolume += dayData.totalVolume || 0;
                    totalTSS += dayData.tss || 0;
                    dailyCNS.push(dayData.totalCNS || 0);
                    dailyTSS.push(dayData.tss || 0);
                    workoutDates.push(dateStr);
                }
            }
            
            const avgCNS = days > 0 ? Math.round(totalCNS / days) : 0;
            const avgTSS = days > 0 ? Math.round(totalTSS / days) : 0;
            
            // Monotony
            const mean = avgCNS;
            const variance = dailyCNS.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / (dailyCNS.length || 1);
            const stdDev = Math.sqrt(variance);
            const monotony = stdDev > 0 ? (mean / stdDev).toFixed(2) : 0;
            
            // Strain
            const strain = Math.round(totalCNS * parseFloat(monotony));
            
            // A:C Ratio
            const last28Days = historicalTSS.slice(-28);
            let acRatio = '‚Äî';
            let acWarning = false;
            const acThreshold = getACThreshold();
            if (last28Days.length >= 14) {
                const chronicTSS = last28Days.reduce((a, b) => a + b.tss, 0) / last28Days.length;
                if (chronicTSS > 0) {
                    acRatio = (totalTSS / (chronicTSS * 7)).toFixed(2);
                    if (parseFloat(acRatio) > acThreshold) acWarning = true;
                }
            }
            
            // Fitness-Fatigue Model
            const fitnessFatigue = calculateFitnessFatigue(historicalTSS);
            
            // Recovery Status
            const recoveryStatus = assessRecoveryStatus(dailyCNS, days);
            
            // Performance Prediction
            const performancePrediction = predictPerformance(fitnessFatigue, acRatio, recoveryStatus);
            
            const html = `
                <div class="modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">üìä WEEKLY ANALYSIS</div>
                            <button class="close-btn" onclick="closeModal()">‚úï Close</button>
                        </div>
                        
                        <p style="color: #888; margin-bottom: 10px;">${startDate.toLocaleDateString()} - ${endDate.toLocaleDateString()} (${days} training days)</p>
                        
                        ${userProfile ? `
                            <div style="background: rgba(0, 255, 136, 0.1); padding: 12px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #00ff88;">
                                <p style="color: #00ff88; font-size: 14px; margin: 0;">
                                    <strong>Personalized for:</strong> ${getTrainingLevel()} Athlete (${userProfile.trainingAge}yr experience) ‚Ä¢ 
                                    Your A:C Threshold: ${acThreshold} ‚Ä¢ 
                                    Your CNS Multiplier: ${getCNSMultiplier()}x
                                </p>
                            </div>
                        ` : `
                            <div style="background: rgba(255, 107, 53, 0.1); padding: 12px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #ff6b35;">
                                <p style="color: #ff6b35; font-size: 14px; margin: 0;">
                                    ‚ö†Ô∏è <strong>Using generic thresholds.</strong> <a href="#" onclick="showProfile(); return false;" style="color: #00ff88; text-decoration: underline;">Set up your profile</a> for personalized metrics!
                                </p>
                            </div>
                        `}
                        
                        <h3 style="color: #00ff88; margin-bottom: 15px;">LOAD METRICS:</h3>
                        
                        <div class="metrics-grid">
                            <div class="metric-card" style="border-left-color: #00ff88;">
                                <div class="metric-value">${totalVolume.toLocaleString()}</div>
                                <div class="metric-label">Total Volume (lbs)</div>
                            </div>
                            <div class="metric-card" style="border-left-color: #00ccff;">
                                <div class="metric-value">${avgCNS}</div>
                                <div class="metric-label">Avg Daily CNS</div>
                            </div>
                            <div class="metric-card" style="border-left-color: #ffaa00;">
                                <div class="metric-value">${totalTSS}</div>
                                <div class="metric-label">Weekly TSS</div>
                            </div>
                            <div class="metric-card" style="border-left-color: ${acWarning ? '#ff4444' : '#ff6b35'};">
                                <div class="metric-value" style="color: ${acWarning ? '#ff4444' : '#00ff88'};">${acRatio}</div>
                                <div class="metric-label">Acute:Chronic Ratio</div>
                            </div>
                            <div class="metric-card" style="border-left-color: #8a2be2;">
                                <div class="metric-value">${monotony}</div>
                                <div class="metric-label">Monotony Index</div>
                            </div>
                            <div class="metric-card" style="border-left-color: #ff69b4;">
                                <div class="metric-value">${strain}</div>
                                <div class="metric-label">Strain Index</div>
                            </div>
                        </div>
                        
                        <h3 style="color: #00ff88; margin: 30px 0 15px 0;">FITNESS-FATIGUE MODEL:</h3>
                        
                        <div class="metrics-grid">
                            <div class="metric-card" style="border-left-color: #00ff88;">
                                <div class="metric-value">${fitnessFatigue.fitness}</div>
                                <div class="metric-label">Fitness ${fitnessFatigue.fitnessChange > 0 ? '‚Üë' : '‚Üì'}</div>
                            </div>
                            <div class="metric-card" style="border-left-color: #ff6b35;">
                                <div class="metric-value">${fitnessFatigue.fatigue}</div>
                                <div class="metric-label">Fatigue ${fitnessFatigue.fatigueChange > 0 ? '‚Üë' : '‚Üì'}</div>
                            </div>
                            <div class="metric-card" style="border-left-color: #00ccff;">
                                <div class="metric-value" style="color: ${fitnessFatigue.performance > 0 ? '#00ff88' : '#ff4444'};">${fitnessFatigue.performance > 0 ? '+' : ''}${fitnessFatigue.performance}</div>
                                <div class="metric-label">Performance</div>
                            </div>
                            <div class="metric-card" style="border-left-color: ${recoveryStatus.color};">
                                <div class="metric-value" style="color: ${recoveryStatus.color}; font-size: 20px;">${recoveryStatus.status}</div>
                                <div class="metric-label">Recovery Status</div>
                            </div>
                        </div>
                        
                        ${performancePrediction.html}
                        
                        ${acWarning ? `
                            <div class="warning-box">
                                <h3>‚ö†Ô∏è INJURY RISK WARNING</h3>
                                <p><strong>Acute:Chronic ratio: ${acRatio}</strong> (YOUR threshold: ${acThreshold})</p>
                                <p>This week's training load is ${((parseFloat(acRatio) / acThreshold - 1) * 100).toFixed(0)}% above YOUR safe threshold</p>
                                <p><strong>IMMEDIATE ACTIONS:</strong></p>
                                <ul style="margin-left: 20px; margin-top: 10px;">
                                    <li>Reduce volume by 20-25% next week</li>
                                    <li>Add 1-2 extra rest/walking days</li>
                                    <li>Focus on sleep (8+ hours), nutrition, mobility</li>
                                    <li>Monitor: elevated resting HR, mood changes, persistent fatigue</li>
                                    <li>Consider deload week if symptoms present</li>
                                </ul>
                            </div>
                        ` : `
                            <div class="success-box">
                                <h3>‚úì TRAINING LOAD OPTIMAL</h3>
                                <p>Your acute:chronic ratio (${acRatio}) is within YOUR safe range (<${acThreshold})</p>
                                <p>Continue current training approach while monitoring recovery markers</p>
                            </div>
                        `}
                        
                        <div class="info-box">
                            <h3 style="color: #00ccff;">METRIC INTERPRETATION:</h3>
                            <p><strong>TSS:</strong> Training Stress Score - cumulative training load</p>
                            <p><strong>A:C Ratio:</strong> This week vs 4-week average. 0.8-1.3 = optimal. >1.5 = high injury risk</p>
                            <p><strong>Monotony:</strong> Training variation. Lower = better. High monotony + high strain = overtraining</p>
                            <p><strong>Fitness:</strong> Adaptations from training (builds slowly over weeks)</p>
                            <p><strong>Fatigue:</strong> Accumulated stress (dissipates quickly with rest)</p>
                            <p><strong>Performance:</strong> Fitness minus fatigue. Positive = peak ready. Negative = need recovery</p>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('weekly-modal').innerHTML = html;
            document.getElementById('weekly-modal').classList.remove('hidden');
        }
        
        // Calculate Fitness-Fatigue Model (Banister Model)
        function calculateFitnessFatigue(tssHistory) {
            if (tssHistory.length < 7) {
                return { fitness: 0, fatigue: 0, performance: 0, fitnessChange: 0, fatigueChange: 0 };
            }
            
            // Fitness decay constant (42 days)
            // Fatigue decay constant (7 days)
            const fitnessDecay = 42;
            const fatigueDecay = 7;
            
            let fitness = 0;
            let fatigue = 0;
            
            // Calculate using exponential weighted average
            tssHistory.forEach((entry, i) => {
                const daysAgo = tssHistory.length - i - 1;
                fitness += entry.tss * Math.exp(-daysAgo / fitnessDecay);
                fatigue += entry.tss * Math.exp(-daysAgo / fatigueDecay);
            });
            
            // Previous week for comparison
            const prevWeekStart = Math.max(0, tssHistory.length - 14);
            const prevWeekEnd = Math.max(0, tssHistory.length - 7);
            const prevWeekData = tssHistory.slice(prevWeekStart, prevWeekEnd);
            
            let prevFitness = 0;
            let prevFatigue = 0;
            prevWeekData.forEach((entry, i) => {
                const daysAgo = prevWeekData.length - i - 1;
                prevFitness += entry.tss * Math.exp(-daysAgo / fitnessDecay);
                prevFatigue += entry.tss * Math.exp(-daysAgo / fatigueDecay);
            });
            
            const performance = Math.round(fitness - fatigue);
            const fitnessChange = Math.round(fitness - prevFitness);
            const fatigueChange = Math.round(fatigue - prevFatigue);
            
            return {
                fitness: Math.round(fitness),
                fatigue: Math.round(fatigue),
                performance,
                fitnessChange,
                fatigueChange
            };
        }
        
        // Assess recovery status
        function assessRecoveryStatus(dailyCNS, days) {
            if (days === 0) return { status: 'UNKNOWN', color: '#888' };
            
            const avgCNS = dailyCNS.reduce((a, b) => a + b, 0) / days;
            const recentCNS = dailyCNS.slice(-2); // Last 2 workouts
            const recentAvg = recentCNS.reduce((a, b) => a + b, 0) / recentCNS.length;
            
            // Check for upward trend (getting worse)
            const trend = recentAvg - avgCNS;
            
            if (avgCNS > 80 || trend > 15) {
                return { status: 'POOR', color: '#ff4444' };
            } else if (avgCNS > 70 || trend > 10) {
                return { status: 'MODERATE', color: '#ffaa00' };
            } else if (avgCNS > 60) {
                return { status: 'GOOD', color: '#00ccff' };
            } else {
                return { status: 'EXCELLENT', color: '#00ff88' };
            }
        }
        
        // Predict next week performance
        function predictPerformance(fitnessFatigue, acRatio, recoveryStatus) {
            let recommendations = [];
            let nextWeekForecast = '';
            
            const perf = fitnessFatigue.performance;
            const acNum = parseFloat(acRatio);
            
            if (perf > 20 && recoveryStatus.status === 'EXCELLENT' && acNum < 1.2) {
                nextWeekForecast = 'PEAK PERFORMANCE';
                recommendations.push('Perfect time for PRs and max effort tests');
                recommendations.push('Consider testing 1RMs or competition');
                recommendations.push('Maintain current load, avoid increasing volume');
            } else if (perf > 0 && recoveryStatus.status !== 'POOR') {
                nextWeekForecast = 'GOOD STATE';
                recommendations.push('Continue progressive overload');
                recommendations.push('Can increase intensity slightly (2-5%)');
                recommendations.push('Monitor recovery markers closely');
            } else if (perf < 0 && perf > -15) {
                nextWeekForecast = 'FATIGUE BUILDING';
                recommendations.push('Reduce volume by 15-20%');
                recommendations.push('Add extra rest day or walking');
                recommendations.push('Focus on technique, reduce intensity');
            } else if (perf <= -15) {
                nextWeekForecast = 'DELOAD NEEDED';
                recommendations.push('MANDATORY deload week (50% volume reduction)');
                recommendations.push('No CNS > 65 sessions');
                recommendations.push('Focus on recovery: sleep, nutrition, mobility');
                recommendations.push('Walking and light BJJ only');
            }
            
            const html = `
                <div class="${perf > 0 ? 'success-box' : 'warning-box'}">
                    <h3 style="color: ${perf > 0 ? '#00ff88' : '#ff6b35'};">üìà NEXT WEEK FORECAST: ${nextWeekForecast}</h3>
                    <p style="margin-bottom: 10px;"><strong>Performance Index:</strong> ${fitnessFatigue.performance} (${perf > 0 ? 'Ready for hard training' : 'Need recovery'})</p>
                    <p style="font-weight: bold; margin-bottom: 10px;">RECOMMENDATIONS:</p>
                    <ul style="margin-left: 20px;">
                        ${recommendations.map(r => `<li>${r}</li>`).join('')}
                    </ul>
                </div>
            `;
            
            return { html, forecast: nextWeekForecast, recommendations };
        }
        
        // ========== PROFILE SYSTEM ==========
        function showProfile() {
            const isNew = !userProfile;
            const profile = userProfile || {};
            
            const html = `
                <div class="modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">üë§ ${isNew ? 'CREATE' : 'EDIT'} YOUR PROFILE</div>
                            <button class="close-btn" onclick="closeModal()">‚úï Close</button>
                        </div>
                        
                        <div class="${isNew ? 'warning-box' : 'info-box'}">
                            <h3>${isNew ? '‚ö†Ô∏è PROFILE REQUIRED FOR ACCURATE TRACKING' : '‚úèÔ∏è UPDATE YOUR PROFILE'}</h3>
                            <p>${isNew ? 'Your age, sex, training experience, and other factors significantly affect CNS calculations, recovery times, and injury risk thresholds. Set your profile for personalized recommendations!' : 'Keep your profile updated as you progress!'}</p>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 30px;">
                            
                            <div class="question">
                                <label>Age (years) *</label>
                                <input type="number" id="profile-age" value="${profile.age || ''}" placeholder="32">
                            </div>
                            
                            <div class="question">
                                <label>Sex *</label>
                                <select id="profile-sex">
                                    <option value="">Choose...</option>
                                    <option value="male" ${profile.sex === 'male' ? 'selected' : ''}>Male</option>
                                    <option value="female" ${profile.sex === 'female' ? 'selected' : ''}>Female</option>
                                </select>
                            </div>
                            
                            <div class="question">
                                <label>Bodyweight (lbs) *</label>
                                <input type="number" id="profile-weight" value="${profile.bodyweight || ''}" step="0.1" placeholder="185">
                            </div>
                            
                            <div class="question">
                                <label>Training Age (years) *</label>
                                <input type="number" id="profile-training-age" value="${profile.trainingAge || ''}" step="0.5" placeholder="8.0">
                                <p style="color: #666; font-size: 12px; margin-top: 5px;">Years of consistent training experience</p>
                            </div>
                            
                            <div class="question">
                                <label>Max Heart Rate (bpm)</label>
                                <input type="number" id="profile-maxhr" value="${profile.maxHR || ''}" placeholder="188">
                                <p style="color: #666; font-size: 12px; margin-top: 5px;">Tested or estimated (220 - age)</p>
                            </div>
                            
                            <div class="question">
                                <label>Primary Goal</label>
                                <select id="profile-goal">
                                    <option value="">Choose...</option>
                                    <option value="strength" ${profile.goal === 'strength' ? 'selected' : ''}>Strength</option>
                                    <option value="hypertrophy" ${profile.goal === 'hypertrophy' ? 'selected' : ''}>Hypertrophy (Muscle)</option>
                                    <option value="endurance" ${profile.goal === 'endurance' ? 'selected' : ''}>Endurance</option>
                                    <option value="bjj" ${profile.goal === 'bjj' ? 'selected' : ''}>BJJ Performance</option>
                                    <option value="hybrid" ${profile.goal === 'hybrid' ? 'selected' : ''}>Hybrid (All)</option>
                                </select>
                            </div>
                            
                        </div>
                        
                        <div class="info-box" style="margin-top: 30px;">
                            <h3 style="color: #00ccff;">HOW THIS AFFECTS YOUR TRACKING:</h3>
                            <p><strong>Age:</strong> Recovery time adjustments (30+ = +20%, 40+ = +40%)</p>
                            <p><strong>Sex:</strong> Males = faster recovery per session. Females = less fatigue accumulation, higher frequency tolerance</p>
                            <p><strong>Bodyweight:</strong> Calculates relative strength (weight lifted √∑ bodyweight)</p>
                            <p><strong>Training Age:</strong></p>
                            <ul style="margin-left: 20px; margin-top: 5px;">
                                <li>Beginner (0-2yr): CNS √ó1.2, A:C threshold 1.2, +50% recovery</li>
                                <li>Intermediate (2-5yr): CNS √ó1.0, A:C threshold 1.3, standard recovery</li>
                                <li>Advanced (5-10yr): CNS √ó0.85, A:C threshold 1.5, -20% recovery</li>
                                <li>Elite (10+yr): CNS √ó0.75, A:C threshold 1.7, -20% recovery</li>
                            </ul>
                            <p><strong>Max HR:</strong> Personalizes HR zones (Z5=90-100% YOUR max, not generic)</p>
                            <p><strong>Goal:</strong> Future feature - will adjust training recommendations</p>
                        </div>
                        
                        <button onclick="saveProfile()" style="background: linear-gradient(135deg, #00ff88, #00ccff); border: none; color: #000; padding: 20px; border-radius: 10px; font-size: 18px; font-weight: bold; cursor: pointer; width: 100%; margin-top: 30px;">
                            ‚úì SAVE PROFILE & PERSONALIZE SYSTEM
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('day-modal').innerHTML = html;
            document.getElementById('day-modal').classList.remove('hidden');
        }
        
        function saveProfile() {
            const age = parseInt(document.getElementById('profile-age').value);
            const sex = document.getElementById('profile-sex').value;
            const bodyweight = parseFloat(document.getElementById('profile-weight').value);
            const trainingAge = parseFloat(document.getElementById('profile-training-age').value);
            const maxHR = parseInt(document.getElementById('profile-maxhr').value);
            const goal = document.getElementById('profile-goal').value;
            
            // Validation
            if (!age || !sex || !bodyweight || trainingAge === undefined) {
                alert('Please fill in all required fields (Age, Sex, Bodyweight, Training Age)');
                return;
            }
            
            if (age < 15 || age > 100) {
                alert('Please enter a valid age (15-100)');
                return;
            }
            
            if (trainingAge < 0 || trainingAge > 50) {
                alert('Please enter a valid training age (0-50 years)');
                return;
            }
            
            // Create profile
            userProfile = {
                age,
                sex,
                bodyweight,
                trainingAge,
                maxHR: maxHR || Math.round(220 - age), // Use formula if not provided
                goal: goal || 'hybrid',
                created: new Date().toISOString()
            };
            
            saveData();
            closeModal();
            updateProfileSummary();
            
            alert(`‚úì Profile Saved!\n\nTraining Level: ${getTrainingLevel()}\nCNS Multiplier: ${getCNSMultiplier()}x\nA:C Threshold: ${getACThreshold()}\nRecovery Multiplier: ${getRecoveryMultiplier().toFixed(2)}x\n\nAll metrics are now personalized for YOU!`);
        }
        
        function updateProfileSummary() {
            const summaryDiv = document.getElementById('profile-summary');
            const profileBtn = document.getElementById('profile-btn');
            
            if (!userProfile) {
                summaryDiv.style.display = 'none';
                profileBtn.innerHTML = 'üë§ CREATE PROFILE';
                profileBtn.style.background = 'linear-gradient(135deg, #ff4444, #ff6b35)';
                return;
            }
            
            profileBtn.innerHTML = 'üë§ PROFILE';
            profileBtn.style.background = 'linear-gradient(135deg, #00ff88, #00ccff)';
            
            const hrZones = getHRZones();
            const level = getTrainingLevel();
            const thresholds = getCNSThresholds();
            
            summaryDiv.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                    <div>
                        <p style="color: #00ff88; font-weight: bold; margin-bottom: 5px;">
                            ${userProfile.sex === 'male' ? 'üë®' : 'üë©'} ${userProfile.age}yo ‚Ä¢ 
                            ${userProfile.bodyweight}lbs ‚Ä¢ 
                            ${userProfile.trainingAge}yr training ‚Ä¢ 
                            <span style="color: #00ccff;">${level}</span>
                        </p>
                        <p style="color: #888; font-size: 13px;">
                            CNS Thresholds: <${thresholds.low} (low) | ${thresholds.low}-${thresholds.moderate} (mod) | >${thresholds.moderate} (high) ‚Ä¢ 
                            A:C Threshold: ${getACThreshold()} ‚Ä¢ 
                            Max HR: ${userProfile.maxHR} (Z5: ${hrZones.z5.min}-${hrZones.z5.max})
                        </p>
                    </div>
                    <button onclick="showProfile()" style="background: #333; border: 1px solid #00ff88; color: #00ff88; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: bold;">
                        ‚úèÔ∏è Edit
                    </button>
                </div>
            `;
            summaryDiv.style.display = 'block';
        }
        
        // ========== INIT ==========
        window.onload = function() {
            loadData();
            initializeTrainingBlock();
            updateProfileSummary();
            renderCalendar();
            
            // Add block status display after calendar header
            setTimeout(() => {
                const calendarSection = document.querySelector('.calendar-section');
                if (calendarSection) {
                    const blockDiv = document.createElement('div');
                    blockDiv.id = 'block-status-container';
                    blockDiv.innerHTML = getBlockStatusHTML();
                    calendarSection.insertBefore(blockDiv, calendarSection.firstChild);
                }
            }, 100);
            
            // Show profile modal if no profile set
            if (!userProfile) {
                setTimeout(() => {
                    if (confirm('Welcome! Would you like to set up your profile now for personalized tracking?\n\n(Age, training experience, and other factors affect CNS calculations and injury prevention)')) {
                        showProfile();
                    }
                }, 500);
            }
        };
    </script>
</body>
</html>
