<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Elite Athlete Training System - Complete</title>
<style>
  * { margin:0; padding:0; box-sizing:border-box; }
  body { font-family:-apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif; background:#0a0a0a; color:#fff; padding:20px; line-height:1.6; }
  .container { max-width:1600px; margin:0 auto; }
  h1 { text-align:center; font-size:42px; margin-bottom:10px; background:linear-gradient(to right,#ff6b35,#00ff88,#00ccff); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
  .subtitle { text-align:center; color:#666; margin-bottom:30px; font-size:16px; }

  .calendar-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; padding:20px; background:#1a1a1a; border-radius:12px; flex-wrap:wrap; gap:15px; }
  .calendar-nav button { background:#333; border:none; color:#fff; padding:12px 24px; border-radius:6px; cursor:pointer; margin:0 5px; font-weight:bold; }
  .calendar-nav button:hover { background:#444; }
  .month-title { font-size:28px; color:#00ff88; font-weight:bold; }
  .analysis-btn { background:linear-gradient(135deg,#00ff88,#00ccff); color:#000; padding:12px 24px; border-radius:8px; border:none; cursor:pointer; font-weight:bold; font-size:14px; }
  .analysis-btn:hover { transform:translateY(-2px); }

  .calendar-grid { display:grid; grid-template-columns:repeat(7,1fr); gap:8px; margin-bottom:30px; }
  .calendar-day-header { text-align:center; padding:12px; color:#888; font-weight:bold; font-size:14px; }
  .calendar-day { background:#1a1a1a; border:2px solid #333; border-radius:8px; padding:12px; min-height:140px; cursor:pointer; transition:all .3s; position:relative; }
  .calendar-day:hover { border-color:#666; transform:translateY(-2px); }
  .calendar-day.other-month{ opacity:.3; }
  .calendar-day.today{ border-color:#00ff88; box-shadow:0 0 25px rgba(0,255,136,.4); background:rgba(0,255,136,.05); }
  .calendar-day.has-workouts{ border-color:#00ccff; background:rgba(0,204,255,.1); }
  .day-number{ font-size:18px; font-weight:bold; margin-bottom:8px; color:#fff; }
  .day-workouts{ font-size:11px; color:#aaa; }
  .workout-badge{ display:inline-block; padding:3px 8px; margin:2px; background:rgba(0,255,136,.2); border-radius:4px; font-size:10px; font-weight:bold; }
  .cns-indicator{ position:absolute; top:8px; right:8px; width:16px; height:16px; border-radius:50%; border:2px solid #000; }
  .cns-low{ background:#00ff88; } .cns-moderate{ background:#ffaa00; } .cns-high{ background:#ff4444; }

  .modal{ position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,.95); z-index:1000; overflow-y:auto; padding:20px; }
  .modal-content{ max-width:1400px; margin:0 auto; background:#0a0a0a; border-radius:12px; padding:40px; border:3px solid #00ff88; }
  .modal-header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:30px; flex-wrap:wrap; gap:15px; }
  .modal-title{ font-size:32px; color:#00ff88; }
  .close-btn{ background:#ff4444; border:none; color:#fff; padding:12px 24px; border-radius:6px; cursor:pointer; font-weight:bold; }
  .close-btn:hover{ background:#ff6666; }

  .modality-checkboxes{ display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:12px; margin-bottom:30px; padding:25px; background:#1a1a1a; border-radius:12px; }
  .modality-checkbox{ display:flex; align-items:center; gap:12px; padding:15px; background:#0a0a0a; border:2px solid #333; border-radius:8px; cursor:pointer; transition:all .3s; }
  .modality-checkbox:hover{ border-color:#666; }
  .modality-checkbox.checked{ border-color:#00ff88; background:rgba(0,255,136,.1); }
  .modality-section{ background:#1a1a1a; border:2px solid #00ccff; border-radius:12px; padding:30px; margin-bottom:20px; }
  .modality-section h2{ color:#00ccff; margin-bottom:20px; font-size:24px; }

  .exercise-block{ background:#0a0a0a; border:1px solid #333; padding:20px; border-radius:8px; margin-bottom:15px; }
  .set-label{ color:#888; font-size:14px; margin:15px 0 8px; font-weight:bold; }
  .set-row{ display:grid; grid-template-columns:1fr 1fr 1fr 40px; gap:8px; margin-bottom:8px; }
  .delete-btn{ background:transparent; border:none; color:#ff4444; font-size:20px; cursor:pointer; padding:0; }

  input, select, textarea{ width:100%; padding:12px; border:2px solid #333; border-radius:6px; background:#0a0a0a; color:#fff; font-size:15px; }
  input:focus, select:focus, textarea:focus{ outline:none; border-color:#00ff88; }
  .add-btn{ background:#2a2a2a; border:2px dashed #444; color:#888; padding:12px; border-radius:6px; cursor:pointer; width:100%; font-size:14px; font-weight:bold; margin-top:10px; }
  .add-btn:hover{ border-color:#00ff88; color:#00ff88; }
  .add-exercise-btn{ background:linear-gradient(135deg,#333,#1a1a1a); border:2px solid #00ff88; color:#00ff88; padding:15px; border-radius:8px; font-size:16px; font-weight:bold; cursor:pointer; width:100%; margin-top:20px; }
  .add-exercise-btn:hover{ background:#0a2a1a; }

  .question{ margin-bottom:15px; }
  .question label{ display:block; margin-bottom:8px; color:#aaa; font-weight:bold; }

  .upload-zone{ border:2px dashed #333; padding:30px; border-radius:8px; text-align:center; cursor:pointer; transition:all .3s; margin:15px 0; }
  .upload-zone:hover{ border-color:#00ff88; }
  .upload-zone.has-file{ border-color:#00ff88; border-style:solid; background:rgba(0,255,136,.05); }
  .hr-preview{ max-width:100%; max-height:300px; border-radius:8px; margin-top:15px; }

  .save-day-btn{ background:linear-gradient(135deg,#00ff88,#00ccff); border:none; color:#000; padding:20px; border-radius:10px; font-size:20px; font-weight:bold; cursor:pointer; width:100%; margin-top:30px; }
  .save-day-btn:hover{ transform:translateY(-2px); box-shadow:0 5px 20px rgba(0,255,136,.3); }

  .rpe-btn{ background:#444; border:2px solid #666; color:#aaa; padding:10px 20px; border-radius:6px; cursor:pointer; margin-bottom:20px; font-weight:bold; }
  .rpe-btn:hover{ border-color:#00ff88; color:#00ff88; }

  .rpe-modal{ position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,.95); z-index:1001; overflow-y:auto; padding:20px; display:flex; align-items:center; justify-content:center; }
  .rpe-content{ max-width:600px; background:#1a1a1a; border-radius:12px; padding:30px; border:2px solid #00ff88; }
  .rpe-row{ display:grid; grid-template-columns:80px 120px 1fr; gap:15px; padding:12px; margin-bottom:8px; background:#0a0a0a; border-radius:6px; align-items:center; }
  .rpe-number{ font-size:24px; font-weight:bold; color:#00ff88; }
  .rpe-rir{ font-size:14px; color:#00ccff; font-weight:bold; }
  .rpe-desc{ font-size:14px; color:#aaa; }

  .metrics-grid{ display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:15px; margin:20px 0; }
  .metric-card{ background:rgba(0,0,0,.5); padding:20px; border-radius:8px; border-left:4px solid #00ccff; }
  .metric-value{ font-size:32px; font-weight:bold; color:#00ff88; }
  .metric-label{ font-size:12px; color:#888; margin-top:5px; }
  .warning-box{ background:rgba(255,68,68,.2); border:2px solid #ff4444; padding:20px; border-radius:8px; margin:20px 0; }
  .success-box{ background:rgba(0,255,136,.2); border:2px solid #00ff88; padding:20px; border-radius:8px; margin:20px 0; }
  .info-box{ background:rgba(0,204,255,.2); border:2px solid #00ccff; padding:20px; border-radius:8px; margin:20px 0; }

  .hidden{ display:none; }

  /* Track / Plyo row */
  .track-row{ display:grid; grid-template-columns:190px 120px 1fr 1fr 1fr 1fr 40px; gap:8px; align-items:center; margin-bottom:8px; }
  .track-foot{ display:grid; grid-template-columns:repeat(4,1fr); gap:8px; margin-top:12px; }
  .muted{ color:#aaa; font-size:12px; }

  @media (max-width:768px){
    h1{ font-size:28px; }
    .calendar-grid{ gap:5px; }
    .calendar-day{ min-height:100px; padding:8px; }
    .day-number{ font-size:14px; }
    .modality-checkboxes{ grid-template-columns:1fr; }
    .set-row{ grid-template-columns:1fr 1fr 40px; }
    .modal-content{ padding:20px; }
    .track-row{ grid-template-columns:1fr 1fr 1fr 1fr 1fr 1fr 40px; }
  }
</style>
</head>
<body>
  <div class="container">
    <h1>üèÜ ELITE ATHLETE TRAINING SYSTEM</h1>
    <p class="subtitle">Full Periodization ‚Ä¢ Load Management ‚Ä¢ Injury Prevention ‚Ä¢ Performance Optimization</p>

    <div class="calendar-header">
      <div class="calendar-nav">
        <button onclick="previousMonth()">‚Äπ Prev</button>
        <button onclick="goToToday()">Today</button>
        <button onclick="nextMonth()">Next ‚Ä∫</button>
      </div>
      <div class="month-title" id="month-title">NOVEMBER 2025</div>
      <div><button class="analysis-btn" onclick="showWeeklyAnalysis()">üìä WEEKLY ANALYSIS</button></div>
    </div>

    <div class="calendar-grid" id="calendar-grid"></div>

    <div id="day-modal" class="hidden"></div>
    <div id="weekly-modal" class="hidden"></div>
    <div id="rpe-modal" class="hidden"></div>
  </div>

<script>
/* ================= STATE ================= */
let currentDate = new Date();
let trainingData = {};         // { 'YYYY-MM-DD': { modalities:{}, totalCNS, totalVolume, tss } }
let historicalTSS = [];        // [{date,tss}] for last 28 days
let exerciseCounters = {};
let setCounters = {};
let hrData = {};               // per-modality HR parse

function loadData(){
  const saved = localStorage.getItem('eliteTrainingData');
  if (saved) trainingData = JSON.parse(saved);
  const savedTSS = localStorage.getItem('historicalTSS');
  if (savedTSS) historicalTSS = JSON.parse(savedTSS);
}
function saveData(){
  localStorage.setItem('eliteTrainingData', JSON.stringify(trainingData));
  localStorage.setItem('historicalTSS', JSON.stringify(historicalTSS));
}

/* ================= CALENDAR ================= */
function renderCalendar(){
  const year = currentDate.getFullYear();
  const month = currentDate.getMonth();
  const monthNames = ['JANUARY','FEBRUARY','MARCH','APRIL','MAY','JUNE','JULY','AUGUST','SEPTEMBER','OCTOBER','NOVEMBER','DECEMBER'];
  document.getElementById('month-title').textContent = `${monthNames[month]} ${year}`;

  const grid = document.getElementById('calendar-grid');
  grid.innerHTML = '';
  ['SUN','MON','TUE','WED','THU','FRI','SAT'].forEach(d=>{
    const h = document.createElement('div'); h.className='calendar-day-header'; h.textContent=d; grid.appendChild(h);
  });

  const firstDay = new Date(year, month, 1).getDay();
  const daysInMonth = new Date(year, month+1, 0).getDate();
  const daysInPrev = new Date(year, month, 0).getDate();
  const today = formatDate(new Date());

  for (let i=firstDay-1;i>=0;i--){
    const day = daysInPrev - i;
    const date = new Date(year, month-1, day);
    createDayCell(grid, date, true, today);
  }
  for (let d=1; d<=daysInMonth; d++){
    const date = new Date(year, month, d);
    createDayCell(grid, date, false, today);
  }
  const totalCells = firstDay + daysInMonth;
  const remaining = totalCells <= 35 ? 35-totalCells : 42-totalCells;
  for (let d=1; d<=remaining; d++){
    const date = new Date(year, month+1, d);
    createDayCell(grid, date, true, today);
  }
}
function createDayCell(grid, date, otherMonth, todayStr){
  const cell = document.createElement('div'); cell.className='calendar-day';
  if (otherMonth) cell.classList.add('other-month');
  const dateStr = formatDate(date);
  if (dateStr===todayStr) cell.classList.add('today');

  const dayData = trainingData[dateStr];

  const num = document.createElement('div'); num.className='day-number'; num.textContent = date.getDate(); cell.appendChild(num);
  if (dayData && dayData.modalities){
    cell.classList.add('has-workouts');
    const workouts = document.createElement('div'); workouts.className='day-workouts';
    Object.keys(dayData.modalities).forEach(type=>{
      if (dayData.modalities[type].completed){
        const b = document.createElement('span'); b.className='workout-badge'; b.textContent=type.toUpperCase(); workouts.appendChild(b);
      }
    });
    cell.appendChild(workouts);
    const ind = document.createElement('div'); ind.className='cns-indicator';
    const totalCNS = dayData.totalCNS || 0;
    if (totalCNS<60) ind.classList.add('cns-low'); else if (totalCNS<75) ind.classList.add('cns-moderate'); else ind.classList.add('cns-high');
    cell.appendChild(ind);
  }
  cell.onclick = ()=>openDay(dateStr, date);
  grid.appendChild(cell);
}
function formatDate(d){ const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), da=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${da}`; }
function previousMonth(){ currentDate.setMonth(currentDate.getMonth()-1); renderCalendar(); }
function nextMonth(){ currentDate.setMonth(currentDate.getMonth()+1); renderCalendar(); }
function goToToday(){ currentDate=new Date(); renderCalendar(); }

/* ================= DAY VIEW ================= */
let currentEditingDate=null;

function openDay(dateStr, date){
  currentEditingDate = dateStr;
  const dayData = trainingData[dateStr] || { modalities:{} };
  exerciseCounters = {}; setCounters = {};

  const html = `
    <div class="modal"><div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">${date.toLocaleDateString('en-US',{weekday:'long', year:'numeric', month:'long', day:'numeric'})}</div>
        <button class="close-btn" onclick="closeModal()">‚úï Close</button>
      </div>

      <h3 style="color:#00ff88; margin-bottom:15px;">SELECT TRAINING MODALITIES FOR TODAY:</h3>
      <div class="modality-checkboxes">
        ${['chest','back','legs','track','bike','bjj','walking'].map(t=>{
          const checked = dayData.modalities[t] ? 'checked' : '';
          return `
            <div class="modality-checkbox ${checked}" onclick="toggleModality('${t}')">
              <input type="checkbox" id="check-${t}" ${checked}>
              <label for="check-${t}">${labelFor(t)}</label>
            </div>`;
        }).join('')}
      </div>

      <div id="form-chest" class="hidden modality-section"></div>
      <div id="form-back" class="hidden modality-section"></div>
      <div id="form-legs" class="hidden modality-section"></div>
      <div id="form-track" class="hidden modality-section"></div>
      <div id="form-bike" class="hidden modality-section"></div>
      <div id="form-bjj" class="hidden modality-section"></div>
      <div id="form-walking" class="hidden modality-section"></div>

      <button class="save-day-btn" onclick="saveDay('${dateStr}')">‚úì SAVE ALL TRAINING & ANALYZE</button>
    </div></div>`;
  document.getElementById('day-modal').innerHTML = html;
  document.getElementById('day-modal').classList.remove('hidden');

  Object.keys(dayData.modalities||{}).forEach(t=>{
    if (dayData.modalities[t]) showModalityForm(t, dayData.modalities[t]);
  });
}
function labelFor(t){
  const map = { chest:'üí™ CHEST', back:'üí™ BACK', legs:'üí™ LEGS', track:'üèÉ TRACK / PLYO', bike:'üö¥ BIKE', bjj:'ü•ã BJJ', walking:'üö∂ WALKING' };
  return map[t] || t.toUpperCase();
}
function toggleModality(type){
  const checkbox = document.getElementById('check-'+type);
  checkbox.checked = !checkbox.checked;
  const container = checkbox.parentElement;
  container.classList.toggle('checked');
  if (checkbox.checked) showModalityForm(type); else document.getElementById('form-'+type).classList.add('hidden');
}

function showModalityForm(type, data=null){
  const el = document.getElementById('form-'+type);
  el.classList.remove('hidden');
  if (type==='chest' || type==='back' || type==='legs'){
    el.innerHTML = generateWeightForm(type, data);
    if (!exerciseCounters[type]) exerciseCounters[type]=0;
    addExercise(type); // seed 1 exercise
  } else if (type==='track'){
    el.innerHTML = generateTrackForm(data);
    if (data && Array.isArray(data.items)){
      data.items.forEach(add=> addTrackItem(add)); 
    } else {
      // seed one sprint and one jump block as examples
      addTrackItem({exercise:'Sprint', unit:'yards', qty:100, reps:4, jumpsPerRep:0, rest:60});
      addTrackItem({exercise:'Broad Jumps', unit:'yards', qty:10, reps:5, jumpsPerRep:1, rest:30});
    }
  } else if (type==='bike'){ el.innerHTML = generateBikeForm(data);
  } else if (type==='bjj'){ el.innerHTML = generateBJJForm(data);
  } else if (type==='walking'){ el.innerHTML = generateWalkingForm(data); }
}

/* ======== WEIGHTS (unchanged mechanics) ======== */
function generateWeightForm(type, data){
  return `
    <h2>üí™ ${type.toUpperCase()} TRAINING</h2>
    <div class="section-content">
      <button class="rpe-btn" onclick="showRPEGuide()">‚ùì RPE REFERENCE GUIDE</button>
      <div id="${type}-exercises"></div>
      <button class="add-exercise-btn" onclick="addExercise('${type}')">+ ADD EXERCISE</button>

      <h3 style="color:#00ccff; margin-top:30px; margin-bottom:15px;">Session Details</h3>
      <div class="question">
        <label>Overall feeling:</label>
        <select id="${type}-feeling">
          <option value="">Choose...</option>
          <option value="great">Great - Strong & energized</option>
          <option value="good">Good - Felt solid</option>
          <option value="tired">Tired - Low energy</option>
          <option value="beat">Beat Up - Sore & exhausted</option>
        </select>
      </div>
      <div class="question">
        <label>Sleep last night (hours):</label>
        <input type="number" id="${type}-sleep" step="0.5" placeholder="7.5" value="${data?.sleep||''}">
      </div>
      <div class="upload-zone" id="${type}-upload" onclick="document.getElementById('${type}-hr').click()">üìä Upload Polar HR Monitor Screenshot (optional)</div>
      <input type="file" id="${type}-hr" accept="image/*" style="display:none" onchange="handleHRUpload('${type}', event)">
      <img id="${type}-hr-preview" class="hr-preview hidden">
    </div>`;
}
function addExercise(type){
  exerciseCounters[type] = (exerciseCounters[type]||0)+1;
  const exId = `${type}-ex${exerciseCounters[type]}`;
  setCounters[exId] = { warmup:0, working:0 };
  const html = `
    <div class="exercise-block" id="${exId}">
      <input type="text" class="exercise-name" placeholder="Exercise name (e.g., Bench Press, Squat)">
      <select class="muscle-select">
        <option value="">Select muscle group...</option>
        <option value="chest">Chest</option><option value="back">Back</option><option value="shoulders">Shoulders</option>
        <option value="biceps">Biceps</option><option value="triceps">Triceps</option><option value="quads">Quads</option>
        <option value="hamstrings">Hamstrings</option><option value="glutes">Glutes</option><option value="calves">Calves</option><option value="core">Core</option>
      </select>
      <div class="set-label">WARM-UP SETS</div>
      <div id="${exId}-warmup"></div><button class="add-btn" onclick="addSet('${exId}','warmup')">+ Add Warm-up</button>
      <div class="set-label">WORKING SETS</div>
      <div id="${exId}-working"></div><button class="add-btn" onclick="addSet('${exId}','working')">+ Add Working Set</button>
    </div>`;
  document.getElementById(type+'-exercises').insertAdjacentHTML('beforeend', html);
  addSet(exId,'warmup'); addSet(exId,'warmup'); addSet(exId,'working'); addSet(exId,'working'); addSet(exId,'working');
}
function addSet(exId, type){
  setCounters[exId][type]++; const setId = `${exId}-${type}${setCounters[exId][type]}`;
  const hideRPE = (type==='warmup') ? 'style="display:none"' : '';
  const html = `<div class="set-row" id="${setId}">
      <input type="number" placeholder="Weight (lbs)" class="${type}-weight">
      <input type="number" placeholder="Reps" class="${type}-reps">
      <input type="number" placeholder="RPE" class="${type}-rpe" step="0.5" ${hideRPE}>
      <button class="delete-btn" onclick="document.getElementById('${setId}').remove()">‚úï</button>
    </div>`;
  document.getElementById(`${exId}-${type}`).insertAdjacentHTML('beforeend', html);
}

/* ======== TRACK / PLYO (new structure) ======== */
function generateTrackForm(data){
  return `
    <h2>üèÉ TRACK / PLYOMETRICS</h2>
    <div class="section-content">
      <div class="muted" style="margin-bottom:10px">
        Choose exercise ‚Üí choose unit (yards / meters / stadium stairs) ‚Üí enter distance/quantity ‚Üí reps ‚Üí <em>jumps/rep</em> (for jump drills).
      </div>
      <div id="track-items"></div>
      <button class="add-exercise-btn" onclick="addTrackItem()">+ ADD TRACK / PLYO ITEM</button>

      <div class="track-foot">
        <div>
          <label class="muted">Ground feel</label>
          <select id="track-ground">
            <option value="">Choose...</option><option value="bouncy">Bouncy</option><option value="normal">Normal</option><option value="heavy">Heavy</option>
          </select>
        </div>
        <div>
          <label class="muted">Energy level</label>
          <select id="track-energy">
            <option value="">Choose...</option><option value="high">High</option><option value="moderate">Moderate</option><option value="low">Low</option>
          </select>
        </div>
        <div>
          <label class="muted">Achilles/calf</label>
          <select id="track-achilles">
            <option value="">Choose...</option><option value="fresh">Fresh</option><option value="tight">Tight</option><option value="sore">Sore</option>
          </select>
        </div>
        <div>
          <label class="muted">Sleep (hrs)</label>
          <input type="number" id="track-sleep" step="0.5" placeholder="7.5" value="${data?.sleep||''}">
        </div>
      </div>

      <div class="upload-zone" id="track-upload" onclick="document.getElementById('track-hr').click()">üìä Upload Polar HR Monitor Screenshot (optional)</div>
      <input type="file" id="track-hr" accept="image/*" style="display:none" onchange="handleHRUpload('track', event)">
      <img id="track-hr-preview" class="hr-preview hidden">
    </div>`;
}
function isJumpExercise(name){
  const J = ['Broad Jumps','Bounds','Hurdle Hops','Depth Jumps','Tuck Jumps','Box Jumps','Single-Leg Hops','Stair Jumps'];
  return J.includes(name);
}
function addTrackItem(pref){
  const id = `trk-${crypto.randomUUID()}`;
  const exercise = pref?.exercise || 'Sprint';
  const unit = pref?.unit || 'yards';
  const qty = pref?.qty ?? '';
  const reps = pref?.reps ?? '';
  const jumpsPerRep = pref?.jumpsPerRep ?? 1;
  const rest = pref?.rest ?? 60;

  const html = `
    <div class="track-row" id="${id}">
      <select class="trk-exercise" onchange="toggleJPR('${id}')">
        ${['Sprint','Tempo Run','Bounds','Broad Jumps','Hurdle Hops','Depth Jumps','Skips A/B','Stair Runs','Stair Jumps','Other'].map(x =>
          `<option value="${x}" ${exercise===x?'selected':''}>${x}</option>`).join('')}
      </select>
      <select class="trk-unit">
        <option value="yards" ${unit==='yards'?'selected':''}>yards</option>
        <option value="meters" ${unit==='meters'?'selected':''}>meters</option>
        <option value="stairs" ${unit==='stairs'?'selected':''}>stadium stairs</option>
      </select>
      <input type="number" class="trk-qty" placeholder="Distance/Qty" value="${qty}">
      <input type="number" class="trk-reps" placeholder="Reps" value="${reps}">
      <input type="number" class="trk-jpr" placeholder="Jumps/rep" value="${jumpsPerRep}">
      <input type="number" class="trk-rest" placeholder="Rest (s)" value="${rest}">
      <button class="delete-btn" onclick="document.getElementById('${id}').remove()">‚úï</button>
    </div>`;
  document.getElementById('form-track').querySelector('#track-items').insertAdjacentHTML('beforeend', html);
  toggleJPR(id);
}
function toggleJPR(id){
  const row = document.getElementById(id);
  const ex = row.querySelector('.trk-exercise').value;
  const jpr = row.querySelector('.trk-jpr');
  if (isJumpExercise(ex)) { jpr.style.display='block'; if (!jpr.value) jpr.value = 1; }
  else { jpr.style.display='none'; jpr.value = 0; }
}

/* ======== BIKE / BJJ / WALKING (unchanged UI) ======== */
function generateBikeForm(data){
  return `
    <h2>üö¥ ASSAULT BIKE</h2>
    <div class="section-content">
      <div class="question"><label>Protocol:</label>
        <select id="bike-protocol">
          <option value="">Choose...</option>
          <option value="peak-rpm">Peak RPM Sprints</option>
          <option value="zone5">Zone 5 Intervals</option>
          <option value="alternating">Alternating Pace</option>
          <option value="steady">Steady State</option>
        </select>
      </div>
      <div class="question"><label>Total time (minutes):</label><input type="number" id="bike-time" placeholder="20" value="${data?.time||''}"></div>
      <div class="question"><label>Peak RPM achieved:</label><input type="number" id="bike-rpm" placeholder="120" value="${data?.rpm||''}"></div>
      <div class="question"><label>Number of intervals:</label><input type="number" id="bike-intervals" placeholder="8" value="${data?.intervals||''}"></div>
      <div class="question"><label>Breathing quality:</label>
        <select id="bike-breathing"><option value="">Choose...</option><option value="strong">Strong</option><option value="moderate">Moderate</option><option value="labored">Labored</option></select>
      </div>
      <div class="question"><label>Overall feeling:</label>
        <select id="bike-feeling"><option value="">Choose...</option><option value="great">Great</option><option value="good">Good</option><option value="tired">Tired</option><option value="beat">Beat up</option></select>
      </div>
      <div class="question"><label>Sleep last night (hours):</label><input type="number" id="bike-sleep" step="0.5" placeholder="7.5" value="${data?.sleep||''}"></div>
      <div class="upload-zone" id="bike-upload" onclick="document.getElementById('bike-hr').click()">üìä Upload Polar HR Monitor Screenshot (HIGHLY RECOMMENDED)</div>
      <input type="file" id="bike-hr" accept="image/*" style="display:none" onchange="handleHRUpload('bike', event)">
      <img id="bike-hr-preview" class="hr-preview hidden">
    </div>`;
}
function generateBJJForm(data){
  return `
    <h2>ü•ã JIU JITSU</h2>
    <div class="section-content">
      <div class="question"><label>Spar time (minutes):</label><input type="number" id="bjj-time" placeholder="45" value="${data?.time||''}"></div>
      <div class="question"><label>Intensity:</label>
        <select id="bjj-intensity"><option value="">Choose...</option><option value="high">High</option><option value="medium">Medium</option><option value="light">Light</option></select>
      </div>
      <div class="question"><label>Weight before (lbs):</label><input type="number" id="bjj-weight-before" step="0.1" placeholder="180.0" value="${data?.weightBefore||''}"></div>
      <div class="question"><label>Weight after (lbs):</label><input type="number" id="bjj-weight-after" step="0.1" placeholder="177.0" value="${data?.weightAfter||''}"></div>
      <div class="question"><label>Overall feeling:</label>
        <select id="bjj-feeling"><option value="">Choose...</option><option value="great">Great</option><option value="good">Good</option><option value="tired">Tired</option><option value="beat">Beat up</option></select>
      </div>
      <div class="question"><label>Sleep last night (hours):</label><input type="number" id="bjj-sleep" step="0.5" placeholder="7.5" value="${data?.sleep||''}"></div>
      <div class="upload-zone" id="bjj-upload" onclick="document.getElementById('bjj-hr').click()">üìä Upload Polar HR Monitor Screenshot (optional)</div>
      <input type="file" id="bjj-hr" accept="image/*" style="display:none" onchange="handleHRUpload('bjj', event)">
      <img id="bjj-hr-preview" class="hr-preview hidden">
    </div>`;
}
function generateWalkingForm(data){
  return `
    <h2>üö∂ WALKING / RECOVERY</h2>
    <div class="section-content">
      <p style="color:#888; margin-bottom:20px;">Active recovery with HR monitoring</p>
      <div class="question"><label>Duration (minutes):</label><input type="number" id="walking-duration" placeholder="30" value="${data?.duration||''}"></div>
      <div class="question"><label>Distance (miles):</label><input type="number" id="walking-distance" step="0.1" placeholder="2.5" value="${data?.distance||''}"></div>
      <div class="question"><label>Average pace (min/mile):</label><input type="number" id="walking-pace" step="0.1" placeholder="12.0" value="${data?.pace||''}"></div>
      <div class="question"><label>Terrain:</label>
        <select id="walking-terrain"><option value="">Choose...</option><option value="flat">Flat</option><option value="hills">Hills</option><option value="steep">Steep</option></select>
      </div>
      <div class="question"><label>Purpose:</label>
        <select id="walking-purpose"><option value="">Choose...</option><option value="recovery">Active Recovery</option><option value="zone2">Zone 2 Cardio</option><option value="general">General Activity</option></select>
      </div>
      <div class="upload-zone" id="walking-upload" onclick="document.getElementById('walking-hr').click()">üìä Upload Polar HR Monitor Screenshot</div>
      <input type="file" id="walking-hr" accept="image/*" style="display:none" onchange="handleHRUpload('walking', event)">
      <img id="walking-hr-preview" class="hr-preview hidden">
    </div>`;
}

/* ======== HR UPLOAD (stub: no external calls here) ======== */
async function handleHRUpload(type, event){
  const file = event.target.files?.[0]; if (!file) return;
  const preview = document.getElementById(type+'-hr-preview');
  const uploadZone = document.getElementById(type+'-upload');

  const reader = new FileReader();
  reader.onload = e=>{
    preview.src = e.target.result; preview.classList.remove('hidden');
    uploadZone.classList.add('has-file');
    uploadZone.innerHTML = 'üìä HR image attached (manual analysis or separate pipeline)';
  };
  reader.readAsDataURL(file);

  // If you wire an external analyzer, put parsed JSON into hrData[type] here:
  // hrData[type] = { peakHR: , avgHR: , timeInZone5: , timeInZone4: , ... , recovery:'good'|'moderate'|'poor' }
}

/* ======== RPE GUIDE ======== */
function showRPEGuide(){
  const html = `
    <div class="rpe-modal"><div class="rpe-content">
      <button class="close-btn" onclick="closeRPEGuide()">‚úï Close</button>
      <h2 style="color:#00ff88; margin-bottom:20px; clear:both;">RPE REFERENCE GUIDE</h2>
      <p style="color:#aaa; margin-bottom:20px;">RPE (Rate of Perceived Exertion) ~ Reps In Reserve (RIR)</p>
      ${[
        [10,'0 RIR','Absolute failure - no more reps'],
        [9.5,'0‚Äì1 RIR','Maybe 1 more rep'],
        [9,'1 RIR','ALMOST FAILURE ‚Äî definitely 1 left'],
        [8.5,'1‚Äì2 RIR','1 for sure, maybe 2'],
        [8,'2 RIR','OPTIMAL HYPERTROPHY ‚Äî solid 2 left'],
        [7.5,'2‚Äì3 RIR','2 for sure, maybe 3'],
        [7,'3 RIR','Moderate difficulty'],
        [6,'4 RIR','Bar speed fast']
      ].map(([n,rir,desc])=>`
        <div class="rpe-row" ${n===9||n===8?'style="border:2px solid ${n===9?'#ff6b35':'#00ff88'}"':''}>
          <div class="rpe-number">${n}</div>
          <div class="rpe-rir">${rir}</div>
          <div class="rpe-desc">${desc}</div>
        </div>`).join('')}
      <p class="muted" style="text-align:center; margin-top:10px;">RIR = how many reps you could still do</p>
    </div></div>`;
  document.getElementById('rpe-modal').innerHTML = html;
  document.getElementById('rpe-modal').classList.remove('hidden');
}
function closeRPEGuide(){ document.getElementById('rpe-modal').classList.add('hidden'); }
function closeModal(){ document.getElementById('day-modal').classList.add('hidden'); document.getElementById('weekly-modal').classList.add('hidden'); hrData={}; }

/* ======== SAVE DAY ======== */
async function saveDay(dateStr){
  const data = { modalities:{}, totalCNS:0, totalVolume:0, tss:0, qualities:{} };
  const types = ['chest','back','legs','track','bike','bjj','walking'];
  for (const t of types){
    const cb = document.getElementById('check-'+t);
    if (cb && cb.checked){
      const m = await collectModalityData(t);
      if (m){ data.modalities[t]=m; data.modalities[t].completed=true; }
    }
  }
  if (!Object.keys(data.modalities).length){ alert('Please select and complete at least one training modality!'); return; }

  Object.keys(data.modalities).forEach(t=>{
    const mod = data.modalities[t];
    data.totalCNS += mod.cnsScore||0;
    data.totalVolume += mod.volume||0;
    data.tss += mod.tss||0;
  });

  data.qualities = analyzeQualities(data.modalities);
  data.interference = detectInterference(data.modalities, data.qualities);

  trainingData[dateStr]=data;
  historicalTSS.push({date:dateStr, tss:data.tss}); if (historicalTSS.length>28) historicalTSS.shift();
  saveData();
  displayDayAnalysis(dateStr, data);
}

async function collectModalityData(type){
  const data = { type };
  if (type==='chest' || type==='back' || type==='legs'){
    const exercises=[]; const blocks = document.querySelectorAll(`#${type}-exercises .exercise-block`);
    blocks.forEach(block=>{
      const name = block.querySelector('.exercise-name').value;
      const mg = block.querySelector('.muscle-select').value;
      if (!name || !mg) return;
      const sets=[];
      const weights = block.querySelectorAll('.working-weight');
      const reps = block.querySelectorAll('.working-reps');
      const rpe = block.querySelectorAll('.working-rpe');
      weights.forEach((w,i)=>{
        const wt = parseFloat(w.value)||0;
        const rp = parseInt(reps[i].value)||0;
        const rr = parseFloat(rpe[i].value)||0;
        if (wt>0 && rp>0){ sets.push({weight:wt, reps:rp, rpe:rr}); }
      });
      if (sets.length) exercises.push({ name, muscleGroup:mg, workingSets:sets });
    });
    if (!exercises.length) return null;
    data.exercises=exercises;
    data.feeling = document.getElementById(`${type}-feeling`)?.value || '';
    data.sleep = parseFloat(document.getElementById(`${type}-sleep`)?.value)||0;
    data.hrAnalysis = hrData[type]||null;
    Object.assign(data, calculateWeightMetrics(data));
  } else if (type==='track'){
    const rows = Array.from(document.querySelectorAll('#track-items .track-row'));
    const items = rows.map(r=>{
      return {
        exercise: r.querySelector('.trk-exercise').value,
        unit:     r.querySelector('.trk-unit').value,
        qty:      parseFloat(r.querySelector('.trk-qty').value)||0,
        reps:     parseInt(r.querySelector('.trk-reps').value)||0,
        jumpsPerRep: parseFloat(r.querySelector('.trk-jpr').value)||0,
        rest:     parseFloat(r.querySelector('.trk-rest').value)||0
      };
    }).filter(x => x.qty>0 && x.reps>0);
    if (!items.length) return null;
    data.items = items;
    data.ground   = document.getElementById('track-ground')?.value || '';
    data.energy   = document.getElementById('track-energy')?.value || '';
    data.achilles = document.getElementById('track-achilles')?.value || '';
    data.sleep    = parseFloat(document.getElementById('track-sleep')?.value)||0;
    data.hrAnalysis = hrData['track']||null;
    Object.assign(data, calculateTrackMetrics(data));
  } else if (type==='bike'){
    data.protocol = document.getElementById('bike-protocol')?.value || '';
    data.time = parseInt(document.getElementById('bike-time')?.value)||0;
    data.rpm = parseInt(document.getElementById('bike-rpm')?.value)||0;
    data.intervals = parseInt(document.getElementById('bike-intervals')?.value)||0;
    data.breathing = document.getElementById('bike-breathing')?.value || '';
    data.feeling = document.getElementById('bike-feeling')?.value || '';
    data.sleep = parseFloat(document.getElementById('bike-sleep')?.value)||0;
    data.hrAnalysis = hrData['bike']||null;
    Object.assign(data, calculateBikeMetrics(data));
  } else if (type==='bjj'){
    data.time = parseInt(document.getElementById('bjj-time')?.value)||0;
    data.intensity = document.getElementById('bjj-intensity')?.value || '';
    data.weightBefore = parseFloat(document.getElementById('bjj-weight-before')?.value)||0;
    data.weightAfter = parseFloat(document.getElementById('bjj-weight-after')?.value)||0;
    data.weightLoss = +(data.weightBefore - data.weightAfter).toFixed(1);
    data.feeling = document.getElementById('bjj-feeling')?.value || '';
    data.sleep = parseFloat(document.getElementById('bjj-sleep')?.value)||0;
    data.hrAnalysis = hrData['bjj']||null;
    Object.assign(data, calculateBJJMetrics(data));
  } else if (type==='walking'){
    data.duration = parseInt(document.getElementById('walking-duration')?.value)||0;
    data.distance = parseFloat(document.getElementById('walking-distance')?.value)||0;
    data.pace = parseFloat(document.getElementById('walking-pace')?.value)||0;
    data.terrain = document.getElementById('walking-terrain')?.value || '';
    data.purpose = document.getElementById('walking-purpose')?.value || '';
    data.hrAnalysis = hrData['walking']||null;
    Object.assign(data, calculateWalkingMetrics(data));
  }
  return data;
}

/* ======== METRICS ======== */
function calculateWeightMetrics(data){
  let cnsScore=40, totalVolume=0, avgRPE=0, rpeN=0;
  data.exercises.forEach(ex=>{
    ex.workingSets.forEach(s=>{
      totalVolume += s.weight * s.reps;
      if (s.rpe){ avgRPE += s.rpe; rpeN++; }
    });
  });
  avgRPE = rpeN ? avgRPE/rpeN : 0;

  if (data.feeling==='beat') cnsScore+=20;
  if (data.feeling==='tired') cnsScore+=12;
  if (data.feeling==='great') cnsScore-=10;

  if (avgRPE>=9) cnsScore+=15;
  else if (avgRPE>=8.5) cnsScore+=10;
  else if (avgRPE<=7) cnsScore-=8;

  if (data.sleep<6.5) cnsScore+=15; else if (data.sleep>=8) cnsScore-=8;

  if (data.hrAnalysis){
    const hr=data.hrAnalysis;
    if (hr.avgHR>=160) cnsScore+=12; else if (hr.avgHR>=150) cnsScore+=8;
    if (hr.recovery==='poor') cnsScore+=10; else if (hr.recovery==='good') cnsScore-=5;
    if (hr.timeInZone5>5) cnsScore+=8;
  }

  const duration=60, intensity=avgRPE/10, tss = duration*intensity*100;
  return { cnsScore:clamp01to100(cnsScore), volume:totalVolume, avgRPE:+avgRPE.toFixed(1), tss:Math.round(tss) };
}

function calculateTrackMetrics(data){
  // Aggregate: convert yards/meters to meters; stairs left as count
  let totalMeters=0, totalStairs=0, sprintCount=0, jumpContacts=0;
  for (const it of data.items){
    if (it.unit==='yards') totalMeters += it.qty * 0.9144 * it.reps;
    else if (it.unit==='meters') totalMeters += it.qty * it.reps;
    else if (it.unit==='stairs') totalStairs += it.qty * it.reps;
    if (it.exercise==='Sprint') sprintCount += it.reps;
    if (isJumpExercise(it.exercise)) jumpContacts += (it.jumpsPerRep||0) * it.reps;
  }

  // CNS scoring reflecting surfaces, energy, tendon status, density
  let cnsScore = 35;
  if (data.ground==='heavy') cnsScore+=25;
  if (data.energy==='low') cnsScore+=18;
  if (data.achilles==='sore') cnsScore+=25;
  if (jumpContacts>300) cnsScore+=15; else if (jumpContacts>200) cnsScore+=10;
  if (sprintCount>=8) cnsScore+=12; else if (sprintCount>=5) cnsScore+=8;
  if (totalMeters>2000) cnsScore+=10;
  if (data.sleep<7) cnsScore+=12;

  if (data.hrAnalysis){
    const hr=data.hrAnalysis;
    if (hr.avgHR>=170) cnsScore+=10;
    if (hr.timeInZone5>10) cnsScore+=12;
    if (hr.recovery==='poor') cnsScore+=6;
  }

  // TSS proxy mixes speed-power and volume
  const tss = Math.round( 0.03*totalMeters + 0.08*jumpContacts + 4*sprintCount + (data.ground==='heavy'?20:0) + (data.achilles==='sore'?25:0) );

  return {
    cnsScore: clamp01to100(cnsScore),
    volume: 0,
    tss,
    summary: { totalMeters: Math.round(totalMeters), totalStairs, sprintCount, jumpContacts }
  };
}

function calculateBikeMetrics(data){
  let cnsScore=45;
  if (data.breathing==='labored') cnsScore+=20;
  if (data.feeling==='beat') cnsScore+=18; else if (data.feeling==='tired') cnsScore+=10;
  if (data.sleep<7) cnsScore+=10;
  if (data.hrAnalysis){
    const hr=data.hrAnalysis;
    if (hr.avgHR>=170) cnsScore+=12;
    if (hr.timeInZone5>15) cnsScore+=15;
    if (hr.recovery==='poor') cnsScore+=8;
  }
  const tss = data.time*2 + (data.intervals*5);
  return { cnsScore:clamp01to100(cnsScore), volume:0, tss:Math.round(tss) };
}

function calculateBJJMetrics(data){
  let cnsScore=40, sweat = +data.weightLoss||0;
  if (sweat>=4) cnsScore+=20; else if (sweat>=3) cnsScore+=10;
  if (data.intensity==='high') cnsScore+=15;
  if (data.feeling==='beat') cnsScore+=20; else if (data.feeling==='tired') cnsScore+=12;
  if (data.sleep<7) cnsScore+=10;
  if (data.hrAnalysis){
    const hr=data.hrAnalysis;
    if (hr.avgHR>=160) cnsScore+=10;
    if (hr.timeInZone5>20) cnsScore+=12;
  }
  const tss = data.time*1.5 + (data.intensity==='high'?30:0);
  return { cnsScore:clamp01to100(cnsScore), volume:0, tss:Math.round(tss) };
}

function calculateWalkingMetrics(data){
  let cnsScore=10;
  if (data.terrain==='steep') cnsScore+=15; else if (data.terrain==='hills') cnsScore+=8;
  if (data.purpose==='zone2' && data.hrAnalysis){
    const hr=data.hrAnalysis; if (hr.timeInZone3>hr.timeInZone2) cnsScore+=10;
  }
  const tss = data.duration*0.5;
  return { cnsScore:clamp01to100(cnsScore), volume:0, tss:Math.round(tss) };
}

function clamp01to100(x){ return Math.max(0, Math.min(100, x)); }

/* ======== QUALITY + INTERFERENCE ======== */
function analyzeQualities(mods){
  const q = { strength:0, hypertrophy:0, power:0, speed:0, endurance:0 };
  Object.keys(mods).forEach(t=>{
    const m = mods[t];
    if (t==='chest' || t==='back' || t==='legs'){
      m.exercises?.forEach(ex=>{
        ex.workingSets.forEach(s=>{
          if (s.reps<=5){ q.strength += s.reps*(s.rpe||8); }
          else if (s.reps<=8){ q.strength += s.reps*0.6*(s.rpe||8); q.hypertrophy += s.reps*0.4*(s.rpe||8); }
          else { q.hypertrophy += s.reps*(s.rpe||8); }
        });
      });
    } else if (t==='track'){
      const sum = m.summary||{totalMeters:0,jumpContacts:0,sprintCount:0};
      q.power += sum.jumpContacts*0.15 + sum.sprintCount*8;
      q.speed += sum.sprintCount*25;
      q.endurance += sum.totalMeters*0.01;
    } else if (t==='bike'){
      q.endurance += 80; if (m.protocol==='zone5' || m.protocol==='peak-rpm') q.power += 40;
    } else if (t==='bjj'){
      q.endurance += 50; if (m.intensity==='high'){ q.power+=30; q.strength+=20; }
    } else if (t==='walking'){
      q.endurance += 30;
    }
  });
  const total = Object.values(q).reduce((a,b)=>a+b,0);
  if (total>0) Object.keys(q).forEach(k=> q[k]=Math.round((q[k]/total)*100));
  return q;
}
function detectInterference(mods, q){
  const issues=[]; const types = Object.keys(mods);
  if (types.includes('legs') && types.includes('track')){
    issues.push({ severity:'critical', message:'Legs + Track same day = Type II fiber overload', impact:'Power output compromised 15‚Äì20%, injury risk elevated', fix:'Separate by ‚â•48h' });
  }
  if (types.includes('bjj') && types.includes('back')){
    issues.push({ severity:'moderate', message:'BJJ + Back = Grip fatigue compounding', impact:'Pulling strength reduced 10‚Äì15%', fix:'Use straps or separate modalities' });
  }
  if (types.length>=4){
    issues.push({ severity:'high', message:`${types.length} modalities in one day = Extreme volume`, impact:'CNS overload, recovery compromised', fix:'Split across 2 days or cut volume' });
  }
  return issues;
}

/* ======== DAY ANALYSIS DISPLAY ======== */
function displayDayAnalysis(dateStr, data){
  closeModal(); renderCalendar();
  const mods = Object.keys(data.modalities).map(t=>t.toUpperCase()).join(', ');
  let html = `
    <div class="modal"><div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">‚úì Training Saved!</div>
        <button class="close-btn" onclick="closeModal()">‚úï Close</button>
      </div>
      <div class="success-box">
        <h3 style="color:#00ff88;">TRAINING COMPLETE: ${dateStr}</h3>
        <p><strong>Modalities:</strong> ${mods}</p>
      </div>
      <div class="metrics-grid">
        <div class="metric-card"><div class="metric-value">${data.totalCNS}</div><div class="metric-label">Total CNS Load</div></div>
        <div class="metric-card"><div class="metric-value">${data.totalVolume.toLocaleString()}</div><div class="metric-label">Volume (lbs)</div></div>
        <div class="metric-card"><div class="metric-value">${data.tss}</div><div class="metric-label">Training Stress Score</div></div>
      </div>
      <div class="info-box">
        <h3 style="color:#00ccff;">TRAINING QUALITIES</h3>
        ${Object.keys(data.qualities).filter(k=>data.qualities[k]>=20).map(k=>`<p><strong>${k[0].toUpperCase()+k.slice(1)}:</strong> ${data.qualities[k]}%</p>`).join('')}
      </div>`;
  if (data.modalities.track?.summary){
    const s = data.modalities.track.summary;
    html += `<div class="info-box">
      <h3 style="color:#00ccff;">TRACK / PLYO SUMMARY</h3>
      <p>Total distance: <strong>${s.totalMeters}</strong> m ¬∑ Stadium stairs: <strong>${s.totalStairs}</strong> ¬∑ Sprints: <strong>${s.sprintCount}</strong> ¬∑ Jump contacts: <strong>${s.jumpContacts}</strong></p>
    </div>`;
  }
  if (data.interference?.length){
    html += `<div class="warning-box"><h3>‚ö†Ô∏è INTERFERENCE DETECTED</h3>${
      data.interference.map(i=>`<div style="margin-bottom:12px"><p><strong>${i.message}</strong></p><p style="color:#ff6666">Impact: ${i.impact}</p><p style="color:#00ff88">Fix: ${i.fix}</p></div>`).join('')
    }</div>`;
  }
  html += `</div></div>`;
  document.getElementById('day-modal').innerHTML = html;
  document.getElementById('day-modal').classList.remove('hidden');
}

/* ======== WEEKLY ANALYSIS (unchanged) ======== */
function showWeeklyAnalysis(){
  const endDate = new Date(), startDate = new Date(); startDate.setDate(startDate.getDate()-6);
  let totalCNS=0,totalVolume=0,totalTSS=0,days=0, dailyCNS=[], dailyTSS=[];
  for (let d=new Date(startDate); d<=endDate; d.setDate(d.getDate()+1)){
    const key = formatDate(d); const dd = trainingData[key];
    if (dd && dd.modalities && Object.keys(dd.modalities).length){
      days++; totalCNS+=dd.totalCNS||0; totalVolume+=dd.totalVolume||0; totalTSS+=dd.tss||0;
      dailyCNS.push(dd.totalCNS||0); dailyTSS.push(dd.tss||0);
    }
  }
  const avgCNS = days? Math.round(totalCNS/days):0;
  const avgTSS = days? Math.round(totalTSS/days):0;
  const mean = avgCNS;
  const variance = dailyCNS.reduce((s,v)=>s+Math.pow(v-mean,2),0)/(dailyCNS.length||1);
  const std = Math.sqrt(variance);
  const monotony = std>0 ? (mean/std).toFixed(2) : 0;
  const strain = Math.round(totalCNS * parseFloat(monotony||0));

  const last28 = historicalTSS.slice(-28);
  let acRatio='‚Äî', acWarning=false;
  if (last28.length>=14){
    const chronic = last28.reduce((a,b)=>a+b.tss,0)/last28.length;
    if (chronic>0){ acRatio = (avgTSS*7/chronic).toFixed(2); acWarning = parseFloat(acRatio)>1.3; }
  }

  const html = `
    <div class="modal"><div class="modal-content">
      <div class="modal-header"><div class="modal-title">üìä WEEKLY ANALYSIS</div><button class="close-btn" onclick="closeModal()">‚úï Close</button></div>
      <p style="color:#888; margin-bottom:30px;">${startDate.toLocaleDateString()} - ${endDate.toLocaleDateString()}</p>
      <h3 style="color:#00ff88; margin-bottom:15px;">ELITE METRICS:</h3>
      <div class="metrics-grid">
        <div class="metric-card" style="border-left-color:#00ff88;"><div class="metric-value">${totalVolume.toLocaleString()}</div><div class="metric-label">Total Volume (lbs)</div></div>
        <div class="metric-card" style="border-left-color:#00ccff;"><div class="metric-value">${avgCNS}</div><div class="metric-label">Avg Daily CNS</div></div>
        <div class="metric-card" style="border-left-color:#ffaa00;"><div class="metric-value">${totalTSS}</div><div class="metric-label">Weekly TSS</div></div>
        <div class="metric-card" style="border-left-color:${acWarning?'#ff4444':'#ff6b35'};"><div class="metric-value" style="color:${acWarning?'#ff4444':'#00ff88'};">${acRatio}</div><div class="metric-label">Acute:Chronic Ratio</div></div>
        <div class="metric-card" style="border-left-color:#8a2be2;"><div class="metric-value">${monotony}</div><div class="metric-label">Monotony Index</div></div>
        <div class="metric-card" style="border-left-color:#ff69b4;"><div class="metric-value">${strain}</div><div class="metric-label">Strain Index</div></div>
      </div>
      ${acWarning?`
        <div class="warning-box">
          <h3>‚ö†Ô∏è INJURY RISK WARNING</h3>
          <p><strong>A:C ratio ${acRatio}</strong> (optimal 0.8‚Äì1.3)</p>
          <p>This week‚Äôs load is ${((parseFloat(acRatio)-1)*100).toFixed(0)}% above your 4-week average.</p>
          <ul style="margin-left:20px; margin-top:10px;">
            <li>Reduce volume 15‚Äì20% next week</li>
            <li>Add 1‚Äì2 extra rest days</li>
            <li>Prioritize sleep (‚â•8h), protein, mobility</li>
          </ul>
        </div>`:
        `<div class="success-box"><h3>‚úì TRAINING LOAD OPTIMAL</h3><p>A:C ${acRatio} within safe ranges‚Äîkeep building.</p></div>`
      }
    </div></div>`;
  document.getElementById('weekly-modal').innerHTML = html;
  document.getElementById('weekly-modal').classList.remove('hidden');
}

/* ================= INIT ================= */
window.onload = function(){ loadData(); renderCalendar(); };
</script>
</body>
</html>
