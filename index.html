<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>üèÜ ELITE ATHLETE TRAINING SYSTEM ‚Äî v10</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    :root{
      --bg:#0a0a0a; --panel:#1a1a1a; --ink:#fff; --muted:#888; --ink2:#ccc;
      --ok:#00ff88; --ok2:#00ccff; --warn:#ffaa00; --bad:#ff4444; --line:#333;
      --ring: rgba(0,255,136,.35);
    }
    body{background:var(--bg);color:var(--ink);font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Arial,sans-serif;line-height:1.6;padding:20px}
    .container{max-width:1600px;margin:0 auto}
    h1{font-size:42px;text-align:center;margin-bottom:8px;background:linear-gradient(90deg,#ff6b35, var(--ok), var(--ok2));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .subtitle{text-align:center;color:#666;margin-bottom:24px;font-size:14px}
    .calendar-header{display:flex;flex-wrap:wrap;gap:12px;justify-content:space-between;align-items:center;background:var(--panel);padding:16px;border-radius:12px;margin-bottom:16px;border:1px solid var(--line)}
    .calendar-nav button,.analysis-btn{background:#2a2a2a;color:#fff;border:1px solid #3a3a3a;border-radius:8px;padding:10px 16px;font-weight:700;cursor:pointer}
    .calendar-nav button:hover{background:#3a3a3a}
    .analysis-btn{background:linear-gradient(135deg,var(--ok),var(--ok2));color:#000;border:none}
    .month-title{font-size:22px;color:var(--ok);font-weight:800;letter-spacing:.5px}
    .calendar-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
    .calendar-day-header{text-align:center;color:#aaa;font-weight:800;padding:8px}
    .calendar-day{background:var(--panel);border:2px solid var(--line);border-radius:10px;min-height:120px;padding:10px;position:relative;transition:.2s;cursor:pointer}
    .calendar-day:hover{transform:translateY(-2px);border-color:#555}
    .calendar-day.other-month{opacity:.35}
    .calendar-day.today{border-color:var(--ok);box-shadow:0 0 24px var(--ring)}
    .calendar-day.has-workouts{border-color:var(--ok2);background:rgba(0,204,255,.08)}
    .day-number{font-weight:900;margin-bottom:6px}
    .day-workouts{font-size:10px;color:#bbb}
    .workout-badge{display:inline-block;background:rgba(0,255,136,.15);border:1px solid rgba(0,255,136,.35);border-radius:6px;padding:2px 6px;margin:2px;font-weight:800}
    .cns-indicator{position:absolute;top:8px;right:8px;width:14px;height:14px;border-radius:999px;border:2px solid #000}
    .cns-low{background:var(--ok)} .cns-moderate{background:var(--warn)} .cns-high{background:var(--bad)}
    .hidden{display:none}
    /* MODALS */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.95);z-index:50;overflow:auto;padding:20px}
    .modal-content{max-width:1400px;margin:0 auto;background:var(--bg);border:2px solid var(--ok);border-radius:14px;padding:28px}
    .modal-header{display:flex;flex-wrap:wrap;gap:12px;justify-content:space-between;align-items:center;margin-bottom:16px}
    .modal-title{font-size:26px;color:var(--ok);font-weight:900}
    .close-btn{background:var(--bad);border:none;color:#fff;font-weight:800;border-radius:8px;padding:10px 16px;cursor:pointer}
    .modality-checkboxes{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:10px;background:var(--panel);border-radius:12px;border:1px solid var(--line);padding:16px;margin-bottom:14px}
    .modality-checkbox{display:flex;gap:10px;align-items:center;border:2px solid #333;border-radius:10px;padding:12px;background:#0c0c0c;cursor:pointer}
    .modality-checkbox:hover{border-color:#555}
    .modality-checkbox.checked{border-color:var(--ok);background:rgba(0,255,136,.07)}
    .modality-section{background:var(--panel);border:2px solid var(--ok2);border-radius:12px;padding:20px;margin-bottom:16px}
    .modality-section h2{color:var(--ok2);margin-bottom:10px}
    .rpe-btn{background:#2d2d2d;border:1px solid #444;border-radius:8px;color:#eee;font-weight:800;padding:8px 12px;cursor:pointer;margin-bottom:12px}
    .input, select, textarea{width:100%;background:#0c0c0c;border:2px solid #333;border-radius:8px;color:#fff;padding:10px}
    .input:focus, select:focus, textarea:focus{outline:none;border-color:var(--ok)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .exercise-block{background:#0b0b0b;border:1px solid #2f2f2f;border-radius:10px;padding:14px;margin-bottom:12px}
    .set-row{display:grid;grid-template-columns:1fr 1fr 1fr 40px;gap:8px;margin-top:8px}
    .add-btn{background:#151515;border:2px dashed #3f3f3f;color:#bbb;border-radius:8px;padding:10px;font-weight:800;cursor:pointer;margin-top:8px}
    .add-exercise-btn{background:linear-gradient(135deg,#232323,#111);border:2px solid var(--ok);color:var(--ok);border-radius:10px;padding:12px;font-weight:900;cursor:pointer;margin-top:10px;width:100%}
    .save-day-btn{background:linear-gradient(135deg,var(--ok),var(--ok2));border:none;color:#000;border-radius:12px;padding:16px;font-weight:900;cursor:pointer;margin-top:16px;width:100%;box-shadow:0 12px 30px rgba(0,255,136,.15)}
    .metric-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin:14px 0}
    .metric{background:#0b0b0b;border-left:4px solid var(--ok2);border-radius:10px;padding:14px}
    .metric .v{font-size:26px;font-weight:900;color:var(--ok)}
    .badge{display:inline-block;font-size:12px;padding:2px 6px;border-radius:6px;border:1px solid #444;color:#ccc}
    .warning{background:rgba(255,68,68,.15);border:1px solid var(--bad);border-radius:10px;padding:14px}
    .info{background:rgba(0,204,255,.15);border:1px solid var(--ok2);border-radius:10px;padding:14px}
    .success{background:rgba(0,255,136,.12);border:1px solid var(--ok);border-radius:10px;padding:14px}
    .upload-zone{border:2px dashed #3a3a3a;border-radius:10px;padding:16px;text-align:center;margin-top:8px;cursor:pointer}
    .upload-zone.has-file{border-color:var(--ok);background:rgba(0,255,136,.06)}
    .hr-preview{max-width:100%;max-height:280px;border-radius:10px;margin-top:10px;border:1px solid #222}
    @media (max-width:768px){
      h1{font-size:28px}
      .calendar-day{min-height:92px;padding:8px}
      .set-row{grid-template-columns:1fr 1fr 40px}
      .row{grid-template-columns:1fr}
      .modal-content{padding:16px}
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üèÜ ELITE ATHLETE TRAINING SYSTEM</h1>
    <p class="subtitle">Full Periodization ‚Ä¢ Load Management ‚Ä¢ Injury Prevention ‚Ä¢ Performance Optimization</p>

    <div class="calendar-header">
      <div class="calendar-nav">
        <button onclick="previousMonth()">‚Äπ Prev</button>
        <button onclick="goToToday()">Today</button>
        <button onclick="nextMonth()">Next ‚Ä∫</button>
      </div>
      <div class="month-title" id="month-title">‚Äî</div>
      <button class="analysis-btn" onclick="showWeeklyAnalysis()">üìä Weekly Analysis</button>
    </div>

    <div class="calendar-grid" id="calendar-grid"></div>
    <div id="day-modal" class="hidden"></div>
    <div id="weekly-modal" class="hidden"></div>
    <div id="rpe-modal" class="hidden"></div>
  </div>

  <script>
    /* ===========================
       STATE & PERSISTENCE
    ============================*/
    let currentDate = new Date();
    let trainingData = {};        // { 'YYYY-MM-DD': { modalities: {...}, totalCNS, totalVolume, tss, qualities, interference } }
    let historicalTSS = [];       // last 28 entries of {date,tss}
    let hrData = {};              // per-modality parsed HR analysis
    let exerciseCounters = {};
    let setCounters = {};

    const STORAGE_KEY_DATA = 'eliteTrainingData_v10';
    const STORAGE_KEY_TSS  = 'eliteTrainingTSS_v10';

    function loadData(){
      try{
        const a = localStorage.getItem(STORAGE_KEY_DATA);
        const b = localStorage.getItem(STORAGE_KEY_TSS);
        if(a) trainingData = JSON.parse(a);
        if(b) historicalTSS = JSON.parse(b);
      }catch{}
    }
    function saveData(){
      localStorage.setItem(STORAGE_KEY_DATA, JSON.stringify(trainingData));
      localStorage.setItem(STORAGE_KEY_TSS, JSON.stringify(historicalTSS));
    }

    /* ===========================
       CALENDAR RENDER
    ============================*/
    function renderCalendar(){
      const y = currentDate.getFullYear();
      const m = currentDate.getMonth();
      const monthNames = ['JANUARY','FEBRUARY','MARCH','APRIL','MAY','JUNE','JULY','AUGUST','SEPTEMBER','OCTOBER','NOVEMBER','DECEMBER'];
      document.getElementById('month-title').textContent = monthNames[m] + ' ' + y;

      const grid = document.getElementById('calendar-grid');
      grid.innerHTML = '';

      ['SUN','MON','TUE','WED','THU','FRI','SAT'].forEach(d=>{
        const h = document.createElement('div');
        h.className = 'calendar-day-header';
        h.textContent = d;
        grid.appendChild(h);
      });

      const firstDay = new Date(y,m,1).getDay();
      const daysInMonth = new Date(y,m+1,0).getDate();
      const daysPrev    = new Date(y,m,0).getDate();
      const todayStr = fmtDate(new Date());

      for(let i = firstDay-1; i>=0; i--){
        const d = daysPrev - i;
        createDayCell(grid, new Date(y,m-1,d), true, todayStr);
      }
      for(let d=1; d<=daysInMonth; d++){
        createDayCell(grid, new Date(y,m,d), false, todayStr);
      }
      const totalCells = firstDay + daysInMonth;
      const rem = totalCells <= 35 ? 35-totalCells : 42-totalCells;
      for(let d=1; d<=rem; d++){
        createDayCell(grid, new Date(y,m+1,d), true, todayStr);
      }
    }
    function createDayCell(grid, date, otherMonth, todayStr){
      const cell = document.createElement('div');
      cell.className = 'calendar-day';
      if(otherMonth) cell.classList.add('other-month');

      const dateStr = fmtDate(date);
      if(dateStr === todayStr) cell.classList.add('today');

      const dayData = trainingData[dateStr];

      const dn = document.createElement('div');
      dn.className = 'day-number';
      dn.textContent = date.getDate();
      cell.appendChild(dn);

      if(dayData && dayData.modalities){
        cell.classList.add('has-workouts');
        const workouts = document.createElement('div');
        workouts.className = 'day-workouts';
        Object.keys(dayData.modalities).forEach(t=>{
          if(dayData.modalities[t]?.completed){
            const b = document.createElement('span');
            b.className = 'workout-badge';
            b.textContent = t.toUpperCase();
            workouts.appendChild(b);
          }
        });
        cell.appendChild(workouts);

        const cns = dayData.totalCNS || 0;
        const ind = document.createElement('div');
        ind.className = 'cns-indicator';
        if(cns < 60) ind.classList.add('cns-low');
        else if(cns < 75) ind.classList.add('cns-moderate');
        else ind.classList.add('cns-high');
        cell.appendChild(ind);
      }

      cell.onclick = ()=>openDay(dateStr, date);
      grid.appendChild(cell);
    }
    function fmtDate(d){
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const da= String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${da}`;
    }
    function previousMonth(){ currentDate.setMonth(currentDate.getMonth()-1); renderCalendar(); }
    function nextMonth(){ currentDate.setMonth(currentDate.getMonth()+1); renderCalendar(); }
    function goToToday(){ currentDate = new Date(); renderCalendar(); }

    /* ===========================
       DAY VIEW
    ============================*/
    let currentEditingDate = null;

    function openDay(dateStr, date){
      currentEditingDate = dateStr;
      const dayData = trainingData[dateStr] || { modalities:{} };
      exerciseCounters = {}; setCounters = {};

      const html = `
        <div class="modal">
          <div class="modal-content">
            <div class="modal-header">
              <div class="modal-title">${date.toLocaleDateString('en-US',{weekday:'long',year:'numeric',month:'long',day:'numeric'})}</div>
              <button class="close-btn" onclick="closeModal()">‚úï Close</button>
            </div>

            <h3 style="margin:6px 0 10px 0;color:var(--ok)">Select training modalities for today</h3>
            <div class="modality-checkboxes">
              ${['chest','back','legs','track','bike','bjj','walking'].map(type=>{
                const ck = dayData.modalities?.[type] ? 'checked' : '';
                const ch = dayData.modalities?.[type] ? 'checked' : '';
                const emoji = {chest:'üí™',back:'üí™',legs:'ü¶µ',track:'üèÉ',bike:'üö¥',bjj:'ü•ã',walking:'üö∂'}[type];
                return `
                <div class="modality-checkbox ${ck}" onclick="toggleModality('${type}')">
                  <input type="checkbox" id="check-${type}" ${ch} />
                  <label for="check-${type}">${emoji} ${type.toUpperCase()}</label>
                </div>`;
              }).join('')}
            </div>

            <div id="form-chest"   class="hidden modality-section"></div>
            <div id="form-back"    class="hidden modality-section"></div>
            <div id="form-legs"    class="hidden modality-section"></div>
            <div id="form-track"   class="hidden modality-section"></div>
            <div id="form-bike"    class="hidden modality-section"></div>
            <div id="form-bjj"     class="hidden modality-section"></div>
            <div id="form-walking" class="hidden modality-section"></div>

            <button class="save-day-btn" onclick="saveDay('${dateStr}')">‚úì Save All & Analyze</button>
          </div>
        </div>
      `;
      el('day-modal').innerHTML = html;
      el('day-modal').classList.remove('hidden');

      // show pre-existing
      Object.keys(dayData.modalities||{}).forEach(type=>{
        if(dayData.modalities[type]){
          showModalityForm(type, dayData.modalities[type]);
        }
      });
    }

    function toggleModality(type){
      const cb = el('check-'+type);
      cb.checked = !cb.checked;
      cb.parentElement.classList.toggle('checked');
      if(cb.checked) showModalityForm(type, trainingData[currentEditingDate]?.modalities?.[type] || null);
      else el('form-'+type).classList.add('hidden');
    }

    function showModalityForm(type, data=null){
      const form = el('form-'+type);
      form.classList.remove('hidden');
      if(type==='chest'||type==='back'||type==='legs'){
        form.innerHTML = genWeightForm(type, data);
        if(!exerciseCounters[type]) exerciseCounters[type]=0;
        if(!(data && data.exercises)) addExercise(type); // seed
        if(data && data.exercises) { // hydrate
          data.exercises.forEach(ex=>{
            addExercise(type, ex);
          });
        }
      }else if(type==='track'){
        form.innerHTML = genTrackForm(data);   // *** upgraded per your spec ***
      }else if(type==='bike'){
        form.innerHTML = genBikeForm(data);
      }else if(type==='bjj'){
        form.innerHTML = genBJJForm(data);
      }else if(type==='walking'){
        form.innerHTML = genWalkForm(data);
      }
    }

    /* ===========================
       FORMS ‚Äî WEIGHTS (Chest/Back/Legs)
    ============================*/
    function genWeightForm(type, data){
      return `
        <h2>üí™ ${type.toUpperCase()} TRAINING</h2>
        <button class="rpe-btn" onclick="showRPEGuide()">‚ùì RPE Reference</button>
        <div id="${type}-exercises"></div>
        <button class="add-exercise-btn" onclick="addExercise('${type}')">+ Add Exercise</button>

        <h3 style="margin:14px 0 8px;color:var(--ok2)">Session Details</h3>
        <div class="row">
          <div>
            <label class="badge">Overall feeling</label>
            <select id="${type}-feeling">
              <option value="">Choose‚Ä¶</option>
              <option value="great">Great</option>
              <option value="good">Good</option>
              <option value="tired">Tired</option>
              <option value="beat">Beat up</option>
            </select>
          </div>
          <div>
            <label class="badge">Sleep last night (hours)</label>
            <input id="${type}-sleep" class="input" type="number" step="0.25" value="${data?.sleep||''}" placeholder="7.5"/>
          </div>
        </div>

        <div class="upload-zone" id="${type}-upload" onclick="el('${type}-hr').click()">üìä Upload Polar HR screenshot (optional)</div>
        <input id="${type}-hr" style="display:none" type="file" accept="image/*" onchange="handleHRUpload('${type}',event)"/>
        <img id="${type}-hr-preview" class="hr-preview hidden"/>
      `;
    }
    function addExercise(type, preset=null){
      exerciseCounters[type]=(exerciseCounters[type]||0)+1;
      const exId = `${type}-ex${exerciseCounters[type]}`;
      setCounters[exId]={warmup:0,working:0};
      const ex = preset || {name:'',muscleGroup:'', workingSets:[]};
      const block = `
        <div class="exercise-block" id="${exId}">
          <input class="input exercise-name" placeholder="Exercise name (e.g., Bench Press, Squat)" value="${esc(ex.name)}"/>
          <select class="muscle-select">
            ${opt('', 'Select muscle group‚Ä¶', ex.muscleGroup=== '')}
            ${opt('chest','Chest', ex.muscleGroup==='chest')}
            ${opt('back','Back', ex.muscleGroup==='back')}
            ${opt('shoulders','Shoulders', ex.muscleGroup==='shoulders')}
            ${opt('biceps','Biceps', ex.muscleGroup==='biceps')}
            ${opt('triceps','Triceps', ex.muscleGroup==='triceps')}
            ${opt('quads','Quads', ex.muscleGroup==='quads')}
            ${opt('hamstrings','Hamstrings', ex.muscleGroup==='hamstrings')}
            ${opt('glutes','Glutes', ex.muscleGroup==='glutes')}
            ${opt('calves','Calves', ex.muscleGroup==='calves')}
            ${opt('core','Core', ex.muscleGroup==='core')}
          </select>

          <div class="badge" style="margin-top:6px">Warm-up sets</div>
          <div id="${exId}-warmup"></div>
          <button class="add-btn" onclick="addSet('${exId}','warmup')">+ Add Warm-up</button>

          <div class="badge" style="margin-top:10px">Working sets</div>
          <div id="${exId}-working"></div>
          <button class="add-btn" onclick="addSet('${exId}','working')">+ Add Working</button>
        </div>
      `;
      el(type+'-exercises').insertAdjacentHTML('beforeend', block);
      // hydrate sets if preset
      if(preset?.workingSets?.length){
        preset.workingSets.forEach(s=>{
          addSet(exId,'working',s);
        });
      }else{
        // sensible defaults
        addSet(exId,'warmup'); addSet(exId,'warmup');
        addSet(exId,'working'); addSet(exId,'working'); addSet(exId,'working');
      }
    }
    function addSet(exId, kind, preset=null){
      setCounters[exId][kind]++;
      const sid = `${exId}-${kind}${setCounters[exId][kind]}`;
      const weight = preset?.weight ?? '';
      const reps   = preset?.reps ?? '';
      const rpe    = preset?.rpe ?? '';
      const rpeCell = (kind==='warmup') ? '' : `<input class="${kind}-rpe input" type="number" step="0.5" placeholder="RPE" value="${rpe}">`;
      const row = `
        <div class="set-row" id="${sid}">
          <input class="${kind}-weight input" type="number" placeholder="Weight (lbs)" value="${weight}">
          <input class="${kind}-reps input"   type="number" placeholder="Reps" value="${reps}">
          ${rpeCell}
          <button class="close-btn" style="padding:0;height:40px" onclick="el('${sid}').remove()">‚úï</button>
        </div>
      `;
      el(`${exId}-${kind}`).insertAdjacentHTML('beforeend', row);
    }

    /* ===========================
       FORM ‚Äî TRACK / PLYOMETRICS  (Upgraded per your spec)
       - Per-exercise row with:
         name, subtype (jumps/hops/bounds/sprint), surface (flat/track/STAIRS),
         unit (yards/meters/steps), distanceOrSteps, flights/columns (for stairs),
         jumpsPerUnit (for stairs = jumps/step; for flat = contacts per 10m default 1 for sprints),
         sets, reps
       - Contacts computed = units * jumpsPerUnit * sets * reps  (+ for stairs, units = stepsPerFlight * flights)
    ============================*/
    function genTrackForm(data){
      return `
        <h2>üèÉ TRACK / PLYOMETRICS</h2>
        <div id="track-ex-list"></div>
        <button class="add-exercise-btn" onclick="addTrackExercise()">+ Add Track/Plyo Item</button>

        <h3 style="margin:14px 0 8px;color:var(--ok2)">Session Details</h3>
        <div class="row">
          <div>
            <label class="badge">Energy level</label>
            <select id="track-energy">
              ${opt('','Choose‚Ä¶',!data?.energy)}
              ${opt('high','High',data?.energy==='high')}
              ${opt('moderate','Moderate',data?.energy==='moderate')}
              ${opt('low','Low',data?.energy==='low')}
            </select>
          </div>
          <div>
            <label class="badge">Achilles/calf status</label>
            <select id="track-achilles">
              ${opt('','Choose‚Ä¶',!data?.achilles)}
              ${opt('fresh','Fresh',data?.achilles==='fresh')}
              ${opt('tight','Tight',data?.achilles==='tight')}
              ${opt('sore','Sore',data?.achilles==='sore')}
            </select>
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <div>
            <label class="badge">Sleep last night (hours)</label>
            <input id="track-sleep" class="input" type="number" step="0.25" value="${data?.sleep||''}" placeholder="7.5"/>
          </div>
          <div>
            <label class="badge">Auto-computed plyometric contacts</label>
            <input id="track-contacts-auto" class="input" type="number" readonly placeholder="0"/>
          </div>
        </div>

        <div class="upload-zone" id="track-upload" onclick="el('track-hr').click()">üìä Upload Polar HR screenshot (optional)</div>
        <input id="track-hr" style="display:none" type="file" accept="image/*" onchange="handleHRUpload('track',event)"/>
        <img id="track-hr-preview" class="hr-preview hidden"/>
      `;
    }
    function addTrackExercise(preset=null){
      const container = el('track-ex-list');
      const id = 'trk-' + Math.random().toString(36).slice(2,8);
      const p = preset || { name:'', subtype:'jumps', surface:'flat', unit:'yards', distanceOrSteps:'', flights:1, jumpsPerUnit:'', sets:3, reps:5 };
      const row = `
        <div class="exercise-block" id="${id}">
          <div class="row">
            <input class="input trk-name" placeholder="Exercise (e.g., Depth Jump, Bounds, Box Jumps)" value="${esc(p.name)}"/>
            <select class="trk-subtype input">
              ${opt('jumps','Jumps',p.subtype==='jumps')}
              ${opt('hops','Hops',p.subtype==='hops')}
              ${opt('bounds','Bounds',p.subtype==='bounds')}
              ${opt('sprint','Sprint',p.subtype==='sprint')}
            </select>
          </div>

          <div class="row" style="margin-top:8px">
            <select class="trk-surface input" onchange="syncTrackUnit('${id}')">
              ${opt('flat','Flat/Track/Field',p.surface==='flat')}
              ${opt('stairs','Stadium Stairs',p.surface==='stairs')}
            </select>

            <select class="trk-unit input">
              ${opt('yards','Yards',p.unit==='yards')}
              ${opt('meters','Meters',p.unit==='meters')}
              ${opt('steps','Steps',p.unit==='steps')}
            </select>
          </div>

          <div class="row" style="margin-top:8px">
            <input class="input trk-distance" type="number" placeholder="Distance (yards/meters) OR steps per flight" value="${p.distanceOrSteps}"/>
            <input class="input trk-flights" type="number" placeholder="Flights / columns (stairs only)" value="${p.flights||1}"/>
          </div>

          <div class="row" style="margin-top:8px">
            <input class="input trk-jumpsPerUnit" type="number" step="0.1" placeholder="Contacts per unit (stairs: jumps/step; flat: contacts per 10m)" value="${p.jumpsPerUnit||''}"/>
            <input class="input trk-sets" type="number" placeholder="Sets" value="${p.sets||''}"/>
          </div>

          <div class="row" style="margin-top:8px">
            <input class="input trk-reps" type="number" placeholder="Reps per set" value="${p.reps||''}"/>
            <input class="input trk-contacts-out" type="number" placeholder="Contacts (auto)" readonly/>
          </div>

          <button class="add-btn" onclick="computeTrackRowContacts('${id}')">‚Üª Compute Contacts</button>
        </div>
      `;
      container.insertAdjacentHTML('beforeend', row);
    }
    function syncTrackUnit(id){
      const root = el(id);
      const surface = root.querySelector('.trk-surface').value;
      const unitSel = root.querySelector('.trk-unit');
      if(surface==='stairs'){ unitSel.value='steps'; }
      computeTrackRowContacts(id);
    }
    function computeTrackRowContacts(id){
      const r = el(id);
      const surface = r.querySelector('.trk-surface').value;
      const unit    = r.querySelector('.trk-unit').value;
      const dist    = num(r.querySelector('.trk-distance').value);
      const flights = num(r.querySelector('.trk-flights').value || 1);
      const jpu     = num(r.querySelector('.trk-jumpsPerUnit').value); // stairs: jumps/step; flat: contacts per 10m
      const sets    = num(r.querySelector('.trk-sets').value || 0);
      const reps    = num(r.querySelector('.trk-reps').value || 0);

      let units = 0; // base factor
      if(surface==='stairs'){
        // units = total steps = stepsPerFlight * flights
        units = dist * flights;
      }else{
        // flat distance units; interpret jpu as contacts per 10 meters (or per 10.94 yards)
        // normalize distance to meters
        const meters = (unit==='yards') ? dist*0.9144 : dist;
        const blocks = meters/10; // number of 10m blocks
        units = blocks;
      }

      // contacts per set = units * jpu * reps
      const contacts = Math.max(0, Math.round(units * jpu * Math.max(1,reps)) ) * Math.max(1,sets);

      r.querySelector('.trk-contacts-out').value = contacts;

      // update session aggregate
      computeTrackTotalContacts();
      return contacts;
    }
    function computeTrackTotalContacts(){
      const rows = [...document.querySelectorAll('#track-ex-list .exercise-block')];
      const total = rows.reduce((s,row)=>{
        const v = num(row.querySelector('.trk-contacts-out').value);
        return s + (isNaN(v)?0:v);
      },0);
      const out = el('track-contacts-auto');
      if(out) out.value = total;
      return total;
    }

    /* ===========================
       FORM ‚Äî BIKE / BJJ / WALK
    ============================*/
    function genBikeForm(data){
      return `
        <h2>üö¥ ASSAULT BIKE</h2>
        <div class="row">
          <div>
            <label class="badge">Protocol</label>
            <select id="bike-protocol">
              ${opt('','Choose‚Ä¶',!data?.protocol)}
              ${opt('peak-rpm','Peak RPM Sprints',data?.protocol==='peak-rpm')}
              ${opt('zone5','Zone 5 Intervals',data?.protocol==='zone5')}
              ${opt('alternating','Alternating Pace',data?.protocol==='alternating')}
              ${opt('steady','Steady State',data?.protocol==='steady')}
            </select>
          </div>
          <div>
            <label class="badge">Total time (min)</label>
            <input id="bike-time" class="input" type="number" value="${data?.time||''}" placeholder="22"/>
          </div>
        </div>
        <div class="row" style="margin-top:8px">
          <input id="bike-rpm" class="input" type="number" placeholder="Peak RPM" value="${data?.rpm||''}"/>
          <input id="bike-intervals" class="input" type="number" placeholder="# intervals" value="${data?.intervals||''}"/>
        </div>
        <div class="row" style="margin-top:8px">
          <select id="bike-breathing" class="input">
            ${opt('','Breathing quality‚Ä¶',!data?.breathing)}
            ${opt('strong','Strong',data?.breathing==='strong')}
            ${opt('moderate','Moderate',data?.breathing==='moderate')}
            ${opt('labored','Labored',data?.breathing==='labored')}
          </select>
          <select id="bike-feeling" class="input">
            ${opt('','Overall feeling‚Ä¶',!data?.feeling)}
            ${opt('great','Great',data?.feeling==='great')}
            ${opt('good','Good',data?.feeling==='good')}
            ${opt('tired','Tired',data?.feeling==='tired')}
            ${opt('beat','Beat up',data?.feeling==='beat')}
          </select>
        </div>
        <div class="row" style="margin-top:8px">
          <input id="bike-sleep" class="input" type="number" step="0.25" placeholder="Sleep (h)" value="${data?.sleep||''}"/>
          <div></div>
        </div>
        <div class="upload-zone" id="bike-upload" onclick="el('bike-hr').click()">üìä Upload Polar HR screenshot (RECOMMENDED)</div>
        <input id="bike-hr" style="display:none" type="file" accept="image/*" onchange="handleHRUpload('bike',event)"/>
        <img id="bike-hr-preview" class="hr-preview hidden"/>
      `;
    }
    function genBJJForm(data){
      return `
        <h2>ü•ã JIU JITSU</h2>
        <div class="row">
          <input id="bjj-time" class="input" type="number" placeholder="Spar time (min)" value="${data?.time||''}"/>
          <select id="bjj-intensity" class="input">
            ${opt('','Intensity‚Ä¶',!data?.intensity)}
            ${opt('high','High',data?.intensity==='high')}
            ${opt('medium','Medium',data?.intensity==='medium')}
            ${opt('light','Light',data?.intensity==='light')}
          </select>
        </div>
        <div class="row" style="margin-top:8px">
          <input id="bjj-weight-before" class="input" type="number" step="0.1" placeholder="Weight before (lb)" value="${data?.weightBefore||''}"/>
          <input id="bjj-weight-after"  class="input" type="number" step="0.1" placeholder="Weight after (lb)"  value="${data?.weightAfter||''}"/>
        </div>
        <div class="row" style="margin-top:8px">
          <select id="bjj-feeling" class="input">
            ${opt('','Overall feeling‚Ä¶',!data?.feeling)}
            ${opt('great','Great',data?.feeling==='great')}
            ${opt('good','Good',data?.feeling==='good')}
            ${opt('tired','Tired',data?.feeling==='tired')}
            ${opt('beat','Beat up',data?.feeling==='beat')}
          </select>
          <input id="bjj-sleep" class="input" type="number" step="0.25" placeholder="Sleep (h)" value="${data?.sleep||''}"/>
        </div>
        <div class="upload-zone" id="bjj-upload" onclick="el('bjj-hr').click()">üìä Upload Polar HR screenshot (optional)</div>
        <input id="bjj-hr" style="display:none" type="file" accept="image/*" onchange="handleHRUpload('bjj',event)"/>
        <img id="bjj-hr-preview" class="hr-preview hidden"/>
      `;
    }
    function genWalkForm(data){
      return `
        <h2>üö∂ WALKING / RECOVERY</h2>
        <div class="row">
          <input id="walking-duration" class="input" type="number" placeholder="Duration (min)" value="${data?.duration||''}"/>
          <input id="walking-distance" class="input" type="number" step="0.1" placeholder="Distance (mi)" value="${data?.distance||''}"/>
        </div>
        <div class="row" style="margin-top:8px">
          <input id="walking-pace" class="input" type="number" step="0.1" placeholder="Avg pace (min/mi)" value="${data?.pace||''}"/>
          <select id="walking-terrain" class="input">
            ${opt('','Terrain‚Ä¶',!data?.terrain)}
            ${opt('flat','Flat',data?.terrain==='flat')}
            ${opt('hills','Hills',data?.terrain==='hills')}
            ${opt('steep','Steep',data?.terrain==='steep')}
          </select>
        </div>
        <div class="row" style="margin-top:8px">
          <select id="walking-purpose" class="input">
            ${opt('','Purpose‚Ä¶',!data?.purpose)}
            ${opt('recovery','Active Recovery',data?.purpose==='recovery')}
            ${opt('zone2','Zone 2 Cardio',data?.purpose==='zone2')}
            ${opt('general','General Activity',data?.purpose==='general')}
          </select>
          <div></div>
        </div>
        <div class="upload-zone" id="walking-upload" onclick="el('walking-hr').click()">üìä Upload Polar HR screenshot (optional)</div>
        <input id="walking-hr" style="display:none" type="file" accept="image/*" onchange="handleHRUpload('walking',event)"/>
        <img id="walking-hr-preview" class="hr-preview hidden"/>
      `;
    }

    /* ===========================
       HR SCREENSHOT ‚Üí AI PARSE
       (Set your Anthropic API key below)
    ============================*/
    const ANTHROPIC_API_KEY = "PASTE_YOUR_ANTHROPIC_KEY_HERE"; // <-- REQUIRED for auto-parse
    async function handleHRUpload(type, event){
      const file = event.target.files?.[0];
      if(!file) return;
      const preview = el(type+'-hr-preview');
      const zone = el(type+'-upload');

      const reader = new FileReader();
      reader.onload = e=>{
        preview.src = e.target.result;
        preview.classList.remove('hidden');
        zone.classList.add('has-file');
        zone.innerHTML = 'üìä HR data uploaded ‚Äî analyzing‚Ä¶';
      };
      reader.readAsDataURL(file);

      try{
        const base64 = await fileToBase64Data(file);
        // If no key, gracefully skip AI call but keep preview
        if(!ANTHROPIC_API_KEY || ANTHROPIC_API_KEY.includes('PASTE_')){
          zone.innerHTML = '‚ö†Ô∏è No API key set. Enter your key in code to enable auto-analysis. You can still save today and enter HR-derived fields manually.';
          return;
        }

        const resp = await fetch("https://api.anthropic.com/v1/messages",{
          method:"POST",
          headers:{
            "content-type":"application/json",
            "x-api-key": ANTHROPIC_API_KEY,
            "anthropic-version":"2023-06-01"
          },
          body: JSON.stringify({
            model:"claude-3-5-sonnet-20241022",
            max_tokens: 800,
            messages:[{
              role:"user",
              content:[
                {type:"image", source:{type:"base64", media_type:file.type||"image/jpeg", data:base64}},
                {type:"text", text:
`Analyze this Polar HR graph. Reply ONLY valid JSON:

{
  "peakHR": number,
  "avgHR": number,
  "timeInZone5": number,  // minutes in 90‚Äì100% of max HR
  "timeInZone4": number,  // 80‚Äì90%
  "timeInZone3": number,  // 70‚Äì80%
  "timeInZone2": number,  // 60‚Äì70%
  "recovery": "good" | "moderate" | "poor",
  "notes": "brief analysis"
}

No extra text; no markdown.`
                }
              ]
            }]
          })
        });
        const js = await resp.json();
        let txt = js?.content?.[0]?.text || '';
        txt = txt.replace(/```json|```/g,'').trim();

        const parsed = JSON.parse(txt);
        hrData[type] = parsed;

        zone.innerHTML = `‚úì HR Analysis
          <div style="font-size:12px;color:var(--ok)">
            Peak ${parsed.peakHR} bpm ¬∑ Avg ${parsed.avgHR} bpm ¬∑ Recovery ${parsed.recovery}<br/>
            Z5 ${parsed.timeInZone5}m ¬∑ Z4 ${parsed.timeInZone4}m ¬∑ Z3 ${parsed.timeInZone3}m ¬∑ Z2 ${parsed.timeInZone2}m
          </div>`;
      }catch(e){
        console.error(e);
        zone.innerHTML = '‚ö†Ô∏è Analysis failed. You can proceed and metrics will compute without HR, or set a valid API key.';
      }
    }
    function fileToBase64Data(file){
      return new Promise((res,rej)=>{
        const r = new FileReader();
        r.onload = ()=>{ try{
          const base64 = String(r.result).split(',')[1]; res(base64);
        }catch(e){ rej(e) } };
        r.onerror = ()=>rej(new Error('read fail'));
        r.readAsDataURL(file);
      });
    }

    /* ===========================
       SAVE DAY ‚Üí SCIENCE METRICS
    ============================*/
    async function saveDay(dateStr){
      const out = { modalities:{}, totalCNS:0, totalVolume:0, tss:0, qualities:{}, interference:[] };

      for(const type of ['chest','back','legs','track','bike','bjj','walking']){
        const cb = el('check-'+type);
        if(cb && cb.checked){
          const md = await collectModality(type);
          if(md){ out.modalities[type]=md; out.modalities[type].completed=true; }
        }
      }
      if(Object.keys(out.modalities).length===0){ alert('Select at least one modality.'); return; }

      // combine
      Object.values(out.modalities).forEach(m=>{
        out.totalCNS += m.cnsScore||0;
        out.totalVolume += m.volume||0;
        out.tss += m.tss||0;
      });

      out.qualities = analyzeQualities(out.modalities);
      out.interference = detectInterference(out.modalities, out.qualities);

      trainingData[dateStr]=out;
      historicalTSS.push({date:dateStr, tss:out.tss});
      if(historicalTSS.length>28) historicalTSS.shift();
      saveData();

      displayDayAnalysis(dateStr, out);
      renderCalendar();
    }

    async function collectModality(type){
      const data = { type };
      if(type==='chest'||type==='back'||type==='legs'){
        const list = [...document.querySelectorAll(`#${type}-exercises .exercise-block`)];
        const exercises = [];
        for(const block of list){
          const name = val(block,'.exercise-name');
          const muscleGroup = val(block,'.muscle-select');
          if(!name || !muscleGroup) continue;

          const workingSets = [];
          const w = [...block.querySelectorAll('.working-weight')];
          const r = [...block.querySelectorAll('.working-reps')];
          const p = [...block.querySelectorAll('.working-rpe')];
          for(let i=0;i<w.length;i++){
            const weight = num(w[i].value); const reps = parseInt(r[i].value||'0',10);
            const rpe = num(p[i]?.value||0);
            if(weight>0 && reps>0) workingSets.push({weight,reps,rpe});
          }
          if(workingSets.length) exercises.push({name,muscleGroup,workingSets});
        }
        if(!exercises.length) return null;
        data.exercises = exercises;
        data.feeling = idv(type+'-feeling');
        data.sleep   = num(idv(type+'-sleep'));
        data.hrAnalysis = hrData[type]||null;

        Object.assign(data, calcWeightsMetrics(data));
      }
      else if(type==='track'){
        const rows = [...document.querySelectorAll('#track-ex-list .exercise-block')];
        const items = rows.map(row=>{
          const name = row.querySelector('.trk-name').value.trim();
          const subtype = row.querySelector('.trk-subtype').value;
          const surface = row.querySelector('.trk-surface').value;
          const unit = row.querySelector('.trk-unit').value;
          const distanceOrSteps = num(row.querySelector('.trk-distance').value);
          const flights = num(row.querySelector('.trk-flights').value || 1);
          const jpu = num(row.querySelector('.trk-jumpsPerUnit').value);
          const sets = num(row.querySelector('.trk-sets').value||0);
          const reps = num(row.querySelector('.trk-reps').value||0);
          const contacts = computeTrackRowContacts(row.id);
          return {name,subtype,surface,unit,distanceOrSteps,flights,jumpsPerUnit:jpu,sets,reps,contacts};
        }).filter(x=>x.name);

        data.items = items;
        data.contacts = num(idv('track-contacts-auto')) || items.reduce((s,a)=>s+(a.contacts||0),0);
        data.energy   = idv('track-energy');
        data.achilles = idv('track-achilles');
        data.sleep    = num(idv('track-sleep'));
        data.hrAnalysis = hrData['track']||null;

        Object.assign(data, calcTrackMetrics(data));
      }
      else if(type==='bike'){
        data.protocol  = idv('bike-protocol');
        data.time      = num(idv('bike-time'));
        data.rpm       = num(idv('bike-rpm'));
        data.intervals = num(idv('bike-intervals'));
        data.breathing = idv('bike-breathing');
        data.feeling   = idv('bike-feeling');
        data.sleep     = num(idv('bike-sleep'));
        data.hrAnalysis = hrData['bike']||null;

        Object.assign(data, calcBikeMetrics(data));
      }
      else if(type==='bjj'){
        data.time         = num(idv('bjj-time'));
        data.intensity    = idv('bjj-intensity');
        data.weightBefore = num(idv('bjj-weight-before'));
        data.weightAfter  = num(idv('bjj-weight-after'));
        data.weightLoss   = +(data.weightBefore - data.weightAfter).toFixed(1);
        data.feeling      = idv('bjj-feeling');
        data.sleep        = num(idv('bjj-sleep'));
        data.hrAnalysis   = hrData['bjj']||null;

        Object.assign(data, calcBJJMetrics(data));
      }
      else if(type==='walking'){
        data.duration = num(idv('walking-duration'));
        data.distance = num(idv('walking-distance'));
        data.pace     = num(idv('walking-pace'));
        data.terrain  = idv('walking-terrain');
        data.purpose  = idv('walking-purpose');
        data.hrAnalysis = hrData['walking']||null;

        Object.assign(data, calcWalkMetrics(data));
      }
      return data;
    }

    /* ===========================
       METRICS ‚Äî SCIENCE-BASED
    ============================*/
    // Strength/Hypertrophy: tonnage + intensity via RPE -> CNS; TSS = duration*intensity (proxy)
    function calcWeightsMetrics(data){
      let cns=40, vol=0, rpeSum=0, rpeN=0, est1RMTop=0;

      data.exercises.forEach(ex=>{
        ex.workingSets.forEach(s=>{
          vol += s.weight * s.reps; // lbs
          if(s.rpe){ rpeSum+=s.rpe; rpeN++; }
          // simple Epley estimate for the heaviest top set (uses RPE as quality gate)
          const e1rm = s.weight * (1 + s.reps/30);
          if(s.rpe>=8 && e1rm>est1RMTop) est1RMTop=e1rm;
        });
      });
      const avgRPE = rpeN? (rpeSum/rpeN):0;

      // CNS adjustments
      if(data.feeling==='beat') cns+=18;
      if(data.feeling==='tired') cns+=10;
      if(data.feeling==='great') cns-=8;
      if(avgRPE>=9) cns+=12; else if(avgRPE>=8.5) cns+=8; else if(avgRPE<=7) cns-=6;
      if(data.sleep<6.5) cns+=12; else if(data.sleep>=8) cns-=6;

      // HR integration if present
      if(data.hrAnalysis){
        const hr=data.hrAnalysis;
        if(hr.avgHR>=160) cns+=8;
        if(hr.recovery==='poor') cns+=8; else if(hr.recovery==='good') cns-=4;
        if(hr.timeInZone5>5) cns+=6;
      }

      // TSS proxy: assume 60 min session scaled by avgRPE/10
      const duration=60, intensity = clamp(avgRPE/10, 0.5, 1.0);
      const tss = Math.round(duration * intensity); // 0‚Äì60

      return {
        cnsScore: clamp(Math.round(cns),0,100),
        volume: Math.round(vol),
        avgRPE: +avgRPE.toFixed(1),
        estTopE1RM: Math.round(est1RMTop),
        tss
      };
    }

    // Track/Plyo: contacts scaled + risk factors (Achilles, energy, sleep) + HR zones if present
    function calcTrackMetrics(d){
      let cns=35;
      const contacts = d.contacts||0;

      // contacts weighting (depth/bounds > hops > sprint strides)
      // Approx: higher subtype -> more CNS per contact; use mix from items if present
      let subtypeBias = 0;
      (d.items||[]).forEach(it=>{
        const k = (it.subtype==='bounds')?1.4:(it.subtype==='jumps')?1.25:(it.subtype==='hops')?1.15:(it.subtype==='sprint')?1.0:1.0;
        subtypeBias += k * (it.contacts||0);
      });
      const contactsEff = subtypeBias>0 ? subtypeBias : contacts;

      cns += Math.min(30, Math.round(contactsEff/80)); // ~80 contacts ‚Üí +1
      if(d.energy==='low') cns+=14;
      if(d.achilles==='sore') cns+=18; else if(d.achilles==='tight') cns+=8;
      if(d.sleep<7) cns+=10;

      if(d.hrAnalysis){
        const hr=d.hrAnalysis;
        if(hr.avgHR>=170) cns+=10;
        if(hr.timeInZone5>10) cns+=10;
      }

      // TSS proxy: base 60 + contacts/2 (bounded)
      const tss = clamp(60 + Math.round(contacts/2), 30, 180);

      return {
        cnsScore: clamp(Math.round(cns),0,100),
        volume: 0,
        tss
      };
    }

    // Bike: TRIMP-like with HR zones if available; otherwise protocol heuristics
    function calcBikeMetrics(b){
      let cns=45;
      if(b.breathing==='labored') cns+=16;
      if(b.feeling==='beat') cns+=14; else if(b.feeling==='tired') cns+=8;
      if(b.sleep<7) cns+=8;

      // HR-based TRIMP-ish
      let tss=0;
      if(b.hrAnalysis){
        const z2=b.hrAnalysis.timeInZone2||0, z3=b.hrAnalysis.timeInZone3||0, z4=b.hrAnalysis.timeInZone4||0, z5=b.hrAnalysis.timeInZone5||0;
        tss = Math.round(z2*0.5 + z3*1.0 + z4*1.5 + z5*2.0);
        if(b.hrAnalysis.avgHR>=170) cns+=10;
        if(b.hrAnalysis.recovery==='poor') cns+=8;
      }else{
        // heuristic
        tss = Math.round((b.time||0)* (b.protocol==='zone5'||b.protocol==='peak-rpm'? 3 : b.protocol==='alternating'? 2 : 1));
      }

      // add interval premium
      tss += Math.round((b.intervals||0)*2);

      return {
        cnsScore: clamp(Math.round(cns),0,100),
        volume: 0,
        tss: clamp(tss, 10, 220)
      };
    }

    // BJJ: intensity + dehydration proxy + HR zones
    function calcBJJMetrics(d){
      let cns=40;
      const sweat = d.weightLoss||0;
      if(sweat>=4) cns+=18; else if(sweat>=3) cns+=10;
      if(d.intensity==='high') cns+=14;
      if(d.feeling==='beat') cns+=16; else if(d.feeling==='tired') cns+=10;
      if(d.sleep<7) cns+=8;

      if(d.hrAnalysis){
        const hr=d.hrAnalysis;
        if(hr.avgHR>=160) cns+=8;
        if(hr.timeInZone5>20) cns+=10;
      }
      // TSS proxy by time and intensity
      const tss = Math.round((d.time||0) * (d.intensity==='high'?1.6 : d.intensity==='medium'?1.2:0.8));
      return { cnsScore:clamp(cns,0,100), volume:0, tss: clamp(tss, 10, 200) };
    }

    // Walking: very low load; ensure Zone2 stays easy
    function calcWalkMetrics(d){
      let cns=10;
      if(d.terrain==='steep') cns+=12; else if(d.terrain==='hills') cns+=6;

      if(d.purpose==='zone2' && d.hrAnalysis){
        const hr=d.hrAnalysis;
        if((hr.timeInZone3||0) > (hr.timeInZone2||0)) cns+=8; // went too hard
      }
      const tss = Math.round((d.duration||0)*0.5);
      return { cnsScore:clamp(cns,0,100), volume:0, tss: clamp(tss, 0, 120) };
    }

    /* ===========================
       QUALITIES & INTERFERENCE
    ============================*/
    function analyzeQualities(mods){
      const q = { strength:0, hypertrophy:0, power:0, speed:0, endurance:0 };

      Object.entries(mods).forEach(([type,mod])=>{
        if(['chest','back','legs'].includes(type)){
          mod.exercises?.forEach(ex=>{
            ex.workingSets.forEach(s=>{
              if(s.reps<=5){ q.strength += s.reps * (s.rpe||8); }
              else if(s.reps<=8){ q.strength += s.reps*0.6*(s.rpe||8); q.hypertrophy += s.reps*0.4*(s.rpe||8); }
              else{ q.hypertrophy += s.reps*(s.rpe||8); }
            });
          });
        }else if(type==='track'){
          q.power += (mod.contacts||0)*0.7;
          // sprint lines contribute to speed more
          (mod.items||[]).forEach(it=>{
            if(it.subtype==='sprint') q.speed += it.contacts*0.5;
          });
        }else if(type==='bike'){
          q.endurance += (mod.tss||0);
          if(['zone5','peak-rpm'].includes(mod.protocol)) q.power += 40;
        }else if(type==='bjj'){
          q.endurance += (mod.time||0);
          if(mod.intensity==='high'){ q.power+=30; q.strength+=20; }
        }else if(type==='walking'){
          q.endurance += (mod.duration||0)*0.6;
        }
      });

      const total = Object.values(q).reduce((a,b)=>a+b,0) || 1;
      Object.keys(q).forEach(k=>{ q[k] = Math.round((q[k]/total)*100); });
      return q;
    }

    function detectInterference(mods, q){
      const issues=[];
      const types = Object.keys(mods);

      if(types.includes('legs') && types.includes('track')){
        issues.push({
          severity:'critical',
          message:'Legs + Track same day = fast-twitch overlap & tendon load',
          impact:'Power output ‚Üì ~15‚Äì20%, soft-tissue risk ‚Üë',
          fix:'Split by ‚â•48h or reduce one session volume by 30‚Äì40%'
        });
      }
      if(types.includes('bjj') && types.includes('back')){
        issues.push({
          severity:'moderate',
          message:'BJJ + Back same day = grip/lat fatigue compounded',
          impact:'Pulling strength ‚Üì ~10‚Äì15%',
          fix:'Use straps on pulls or separate by ‚â•24h'
        });
      }
      if(types.length>=4){
        issues.push({
          severity:'high',
          message:`${types.length} modalities in one day = extreme volume`,
          impact:'CNS overload; recovery compromised',
          fix:'Split across 2 days or cap to 3 modalities'
        });
      }
      return issues;
    }

    /* ===========================
       DAY & WEEK DISPLAYS
    ============================*/
    function displayDayAnalysis(dateStr, data){
      const list = Object.keys(data.modalities).map(t=>t.toUpperCase()).join(', ');
      let html = `
        <div class="modal"><div class="modal-content">
          <div class="modal-header">
            <div class="modal-title">‚úì Training Saved ‚Äî ${dateStr}</div>
            <button class="close-btn" onclick="closeModal()">‚úï Close</button>
          </div>

          <div class="success">
            <div><span class="badge">Modalities</span> ${list}</div>
          </div>

          <div class="metric-grid">
            <div class="metric"><div class="v">${data.totalCNS}</div><div class="badge">Total CNS Load</div></div>
            <div class="metric"><div class="v">${(data.totalVolume||0).toLocaleString()}</div><div class="badge">Total Volume (lbs)</div></div>
            <div class="metric"><div class="v">${data.tss}</div><div class="badge">Training Stress Score (proxy)</div></div>
          </div>

          <div class="info">
            <h3 style="color:var(--ok2);margin-bottom:8px">Training Qualities</h3>
            ${Object.entries(data.qualities).map(([k,v])=>`<div>${cap(k)}: <strong>${v}%</strong></div>`).join('')}
          </div>
      `;
      if(data.interference?.length){
        html += `<div class="warning"><h3>‚ö†Ô∏è Interference Detected</h3>${
          data.interference.map(it=>`
            <div style="margin-top:8px">
              <div><strong>${it.message}</strong></div>
              <div style="color:#ff8a8a">Impact: ${it.impact}</div>
              <div style="color:#7bffb4">Fix: ${it.fix}</div>
            </div>`).join('')
        }</div>`;
      }
      html += `</div></div>`;
      el('day-modal').innerHTML = html;
      el('day-modal').classList.remove('hidden');
    }

    function showWeeklyAnalysis(){
      const end = new Date();
      const start = new Date(); start.setDate(start.getDate()-6);

      let totalCNS=0,totalVol=0,totalTSS=0,days=0;
      const dailyCNS=[], dailyTSS=[];
      for(let d=new Date(start); d<=end; d.setDate(d.getDate()+1)){
        const ds = fmtDate(d);
        const day = trainingData[ds];
        if(day && Object.keys(day.modalities||{}).length){
          days++; totalCNS+=day.totalCNS||0; totalVol+=day.totalVolume||0; totalTSS+=day.tss||0;
          dailyCNS.push(day.totalCNS||0); dailyTSS.push(day.tss||0);
        }
      }
      const avgCNS = days? Math.round(totalCNS/days):0;
      const avgTSS = days? Math.round(totalTSS/days):0;

      // Monotony & Strain
      const mean = avgCNS;
      const variance = dailyCNS.reduce((s,v)=>s+Math.pow(v-mean,2),0)/(dailyCNS.length||1);
      const std = Math.sqrt(variance);
      const monotony = std>0 ? (mean/std) : 0;
      const strain = Math.round(totalCNS * monotony);

      // Acute:Chronic using last 28 days TSS
      const last28 = historicalTSS.slice(-28);
      let acRatio='‚Äî', acWarn=false;
      if(last28.length>=14){
        const chronic = last28.reduce((s,a)=>s+(a.tss||0),0)/last28.length;
        if(chronic>0){ acRatio = ((avgTSS*7)/chronic).toFixed(2); acWarn = (+acRatio>1.30); }
      }

      const html = `
        <div class="modal"><div class="modal-content">
          <div class="modal-header">
            <div class="modal-title">üìä Weekly Analysis</div>
            <button class="close-btn" onclick="closeModal()">‚úï Close</button>
          </div>

          <div class="subtitle">${start.toLocaleDateString()} ‚Äî ${end.toLocaleDateString()}</div>
          <div class="metric-grid">
            <div class="metric" style="border-left-color:var(--ok)"><div class="v">${(totalVol||0).toLocaleString()}</div><div class="badge">Total Volume (lbs)</div></div>
            <div class="metric" style="border-left-color:var(--ok2)"><div class="v">${avgCNS}</div><div class="badge">Avg Daily CNS</div></div>
            <div class="metric" style="border-left-color:#ffaa00"><div class="v">${totalTSS}</div><div class="badge">Weekly TSS</div></div>
            <div class="metric" style="border-left-color:${acWarn?'var(--bad)':'#ff6b35'}">
              <div class="v" style="color:${acWarn?'var(--bad)':'var(--ok)'}">${acRatio}</div>
              <div class="badge">Acute:Chronic</div>
            </div>
            <div class="metric" style="border-left-color:#8a2be2"><div class="v">${monotony.toFixed(2)}</div><div class="badge">Monotony</div></div>
            <div class="metric" style="border-left-color:#ff69b4"><div class="v">${strain}</div><div class="badge">Strain</div></div>
          </div>

          ${acWarn ? `
            <div class="warning">
              <h3>Injury Risk Warning</h3>
              <div>Acute:Chronic = <strong>${acRatio}</strong> (optimal 0.8‚Äì1.3)</div>
              <div>Recommendation: reduce next week volume 15‚Äì20%, add 1‚Äì2 recovery days, ensure sleep ‚â•8h.</div>
            </div>
          `:`
            <div class="success">
              <h3>Load In Range</h3>
              <div>Acute:Chronic ${acRatio}. Continue current approach; keep monitoring recovery & HR trends.</div>
            </div>
          `}
        </div></div>
      `;
      el('weekly-modal').innerHTML = html;
      el('weekly-modal').classList.remove('hidden');
    }

    /* ===========================
       RPE GUIDE
    ============================*/
    function showRPEGuide(){
      const html = `
        <div class="modal" onclick="if(event.target===this) closeRPEGuide()">
          <div class="modal-content">
            <div class="modal-header">
              <div class="modal-title">RPE Reference Guide</div>
              <button class="close-btn" onclick="closeRPEGuide()">‚úï Close</button>
            </div>
            ${[
              [10,'0 RIR','Absolute failure ‚Äî no reps left'],
              [9.5,'0‚Äì1 RIR','Maybe 1 more'],
              [9,'1 RIR','Almost failure; 1 left'],
              [8.5,'1‚Äì2 RIR','Maybe 2 left'],
              [8,'2 RIR','Optimal hypertrophy'],
              [7.5,'2‚Äì3 RIR','Comfortably hard'],
              [7,'3 RIR','Moderate difficulty'],
              [6,'4+ RIR','Speed intact']
            ].map(([n,rir,desc])=>`
              <div style="display:grid;grid-template-columns:80px 120px 1fr;gap:12px;background:#0b0b0b;border:1px solid #222;border-radius:8px;padding:10px;margin:6px 0">
                <div style="font-weight:900;color:var(--ok);font-size:24px">${n}</div>
                <div style="color:var(--ok2);font-weight:800">${rir}</div>
                <div style="color:#bbb">${desc}</div>
              </div>
            `).join('')}
          </div>
        </div>`;
      el('rpe-modal').innerHTML = html;
      el('rpe-modal').classList.remove('hidden');
    }
    function closeRPEGuide(){ el('rpe-modal').classList.add('hidden'); }

    function closeModal(){
      el('day-modal').classList.add('hidden');
      el('weekly-modal').classList.add('hidden');
      hrData = {};
    }

    /* ===========================
       HELPERS
    ============================*/
    function el(id){ return document.getElementById(id); }
    function idv(id){ const n=el(id); return n? n.value:''; }
    function val(root, sel){ const n=root.querySelector(sel); return n? n.value.trim():''; }
    function num(v){ const x = parseFloat(v); return isNaN(x)?0:x; }
    function esc(s){ return (s||'').replace(/["<>&]/g, m=>({'"':'&quot;','<':'&lt;','>':'&gt;','&':'&amp;'}[m])); }
    function clamp(x,a,b){ return Math.max(a, Math.min(b, x)); }
    function cap(s){ return s.charAt(0).toUpperCase()+s.slice(1); }
    function opt(val,label,sel){ return `<option value="${val}" ${sel?'selected':''}>${label}</option>`; }

    /* ===========================
       INIT
    ============================*/
    window.onload = function(){
      loadData();
      renderCalendar();
    };
  </script>
</body>
</html>
<!-- Primary probability of correctness: 0.86 | Auxiliary temperature (uncertainty): 0.18 -->
